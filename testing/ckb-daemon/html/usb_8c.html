<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>ckb-next: src/ckb-daemon/usb.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ckb-128.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">ckb-next
   &#160;<span id="projectnumber">beta-v0.2.8 at branch testing</span>
   </div>
   <div id="projectbrief">ckb-next driver for corsair devices</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('usb_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">usb.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="command_8h_source.html">command.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="device_8h_source.html">device.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="devnode_8h_source.html">devnode.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="firmware_8h_source.html">firmware.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="input_8h_source.html">input.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="led_8h_source.html">led.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="notify_8h_source.html">notify.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="profile_8h_source.html">profile.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="usb_8h_source.html">usb.h</a>&quot;</code><br/>
</div><div class="textblock"><div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Include dependency graph for usb.c:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c__incl.png" border="0" usemap="#src_2ckb-daemon_2usb_8c" alt=""/></div>
<map name="src_2ckb-daemon_2usb_8c" id="src_2ckb-daemon_2usb_8c">
<area shape="rect" id="node2" href="command_8h.html" title="command.h" alt="" coords="776,155,867,181"/><area shape="rect" id="node27" href="device_8h.html" title="device.h" alt="" coords="580,155,650,181"/><area shape="rect" id="node28" href="devnode_8h.html" title="devnode.h" alt="" coords="946,80,1027,107"/><area shape="rect" id="node29" href="usb_8h.html" title="Definitions for using USB interface. " alt="" coords="1049,155,1103,181"/><area shape="rect" id="node30" href="firmware_8h.html" title="firmware.h" alt="" coords="891,155,972,181"/><area shape="rect" id="node31" href="input_8h.html" title="input.h" alt="" coords="1103,80,1164,107"/><area shape="rect" id="node32" href="led_8h.html" title="led.h" alt="" coords="746,80,796,107"/><area shape="rect" id="node33" href="notify_8h.html" title="notify.h" alt="" coords="512,80,576,107"/><area shape="rect" id="node34" href="profile_8h.html" title="profile.h" alt="" coords="653,80,720,107"/><area shape="rect" id="node3" href="includes_8h.html" title="includes.h" alt="" coords="781,229,862,256"/><area shape="rect" id="node4" href="os_8h.html" title="os.h" alt="" coords="1412,528,1458,555"/><area shape="rect" id="node24" href="structures_8h.html" title="structures.h" alt="" coords="1426,304,1516,331"/><area shape="rect" id="node25" href="keymap_8h.html" title="keymap.h" alt="" coords="1437,379,1515,405"/><area shape="rect" id="node26" href="keymap__mac_8h.html" title="keymap_mac.h" alt="" coords="1426,453,1536,480"/></map>
</div>
</div>
<p><a href="usb_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a8e6389e8183a834fedb6ed317dd26f94"><td class="memItemLeft" align="right" valign="top">const char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a8e6389e8183a834fedb6ed317dd26f94">vendor_str</a> (short vendor)</td></tr>
<tr class="memdesc:a8e6389e8183a834fedb6ed317dd26f94"><td class="mdescLeft">&#160;</td><td class="mdescRight">brief .  <a href="#a8e6389e8183a834fedb6ed317dd26f94">More...</a><br/></td></tr>
<tr class="separator:a8e6389e8183a834fedb6ed317dd26f94"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af87f830e031d8f63d2d1c3fc14fdad20"><td class="memItemLeft" align="right" valign="top">const char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#af87f830e031d8f63d2d1c3fc14fdad20">product_str</a> (short product)</td></tr>
<tr class="memdesc:af87f830e031d8f63d2d1c3fc14fdad20"><td class="mdescLeft">&#160;</td><td class="mdescRight">brief .  <a href="#af87f830e031d8f63d2d1c3fc14fdad20">More...</a><br/></td></tr>
<tr class="separator:af87f830e031d8f63d2d1c3fc14fdad20"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a25ded61622ec9349905b5aa2ed2cb48b"><td class="memItemLeft" align="right" valign="top">static const <a class="el" href="command_8h.html#uniondevcmd">devcmd</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a25ded61622ec9349905b5aa2ed2cb48b">get_vtable</a> (short vendor, short product)</td></tr>
<tr class="memdesc:a25ded61622ec9349905b5aa2ed2cb48b"><td class="mdescLeft">&#160;</td><td class="mdescRight">brief .  <a href="#a25ded61622ec9349905b5aa2ed2cb48b">More...</a><br/></td></tr>
<tr class="separator:a25ded61622ec9349905b5aa2ed2cb48b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab8c22b4f7012c6d9fe1a0d5e2a93df65"><td class="memItemLeft" align="right" valign="top">static void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65">devmain</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb)</td></tr>
<tr class="memdesc:ab8c22b4f7012c6d9fe1a0d5e2a93df65"><td class="mdescLeft">&#160;</td><td class="mdescRight">brief .  <a href="#ab8c22b4f7012c6d9fe1a0d5e2a93df65">More...</a><br/></td></tr>
<tr class="separator:ab8c22b4f7012c6d9fe1a0d5e2a93df65"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a10ad381abfe51e67e341c882c92bb9ac"><td class="memItemLeft" align="right" valign="top">static void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac">_setupusb</a> (void *context)</td></tr>
<tr class="memdesc:a10ad381abfe51e67e341c882c92bb9ac"><td class="mdescLeft">&#160;</td><td class="mdescRight">brief .  <a href="#a10ad381abfe51e67e341c882c92bb9ac">More...</a><br/></td></tr>
<tr class="separator:a10ad381abfe51e67e341c882c92bb9ac"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1ab9d61dd894466125283465201161cd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a1ab9d61dd894466125283465201161cd">setupusb</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb)</td></tr>
<tr class="separator:a1ab9d61dd894466125283465201161cd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae30a52968bb209e98461f48ffb2ee82f"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#ae30a52968bb209e98461f48ffb2ee82f">revertusb</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb)</td></tr>
<tr class="separator:ae30a52968bb209e98461f48ffb2ee82f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9ea008b77417f82b177117dce9a50b48"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a9ea008b77417f82b177117dce9a50b48">_resetusb</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb, const char *file, int line)</td></tr>
<tr class="separator:a9ea008b77417f82b177117dce9a50b48"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8a1c88df5e127732cb63f1a8be180926"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926">usb_tryreset</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb)</td></tr>
<tr class="separator:a8a1c88df5e127732cb63f1a8be180926"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a992cce1d173047466101113bfff5d7a1"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a992cce1d173047466101113bfff5d7a1">_usbsend</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb, const <a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *messages, int count, const char *file, int line)</td></tr>
<tr class="separator:a992cce1d173047466101113bfff5d7a1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5a548f93d4c1c56910b840cebe88d0c2"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a5a548f93d4c1c56910b840cebe88d0c2">_usbrecv</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb, const <a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *out_msg, <a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *in_msg, const char *file, int line)</td></tr>
<tr class="separator:a5a548f93d4c1c56910b840cebe88d0c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8732b3ade76da4ae362996232ef95431"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431">closeusb</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb)</td></tr>
<tr class="separator:a8732b3ade76da4ae362996232ef95431"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a0fa74a6fe0d2796e2d2dbf8447b9e5e4"><td class="memItemLeft" align="right" valign="top">pthread_mutex_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a0fa74a6fe0d2796e2d2dbf8447b9e5e4">usbmutex</a> = PTHREAD_MUTEX_INITIALIZER</td></tr>
<tr class="memdesc:a0fa74a6fe0d2796e2d2dbf8447b9e5e4"><td class="mdescLeft">&#160;</td><td class="mdescRight">brief .  <a href="#a0fa74a6fe0d2796e2d2dbf8447b9e5e4">More...</a><br/></td></tr>
<tr class="separator:a0fa74a6fe0d2796e2d2dbf8447b9e5e4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acfc08dcd9203a7489c1c43362e2ff138"><td class="memItemLeft" align="right" valign="top">volatile int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#acfc08dcd9203a7489c1c43362e2ff138">reset_stop</a> = 0</td></tr>
<tr class="memdesc:acfc08dcd9203a7489c1c43362e2ff138"><td class="mdescLeft">&#160;</td><td class="mdescRight">brief .  <a href="#acfc08dcd9203a7489c1c43362e2ff138">More...</a><br/></td></tr>
<tr class="separator:acfc08dcd9203a7489c1c43362e2ff138"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a234c8042548e4208f82fc7f89472e14e"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a234c8042548e4208f82fc7f89472e14e">features_mask</a> = -1</td></tr>
<tr class="memdesc:a234c8042548e4208f82fc7f89472e14e"><td class="mdescLeft">&#160;</td><td class="mdescRight">brief .  <a href="#a234c8042548e4208f82fc7f89472e14e">More...</a><br/></td></tr>
<tr class="separator:a234c8042548e4208f82fc7f89472e14e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a94d4a8df060c5f77d94f3656fefe6c32"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb_8c.html#a94d4a8df060c5f77d94f3656fefe6c32">hwload_mode</a></td></tr>
<tr class="memdesc:a94d4a8df060c5f77d94f3656fefe6c32"><td class="mdescLeft">&#160;</td><td class="mdescRight">hwload_mode is defined in <a class="el" href="device_8c.html">device.c</a>  <a href="#a94d4a8df060c5f77d94f3656fefe6c32">More...</a><br/></td></tr>
<tr class="separator:a94d4a8df060c5f77d94f3656fefe6c32"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a9ea008b77417f82b177117dce9a50b48"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int _resetusb </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>line</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>_resetusb Reset a USB device.</p>
<p>First reset the device via <a class="el" href="usb_8h.html#a0fd9533617cdae390dc65aa4594e33d2" title="os_resetusb is the os specific implementation for resetting usb ">os_resetusb()</a> after a long delay (it may send something to the host). If this worked (retval == 0), give the device another long delay Then perform the initialization via the device specific start() function entry in kb-&gt;vtable and if this is successful also, return the result of the device depenten updatergb() with force=true. </p>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00426">426</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="structures_8h_source.html#l00231">usbdevice::active</a>, <a class="el" href="usb_8h_source.html#l00155">DELAY_LONG</a>, <a class="el" href="usb__linux_8c_source.html#l00497">os_resetusb()</a>, and <a class="el" href="structures_8h_source.html#l00180">usbdevice::vtable</a>.</p>
<div class="fragment"><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                                                        {</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="comment">// Perform a USB reset</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <a class="code" href="usb_8h.html#a8de6458e3d59d88350ef3e73359c3526">DELAY_LONG</a>(kb);</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="keywordtype">int</span> res = <a class="code" href="usb_8h.html#a0fd9533617cdae390dc65aa4594e33d2">os_resetusb</a>(kb, file, line);</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="keywordflow">if</span>(res)</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        <span class="keywordflow">return</span> res;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <a class="code" href="usb_8h.html#a8de6458e3d59d88350ef3e73359c3526">DELAY_LONG</a>(kb);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    <span class="comment">// Re-initialize the device</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="keywordflow">if</span>(kb-&gt;<a class="code" href="structures_8h.html#a3ad960bd68547aca1f870fac1138023b">vtable</a>-&gt;start(kb, kb-&gt;<a class="code" href="structures_8h.html#a8889b6a5d3ce83427377e3a3de947f03">active</a>) != 0)</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    <span class="keywordflow">if</span>(kb-&gt;<a class="code" href="structures_8h.html#a3ad960bd68547aca1f870fac1138023b">vtable</a>-&gt;updatergb(kb, 1) != 0)</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;}</div>
<div class="ttc" id="usb_8h_html_a8de6458e3d59d88350ef3e73359c3526"><div class="ttname"><a href="usb_8h.html#a8de6458e3d59d88350ef3e73359c3526">DELAY_LONG</a></div><div class="ttdeci">#define DELAY_LONG(kb)</div><div class="ttdoc">The longest delay takes place where something went wrong (eg when resetting the device) ...</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00155">usb.h:155</a></div></div>
<div class="ttc" id="usb_8h_html_a0fd9533617cdae390dc65aa4594e33d2"><div class="ttname"><a href="usb_8h.html#a0fd9533617cdae390dc65aa4594e33d2">os_resetusb</a></div><div class="ttdeci">int os_resetusb(usbdevice *kb, const char *file, int line)</div><div class="ttdoc">os_resetusb is the os specific implementation for resetting usb </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00497">usb_linux.c:497</a></div></div>
<div class="ttc" id="structures_8h_html_a8889b6a5d3ce83427377e3a3de947f03"><div class="ttname"><a href="structures_8h.html#a8889b6a5d3ce83427377e3a3de947f03">usbdevice::active</a></div><div class="ttdeci">char active</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00231">structures.h:231</a></div></div>
<div class="ttc" id="structures_8h_html_a3ad960bd68547aca1f870fac1138023b"><div class="ttname"><a href="structures_8h.html#a3ad960bd68547aca1f870fac1138023b">usbdevice::vtable</a></div><div class="ttdeci">const union devcmd * vtable</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00180">structures.h:180</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-1" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-1-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-1-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-1-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a9ea008b77417f82b177117dce9a50b48_cgraph.png" border="0" usemap="#usb_8c_a9ea008b77417f82b177117dce9a50b48_cgraph" alt=""/></div>
<map name="usb_8c_a9ea008b77417f82b177117dce9a50b48_cgraph" id="usb_8c_a9ea008b77417f82b177117dce9a50b48_cgraph">
<area shape="rect" id="node2" href="usb_8h.html#a0fd9533617cdae390dc65aa4594e33d2" title="os_resetusb is the os specific implementation for resetting usb " alt="" coords="133,31,227,57"/><area shape="rect" id="node3" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="275,5,363,32"/><area shape="rect" id="node4" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626" title="usbclaim" alt="" coords="281,56,356,83"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a10ad381abfe51e67e341c882c92bb9ac"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void* _setupusb </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>context</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>_setupusb A horrible function for setting up an usb device </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">context</td><td>As <a class="el" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . ">_setupusb()</a> is called as a new thread, the kb* is transferred as void* </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>a ptread_t* 0, here casted as void*. Retval is always null</dd></dl>
<p>The basic structure of the function is somewhat habituated. It is more like an assembler routine than a structured program. This is not really bad, but just getting used to.</p>
<p>After every action, which can be practically fault-prone, the routine goes into the same error handling: It goes via goto to one of two exit labels. The difference is whether or not an unlock has to be performed on the imutex variable. In both cases, <a class="el" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431">closeusb()</a> is called, then an unlock is performed on the dmutex.</p>
<p>The only case where this error handling is not performed is the correct return of the call to <a class="el" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . ">devmain()</a>. Here simply the return value of <a class="el" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . ">devmain()</a> is passed to the caller.</p>
<p>In either case, the routine terminates with a void* 0 because either <a class="el" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . ">devmain()</a> has returned constant null or the routine itself returns zero.</p>
<p>The basic idea of this routine is the following: </p>
<p><br/>
 First some initialization of kb standard structured and local vars is done.</p>
<ul>
<li><b>kb</b> is set to the pointer given from start environment</li>
<li>local vars <b>vendor</b> and <b>product</b> are set to the values from the corresponding fields of kb</li>
<li>local var <b>vt</b> <b>and</b> the <b>kb-&gt;vtable</b> are both set to the retval of <em><a class="el" href="usb_8c.html#a25ded61622ec9349905b5aa2ed2cb48b" title="brief . ">get_vtable()</a></em> </li>
<li><b>kb-&gt;features</b> are set depending on the type of hardware connected:<ul>
<li>set either to standard non rgb (all common flags like binding, notify, FW, hardware-loading etc) or in case of RGB-device set to standard + RGB, pollrate-change and fw-update</li>
<li>exclude all features which are disabled via feature_mask (set by daemon CLI parameters)</li>
<li>if it is a mouse, add adjust-rate</li>
<li>if it is a monochrome device, set the flag for RGB-protocol, but single color</li>
</ul>
</li>
<li>the standard delay time is initialized in kb-&gt;usbdelay</li>
<li>A fixed 100ms wait is the start. <b>Although the DELAY_LONG macro is given a parameter, it is ignored. Occasionally refactor it.</b></li>
<li>The first relevant point is the operating system-specific opening of the interface in <a class="el" href="usb_8h.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb OS-specific setup for a specific usb device. ">os_setupusb()</a>. As a result, some parameters should be set in kb (name, serial, fwversion, epcount = number of usb endpoints), and all endpoints should be claimed with <a class="el" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626">usbclaim()</a>. Claiming is the only point where <a class="el" href="usb_8h.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb OS-specific setup for a specific usb device. ">os_setupusb()</a> can produce an error (-1, otherwise 0).</li>
<li>The following two statements deal with possible errors when setting the kb values in the current routine: If the version or the name was not read correctly, they are set to default values:<ul>
<li>serial is set to "&lt;vendor&gt;: &lt;product&gt; -NoID"</li>
<li>the name is set to "&lt;vendor&gt; &lt;product&gt;".</li>
</ul>
</li>
<li>Then the user level input subsystem is activated via os_openinput(). There are two file descriptors, one for the mouse and one for the keyboard. <b>As mentioned in <a class="el" href="structures_8h.html">structures.h</a>, not the just opened FD numbers are stored under kb-&gt;uinput_kb or kb-&gt;uinput_mouse, but the values increased by 1!</b> The reason is, if the open fails or not open has been done until now, that struct member is set to 0, not to -1 or other negative value. So all usage of this kb-&gt;handle must be something like <code>"kb-&gt;handle - 1"</code>, as you can find it in the code.</li>
<li>The next action is to create a separate thread, which gets as parameter kb and starts with <a class="el" href="usb_8h.html#a9e5784bfca2e4612f498ce67c7dab275" title="os_inputmain is run in a separate thread and will be detached from the main thread, so it needs to clean up its own resources. ">os_inputmain()</a>. The thread is immediately detached so that it can return its resource completely independently if it should terminate.</li>
<li>The same happens with <a class="el" href="input_8h.html#a081bbacaa312d4a1a63bc1cab5d3520f">os_setupindicators()</a>, which initially initializes all LED variables in kb to off and then starts the <a class="el" href="input__linux_8c.html#a5d40cc9137eaefbc2d860fac76020460">_ledthread()</a> thread with kb as parameter and then detaches it. Here again only the generation of the thread can fail.</li>
<li>Via an entry in the vable (allocprofile, identical for all three vtable types), <a class="el" href="profile_8c.html#a1ac05e939e8a6fd0c0c1acf57b80c522">allocprofile()</a> is called in <a class="el" href="profile_8c.html">profile.c</a>. With a valid parameter kb, a usbprofile structure is allocated and stored as a kb-&gt;profile. Then <a class="el" href="profile_8c.html#a6b867722051cfb395d86745e20722ec9">initmode()</a> is called for each of the initializable modes (MODE_COUNT, currently 6). This procedure creates the memory space for the mode information, initializes the range to 0, and then sets the light.forceupdate and dpi.forceupdate to true. This forces an update later in the initialization of the device. <br/>
 The first mode is set as the current mode and two force flags are set (this seems to be mode-intersecting flags for light and update). <dl class="section warning"><dt>Warning</dt><dd>There is no error handling for the <a class="el" href="profile_8c.html#a1ac05e939e8a6fd0c0c1acf57b80c522">allocprofile()</a> and <a class="el" href="profile_8c.html#a6b867722051cfb395d86745e20722ec9">initmode()</a> procedures. However, since they allocate storage areas, the subsequent assignments and initializations can run in a SEGV.</dd></dl>
</li>
<li>Not completely understandable is why now via the vtable the function updateindicators() is called. But this actually happens in the just started thread <a class="el" href="input__linux_8c.html#a5d40cc9137eaefbc2d860fac76020460">_ledthread()</a>. Either the initialization is wrong und must done here with force or the overview is lost, what happens when...<br/>
Regardless: For a mouse nothing happens here, for a keyboard <a class="el" href="input_8c.html#a1126a054e3319ba8cbd74bfbd39099eb">updateindicators_kb()</a> is called via the entry in kb-&gt;vtable. The first parameter is kb again, the second is constant 1 (means force = true). This causes the LED status to be sent after a 5ms delay via <a class="el" href="usb_8h.html#afa51c505c8f442f49ea2d712c61faea2" title="os_sendindicators update the indicators for the special keys (Numlock, Capslock and what else...">os_sendindicators()</a> (ioctl with a <code>usbdevfs_ctrltransfer</code>). <br/>
 The notification is sent to all currently open notification channels then. <br/>
 Setupindicators() and with it <a class="el" href="input_8c.html#a1126a054e3319ba8cbd74bfbd39099eb">updateindicators_kb()</a> can fail.</li>
<li>From this point - if an error is detected - the error label is addressed by goto statement, which first performs an unlock on the imutex. This is interesting because the next statement is exactly this: An unlock on the imutex.</li>
<li>Via vtable the <em>kb-&gt;start()</em> function is called next. This is the same for a mouse and an RGB keyboard: <a class="el" href="device_8c.html#aa622e430e7f7c7236cfd60fd123e0e1c">start_dev()</a>, for a non RGB keyboard it is <a class="el" href="device_8h.html#a10d93d82f722b0ade898a6515f312dc2">start_kb_nrgb()</a>. <br/>
 First parameter is as always kb, second is 0 (makeactive = false).<ul>
<li>In <a class="el" href="device_8h.html#a10d93d82f722b0ade898a6515f312dc2">start_kb_nrgb()</a> set the keyboard into a so-called software mode (NK95_HWOFF) via ioctl with <code>usbdevfs_ctrltransfer</code> in function <a class="el" href="usb_8h.html#a3da2cab9cd88ea517d39888fe2159734" title="_nk95cmd If we control a non RGB keyboard, set the keyboard via ioctl with usbdevfs_ctrltransfer ...">_nk95cmd()</a>, which will in turn is called via macro <a class="el" href="usb_8h.html#aefc95e6120686dff0e06bba32ca21ad1" title="nk95cmd() macro is used to wrap _nk95cmd() with debugging information (file and lineno). the command structure is different:   Just the bits 23..16 are used as bits 7..0 for bRequest   Bits 15..0 are used as wValue ">nk95cmd()</a> via <a class="el" href="device_8h.html#a10d93d82f722b0ade898a6515f312dc2">start_kb_nrgb()</a>. <br/>
 Then two dummy values (active and pollrate) are set in the kb structure and ready.</li>
<li><a class="el" href="device_8c.html#aa622e430e7f7c7236cfd60fd123e0e1c">start_dev()</a> does a bit more - because this function is for both mouse and keyboard. <a class="el" href="device_8c.html#aa622e430e7f7c7236cfd60fd123e0e1c">start_dev()</a> calls - after setting an extended timeout parameter - <a class="el" href="device_8c.html#a96ee4de97d66a995084757151f4ed150">_start_dev()</a>. Both are located in <a class="el" href="device_8c.html">device.c</a>.</li>
<li>First, <a class="el" href="device_8c.html#a96ee4de97d66a995084757151f4ed150">_start_dev()</a> attempts to determine the firmware version of the device, but only if two conditions are met: hwload-mode is not null (then hw-loading is disabled) and the device has the FEAT_HWLOAD feature. Then the firmware and the poll rate are fetched via <a class="el" href="firmware_8c.html#a3a6f1b57ca13dc54b046616963b299fa">getfwversion()</a>. <br/>
 If hwload_mode is set to "load only once" (==1), then the HWLOAD feature is masked, so that no further reading can take place.</li>
<li>Now check if device needs a firmware update. If so, set it up and leave the function without error.</li>
<li>Else load the hardware profile from device if the hw-pointer is not set and hw-loading is possible and allowed. <br/>
 Return error if mode == 2 (load always) and loading got an error. Else mask the HWLOAD feature, because hwload must be 1 and the error couold be a repeated hw-reading. <br/>
 <b>Puh, that is real Horror code. It seems to be not faulty, but completely unreadable.</b></li>
<li>Finally, the second parameter of _startdev() is used to check whether the device is to be activated. Depending on the parameter, the active or the idle-member in the correspondig vtable is called. These are device-dependent again: <table class="doxtable">
<tr>
<th>Device </th><th>active </th><th>idle  </th></tr>
<tr>
<td>RGB Keyboard </td><td><a class="el" href="device_8h.html#ac520b855af37b199562c5d6e2d4b8c80">cmd_active_kb()</a> means: start the device with a lot of kb-specific initializers (software controlled mode) </td><td><a class="el" href="device_8h.html#ae904b92525c5e59de06c92a95120bdeb">cmd_idle_kb()</a> set the device with a lot of kb-specific initializers into the hardware controlled mode) </td></tr>
<tr>
<td>non RGB Keyboard </td><td><a class="el" href="device__vtable_8c.html#a4f4b1f1e915ce582fe1cb90efa228dfd">cmd_io_none()</a> means: Do nothing </td><td><a class="el" href="device__vtable_8c.html#a4f4b1f1e915ce582fe1cb90efa228dfd">cmd_io_none()</a> means: Do nothing </td></tr>
<tr>
<td>Mouse </td><td><a class="el" href="device_8h.html#a645921c6fa6d8c1c2f3db338113fac51">cmd_active_mouse()</a> similar to <a class="el" href="device_8h.html#ac520b855af37b199562c5d6e2d4b8c80">cmd_active_kb()</a> </td><td>cmd_idle_mouse similar to <a class="el" href="device_8h.html#ae904b92525c5e59de06c92a95120bdeb">cmd_idle_kb()</a> </td></tr>
</table>
</li>
</ul>
</li>
<li>If either <em>start()</em> succeeded or the next following <a class="el" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926">usb_tryreset()</a>, it goes on, otherwise again a hard abort occurs.</li>
<li>Next, go to <a class="el" href="devnode_8c.html#a0c3d1e3cd90f43a9b5ee0793f4a75041" title="Create a dev path for the keyboard at index. Returns 0 on success. ">mkdevpath()</a>. After securing the EUID (effective UID) especially for macOS, work starts really in <a class="el" href="devnode_8c.html#a81c81014b2dfa89e326dd61769842953">_mkdevpath()</a>. Create - no matter how many devices were registered - either the ckb0/ files <b>version</b>, <b>pid</b> and <b>connected</b> or the <b>cmd</b> command fifo, the first notification fifo <b>notify0</b>, <b>model</b> and <b>serial</b> as well as the <b>features</b> of the device and the <b>pollrate</b>.</li>
<li>If all this is done and no error has occurred, a debug info is printed ("Setup finished for ckbx") <a class="el" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. ">updateconnected()</a> writes the new device into the text file under ckb0/ and <a class="el" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . ">devmain()</a> is called.</li>
</ul>
<p><a class="el" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . ">devmain()</a>'s return value is returned by <a class="el" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . ">_setupusb()</a> when we terminate.</p>
<ul>
<li>The remaining code lines are the two exit labels as described above </li>
</ul>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00214">214</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00055">ckb_info</a>, <a class="el" href="usb_8c_source.html#l00677">closeusb()</a>, <a class="el" href="usb_8h_source.html#l00155">DELAY_LONG</a>, <a class="el" href="usb_8c_source.html#l00135">devmain()</a>, <a class="el" href="devnode_8c_source.html#l00011">devpath</a>, <a class="el" href="device_8h_source.html#l00018">dmutex</a>, <a class="el" href="structures_8h_source.html#l00139">FEAT_ADJRATE</a>, <a class="el" href="structures_8h_source.html#l00137">FEAT_MONOCHROME</a>, <a class="el" href="structures_8h_source.html#l00153">FEAT_STD_NRGB</a>, <a class="el" href="structures_8h_source.html#l00152">FEAT_STD_RGB</a>, <a class="el" href="structures_8h_source.html#l00229">usbdevice::features</a>, <a class="el" href="usb_8c_source.html#l00035">features_mask</a>, <a class="el" href="usb_8c_source.html#l00102">get_vtable()</a>, <a class="el" href="device_8h_source.html#l00022">imutex</a>, <a class="el" href="includes_8h_source.html#l00027">INDEX_OF</a>, <a class="el" href="structures_8h_source.html#l00219">usbdevice::inputthread</a>, <a class="el" href="usb_8h_source.html#l00129">IS_MONOCHROME</a>, <a class="el" href="usb_8h_source.html#l00141">IS_MOUSE</a>, <a class="el" href="usb_8h_source.html#l00124">IS_RGB</a>, <a class="el" href="structures_8h_source.html#l00174">KB_NAME_LEN</a>, <a class="el" href="device_8c_source.html#l00010">keyboard</a>, <a class="el" href="devnode_8c_source.html#l00268">mkdevpath()</a>, <a class="el" href="structures_8h_source.html#l00233">usbdevice::name</a>, <a class="el" href="usb__linux_8c_source.html#l00238">os_inputmain()</a>, <a class="el" href="input__linux_8c_source.html#l00055">os_inputopen()</a>, <a class="el" href="input__linux_8c_source.html#l00189">os_setupindicators()</a>, <a class="el" href="usb__linux_8c_source.html#l00535">os_setupusb()</a>, <a class="el" href="structures_8h_source.html#l00237">usbdevice::product</a>, <a class="el" href="usb_8c_source.html#l00070">product_str()</a>, <a class="el" href="structures_8h_source.html#l00235">usbdevice::serial</a>, <a class="el" href="structures_8h_source.html#l00175">SERIAL_LEN</a>, <a class="el" href="devnode_8c_source.html#l00081">updateconnected()</a>, <a class="el" href="usb_8h_source.html#l00160">USB_DELAY_DEFAULT</a>, <a class="el" href="usb_8c_source.html#l00465">usb_tryreset()</a>, <a class="el" href="structures_8h_source.html#l00243">usbdevice::usbdelay</a>, <a class="el" href="structures_8h_source.html#l00237">usbdevice::vendor</a>, <a class="el" href="usb_8c_source.html#l00043">vendor_str()</a>, and <a class="el" href="structures_8h_source.html#l00180">usbdevice::vtable</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00386">setupusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                                     {</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <a class="code" href="structures_8h.html#structusbdevice">usbdevice</a>* kb = context;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="comment">// Set standard fields</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordtype">short</span> vendor = kb-&gt;<a class="code" href="structures_8h.html#a2fa713366249e2fdbb2539e5d65a1439">vendor</a>, product = kb-&gt;<a class="code" href="structures_8h.html#a045b6c91e3f04e54f25d39da9bda105b">product</a>;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keyword">const</span> <a class="code" href="command_8h.html#uniondevcmd">devcmd</a>* vt = kb-&gt;<a class="code" href="structures_8h.html#a3ad960bd68547aca1f870fac1138023b">vtable</a> = <a class="code" href="usb_8c.html#a25ded61622ec9349905b5aa2ed2cb48b">get_vtable</a>(vendor, product);</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    kb-&gt;<a class="code" href="structures_8h.html#abbffdd889fd9a15c8796a47cabd3abd9">features</a> = (<a class="code" href="usb_8h.html#ab8fdd4551fc9bedbcef101983ef0ef93">IS_RGB</a>(vendor, product) ? <a class="code" href="structures_8h.html#a5d86a5bc4f1b000781062b6f46008ca8">FEAT_STD_RGB</a> : <a class="code" href="structures_8h.html#a3ddcf7286721f59a31793825854fc21a">FEAT_STD_NRGB</a>) &amp; <a class="code" href="usb_8c.html#a234c8042548e4208f82fc7f89472e14e">features_mask</a>;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="usb_8h.html#a9aa1b86ddc13dc886bb403fda7c72ee7">IS_MOUSE</a>(vendor, product)) kb-&gt;<a class="code" href="structures_8h.html#abbffdd889fd9a15c8796a47cabd3abd9">features</a> |= <a class="code" href="structures_8h.html#a7f4c1f60cfc4f6e1895f6ce63964688e">FEAT_ADJRATE</a>;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="usb_8h.html#ae9b83f9844f5498d707b7ac7ebf37933">IS_MONOCHROME</a>(vendor, product)) kb-&gt;<a class="code" href="structures_8h.html#abbffdd889fd9a15c8796a47cabd3abd9">features</a> |= <a class="code" href="structures_8h.html#a8ccaa0cec4b7be2b5055a6809f6eb81e">FEAT_MONOCHROME</a>;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    kb-&gt;<a class="code" href="structures_8h.html#a0b79f63d24a3653b071b9e295f3b15fc">usbdelay</a> = <a class="code" href="usb_8h.html#a099563afe2cc26cafb14b788b03d218e">USB_DELAY_DEFAULT</a>;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="comment">// Perform OS-specific setup</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment"></span>    <a class="code" href="usb_8h.html#a8de6458e3d59d88350ef3e73359c3526">DELAY_LONG</a>(kb);</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="usb_8h.html#a39442715182933b93172de60cdb66e8f">os_setupusb</a>(kb))</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        <span class="keywordflow">goto</span> fail;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="comment">// Make up a device name and serial if they weren&#39;t assigned</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="keywordflow">if</span>(!kb-&gt;<a class="code" href="structures_8h.html#a7f4ea697639b052e632ccc590f3c6ba6">serial</a>[0])</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        snprintf(kb-&gt;<a class="code" href="structures_8h.html#a7f4ea697639b052e632ccc590f3c6ba6">serial</a>, <a class="code" href="structures_8h.html#a1633179052fb1ef8df0dd803037b890e">SERIAL_LEN</a>, <span class="stringliteral">&quot;%04x:%04x-NoID&quot;</span>, kb-&gt;<a class="code" href="structures_8h.html#a2fa713366249e2fdbb2539e5d65a1439">vendor</a>, kb-&gt;<a class="code" href="structures_8h.html#a045b6c91e3f04e54f25d39da9bda105b">product</a>);</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keywordflow">if</span>(!kb-&gt;<a class="code" href="structures_8h.html#afe60cc96ef4f77b69f3d15bc9bfb7f58">name</a>[0])</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        snprintf(kb-&gt;<a class="code" href="structures_8h.html#afe60cc96ef4f77b69f3d15bc9bfb7f58">name</a>, <a class="code" href="structures_8h.html#a32d661966379fef9590d62fcb70a384f">KB_NAME_LEN</a>, <span class="stringliteral">&quot;%s %s&quot;</span>, <a class="code" href="usb_8c.html#a8e6389e8183a834fedb6ed317dd26f94">vendor_str</a>(kb-&gt;<a class="code" href="structures_8h.html#a2fa713366249e2fdbb2539e5d65a1439">vendor</a>), <a class="code" href="usb_8c.html#af87f830e031d8f63d2d1c3fc14fdad20">product_str</a>(kb-&gt;<a class="code" href="structures_8h.html#a045b6c91e3f04e54f25d39da9bda105b">product</a>));</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    <span class="comment">// Set up an input device for key events</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment"></span>    <span class="keywordflow">if</span>(<a class="code" href="input_8h.html#ac73b3c2c38b916b901b4cca6b350a863">os_inputopen</a>(kb))</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        <span class="keywordflow">goto</span> fail;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keywordflow">if</span>(pthread_create(&amp;kb-&gt;<a class="code" href="structures_8h.html#a53de3bb8784f5fd8049af32c0c9226f1">inputthread</a>, 0, <a class="code" href="usb_8h.html#a9e5784bfca2e4612f498ce67c7dab275">os_inputmain</a>, kb))</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="keywordflow">goto</span> fail;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    pthread_detach(kb-&gt;<a class="code" href="structures_8h.html#a53de3bb8784f5fd8049af32c0c9226f1">inputthread</a>);</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="input_8h.html#a081bbacaa312d4a1a63bc1cab5d3520f">os_setupindicators</a>(kb))</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        <span class="keywordflow">goto</span> fail;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="comment">// Set up device</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment"></span>    vt-&gt;allocprofile(kb);</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    vt-&gt;updateindicators(kb, 1);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    pthread_mutex_unlock(<a class="code" href="device_8h.html#aa87bd893f7d4bd0700cb699c88dd860b">imutex</a>(kb));</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <span class="keywordflow">if</span>(vt-&gt;start(kb, 0) &amp;&amp; <a class="code" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926">usb_tryreset</a>(kb))</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        <span class="keywordflow">goto</span> fail_noinput;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="comment">// Make /dev path</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="devnode_8c.html#a0c3d1e3cd90f43a9b5ee0793f4a75041">mkdevpath</a>(kb))</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        <span class="keywordflow">goto</span> fail_noinput;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="comment">// Finished. Enter main loop</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    <span class="keywordtype">int</span> index = <a class="code" href="includes_8h.html#ac114b913ed9d0b7cab3b83188f111530">INDEX_OF</a>(kb, <a class="code" href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a>);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <a class="code" href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a>(<span class="stringliteral">&quot;Setup finished for %s%d\n&quot;</span>, <a class="code" href="devnode_8c.html#a6bb60389c0bd8be714f8fe2459205c89">devpath</a>, index);</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <a class="code" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f">updateconnected</a>();</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65">devmain</a>(kb);</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    fail:</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    pthread_mutex_unlock(<a class="code" href="device_8h.html#aa87bd893f7d4bd0700cb699c88dd860b">imutex</a>(kb));</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    fail_noinput:</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <a class="code" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431">closeusb</a>(kb);</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    pthread_mutex_unlock(<a class="code" href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a>(kb));</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;}</div>
<div class="ttc" id="structures_8h_html_a32d661966379fef9590d62fcb70a384f"><div class="ttname"><a href="structures_8h.html#a32d661966379fef9590d62fcb70a384f">KB_NAME_LEN</a></div><div class="ttdeci">#define KB_NAME_LEN</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00174">structures.h:174</a></div></div>
<div class="ttc" id="usb_8c_html_ab8c22b4f7012c6d9fe1a0d5e2a93df65"><div class="ttname"><a href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65">devmain</a></div><div class="ttdeci">static void * devmain(usbdevice *kb)</div><div class="ttdoc">brief . </div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00135">usb.c:135</a></div></div>
<div class="ttc" id="command_8h_html_uniondevcmd"><div class="ttname"><a href="command_8h.html#uniondevcmd">devcmd</a></div><div class="ttdef"><b>Definition:</b> <a href="command_8h_source.html#l00073">command.h:73</a></div></div>
<div class="ttc" id="usb_8c_html_a8a1c88df5e127732cb63f1a8be180926"><div class="ttname"><a href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926">usb_tryreset</a></div><div class="ttdeci">int usb_tryreset(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00465">usb.c:465</a></div></div>
<div class="ttc" id="structures_8h_html_afe60cc96ef4f77b69f3d15bc9bfb7f58"><div class="ttname"><a href="structures_8h.html#afe60cc96ef4f77b69f3d15bc9bfb7f58">usbdevice::name</a></div><div class="ttdeci">char name[40+1]</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00233">structures.h:233</a></div></div>
<div class="ttc" id="usb_8c_html_a8e6389e8183a834fedb6ed317dd26f94"><div class="ttname"><a href="usb_8c.html#a8e6389e8183a834fedb6ed317dd26f94">vendor_str</a></div><div class="ttdeci">const char * vendor_str(short vendor)</div><div class="ttdoc">brief . </div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00043">usb.c:43</a></div></div>
<div class="ttc" id="usb_8h_html_a8de6458e3d59d88350ef3e73359c3526"><div class="ttname"><a href="usb_8h.html#a8de6458e3d59d88350ef3e73359c3526">DELAY_LONG</a></div><div class="ttdeci">#define DELAY_LONG(kb)</div><div class="ttdoc">The longest delay takes place where something went wrong (eg when resetting the device) ...</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00155">usb.h:155</a></div></div>
<div class="ttc" id="devnode_8c_html_a0c3d1e3cd90f43a9b5ee0793f4a75041"><div class="ttname"><a href="devnode_8c.html#a0c3d1e3cd90f43a9b5ee0793f4a75041">mkdevpath</a></div><div class="ttdeci">int mkdevpath(usbdevice *kb)</div><div class="ttdoc">Create a dev path for the keyboard at index. Returns 0 on success. </div><div class="ttdef"><b>Definition:</b> <a href="devnode_8c_source.html#l00268">devnode.c:268</a></div></div>
<div class="ttc" id="usb_8h_html_ab8fdd4551fc9bedbcef101983ef0ef93"><div class="ttname"><a href="usb_8h.html#ab8fdd4551fc9bedbcef101983ef0ef93">IS_RGB</a></div><div class="ttdeci">#define IS_RGB(vendor, product)</div><div class="ttdoc">RGB vs non-RGB test (note: non-RGB Strafe is still considered &quot;RGB&quot; in that it shares the same protoc...</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00124">usb.h:124</a></div></div>
<div class="ttc" id="structures_8h_html_a53de3bb8784f5fd8049af32c0c9226f1"><div class="ttname"><a href="structures_8h.html#a53de3bb8784f5fd8049af32c0c9226f1">usbdevice::inputthread</a></div><div class="ttdeci">pthread_t inputthread</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00219">structures.h:219</a></div></div>
<div class="ttc" id="device_8c_html_a5f2ad0f3998226c000c52c5c375c2661"><div class="ttname"><a href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a></div><div class="ttdeci">usbdevice keyboard[9]</div><div class="ttdoc">remember all usb devices. Needed for closeusb(). </div><div class="ttdef"><b>Definition:</b> <a href="device_8c_source.html#l00010">device.c:10</a></div></div>
<div class="ttc" id="usb_8h_html_a9e5784bfca2e4612f498ce67c7dab275"><div class="ttname"><a href="usb_8h.html#a9e5784bfca2e4612f498ce67c7dab275">os_inputmain</a></div><div class="ttdeci">void * os_inputmain(void *context)</div><div class="ttdoc">os_inputmain is run in a separate thread and will be detached from the main thread, so it needs to clean up its own resources. </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00238">usb_linux.c:238</a></div></div>
<div class="ttc" id="usb_8h_html_a39442715182933b93172de60cdb66e8f"><div class="ttname"><a href="usb_8h.html#a39442715182933b93172de60cdb66e8f">os_setupusb</a></div><div class="ttdeci">int os_setupusb(usbdevice *kb)</div><div class="ttdoc">os_setupusb OS-specific setup for a specific usb device. </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00535">usb_linux.c:535</a></div></div>
<div class="ttc" id="usb_8h_html_ae9b83f9844f5498d707b7ac7ebf37933"><div class="ttname"><a href="usb_8h.html#ae9b83f9844f5498d707b7ac7ebf37933">IS_MONOCHROME</a></div><div class="ttdeci">#define IS_MONOCHROME(vendor, product)</div><div class="ttdoc">The difference between non RGB and monochrome is, that monochrome has lights, but just in one color...</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00129">usb.h:129</a></div></div>
<div class="ttc" id="usb_8h_html_a9aa1b86ddc13dc886bb403fda7c72ee7"><div class="ttname"><a href="usb_8h.html#a9aa1b86ddc13dc886bb403fda7c72ee7">IS_MOUSE</a></div><div class="ttdeci">#define IS_MOUSE(vendor, product)</div><div class="ttdoc">Mouse vs keyboard test. </div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00141">usb.h:141</a></div></div>
<div class="ttc" id="input_8h_html_ac73b3c2c38b916b901b4cca6b350a863"><div class="ttname"><a href="input_8h.html#ac73b3c2c38b916b901b4cca6b350a863">os_inputopen</a></div><div class="ttdeci">int os_inputopen(usbdevice *kb)</div><div class="ttdoc">os_inputopen </div><div class="ttdef"><b>Definition:</b> <a href="input__linux_8c_source.html#l00055">input_linux.c:55</a></div></div>
<div class="ttc" id="usb_8c_html_a25ded61622ec9349905b5aa2ed2cb48b"><div class="ttname"><a href="usb_8c.html#a25ded61622ec9349905b5aa2ed2cb48b">get_vtable</a></div><div class="ttdeci">static const devcmd * get_vtable(short vendor, short product)</div><div class="ttdoc">brief . </div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00102">usb.c:102</a></div></div>
<div class="ttc" id="usb_8c_html_a234c8042548e4208f82fc7f89472e14e"><div class="ttname"><a href="usb_8c.html#a234c8042548e4208f82fc7f89472e14e">features_mask</a></div><div class="ttdeci">int features_mask</div><div class="ttdoc">brief . </div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00035">usb.c:35</a></div></div>
<div class="ttc" id="devnode_8c_html_a6bb60389c0bd8be714f8fe2459205c89"><div class="ttname"><a href="devnode_8c.html#a6bb60389c0bd8be714f8fe2459205c89">devpath</a></div><div class="ttdeci">const char *const devpath</div><div class="ttdef"><b>Definition:</b> <a href="devnode_8c_source.html#l00011">devnode.c:11</a></div></div>
<div class="ttc" id="includes_8h_html_af3b6c3fbbe2da20e4058fd83084329a6"><div class="ttname"><a href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a></div><div class="ttdeci">#define ckb_info(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00055">includes.h:55</a></div></div>
<div class="ttc" id="structures_8h_html_a045b6c91e3f04e54f25d39da9bda105b"><div class="ttname"><a href="structures_8h.html#a045b6c91e3f04e54f25d39da9bda105b">usbdevice::product</a></div><div class="ttdeci">short product</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00237">structures.h:237</a></div></div>
<div class="ttc" id="includes_8h_html_ac114b913ed9d0b7cab3b83188f111530"><div class="ttname"><a href="includes_8h.html#ac114b913ed9d0b7cab3b83188f111530">INDEX_OF</a></div><div class="ttdeci">#define INDEX_OF(entry, array)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00027">includes.h:27</a></div></div>
<div class="ttc" id="usb_8h_html_a099563afe2cc26cafb14b788b03d218e"><div class="ttname"><a href="usb_8h.html#a099563afe2cc26cafb14b788b03d218e">USB_DELAY_DEFAULT</a></div><div class="ttdeci">#define USB_DELAY_DEFAULT</div><div class="ttdoc">This constant is used to initialize kb-&gt;usbdelay. It is used in many places (see macros above) but of...</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00160">usb.h:160</a></div></div>
<div class="ttc" id="structures_8h_html_a5d86a5bc4f1b000781062b6f46008ca8"><div class="ttname"><a href="structures_8h.html#a5d86a5bc4f1b000781062b6f46008ca8">FEAT_STD_RGB</a></div><div class="ttdeci">#define FEAT_STD_RGB</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00152">structures.h:152</a></div></div>
<div class="ttc" id="usb_8c_html_af87f830e031d8f63d2d1c3fc14fdad20"><div class="ttname"><a href="usb_8c.html#af87f830e031d8f63d2d1c3fc14fdad20">product_str</a></div><div class="ttdeci">const char * product_str(short product)</div><div class="ttdoc">brief . </div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00070">usb.c:70</a></div></div>
<div class="ttc" id="structures_8h_html_a3ad960bd68547aca1f870fac1138023b"><div class="ttname"><a href="structures_8h.html#a3ad960bd68547aca1f870fac1138023b">usbdevice::vtable</a></div><div class="ttdeci">const union devcmd * vtable</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00180">structures.h:180</a></div></div>
<div class="ttc" id="structures_8h_html_a8ccaa0cec4b7be2b5055a6809f6eb81e"><div class="ttname"><a href="structures_8h.html#a8ccaa0cec4b7be2b5055a6809f6eb81e">FEAT_MONOCHROME</a></div><div class="ttdeci">#define FEAT_MONOCHROME</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00137">structures.h:137</a></div></div>
<div class="ttc" id="input_8h_html_a081bbacaa312d4a1a63bc1cab5d3520f"><div class="ttname"><a href="input_8h.html#a081bbacaa312d4a1a63bc1cab5d3520f">os_setupindicators</a></div><div class="ttdeci">int os_setupindicators(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="input__linux_8c_source.html#l00189">input_linux.c:189</a></div></div>
<div class="ttc" id="structures_8h_html_structusbdevice"><div class="ttname"><a href="structures_8h.html#structusbdevice">usbdevice</a></div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00178">structures.h:178</a></div></div>
<div class="ttc" id="usb_8c_html_a8732b3ade76da4ae362996232ef95431"><div class="ttname"><a href="usb_8c.html#a8732b3ade76da4ae362996232ef95431">closeusb</a></div><div class="ttdeci">int closeusb(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00677">usb.c:677</a></div></div>
<div class="ttc" id="structures_8h_html_a7f4ea697639b052e632ccc590f3c6ba6"><div class="ttname"><a href="structures_8h.html#a7f4ea697639b052e632ccc590f3c6ba6">usbdevice::serial</a></div><div class="ttdeci">char serial[34]</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00235">structures.h:235</a></div></div>
<div class="ttc" id="device_8h_html_aa87bd893f7d4bd0700cb699c88dd860b"><div class="ttname"><a href="device_8h.html#aa87bd893f7d4bd0700cb699c88dd860b">imutex</a></div><div class="ttdeci">#define imutex(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00022">device.h:22</a></div></div>
<div class="ttc" id="structures_8h_html_abbffdd889fd9a15c8796a47cabd3abd9"><div class="ttname"><a href="structures_8h.html#abbffdd889fd9a15c8796a47cabd3abd9">usbdevice::features</a></div><div class="ttdeci">ushort features</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00229">structures.h:229</a></div></div>
<div class="ttc" id="structures_8h_html_a0b79f63d24a3653b071b9e295f3b15fc"><div class="ttname"><a href="structures_8h.html#a0b79f63d24a3653b071b9e295f3b15fc">usbdevice::usbdelay</a></div><div class="ttdeci">char usbdelay</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00243">structures.h:243</a></div></div>
<div class="ttc" id="structures_8h_html_a3ddcf7286721f59a31793825854fc21a"><div class="ttname"><a href="structures_8h.html#a3ddcf7286721f59a31793825854fc21a">FEAT_STD_NRGB</a></div><div class="ttdeci">#define FEAT_STD_NRGB</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00153">structures.h:153</a></div></div>
<div class="ttc" id="device_8h_html_a96bbdd939f65eebc392e07d74e6e6605"><div class="ttname"><a href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a></div><div class="ttdeci">#define dmutex(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00018">device.h:18</a></div></div>
<div class="ttc" id="structures_8h_html_a7f4c1f60cfc4f6e1895f6ce63964688e"><div class="ttname"><a href="structures_8h.html#a7f4c1f60cfc4f6e1895f6ce63964688e">FEAT_ADJRATE</a></div><div class="ttdeci">#define FEAT_ADJRATE</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00139">structures.h:139</a></div></div>
<div class="ttc" id="structures_8h_html_a2fa713366249e2fdbb2539e5d65a1439"><div class="ttname"><a href="structures_8h.html#a2fa713366249e2fdbb2539e5d65a1439">usbdevice::vendor</a></div><div class="ttdeci">short vendor</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00237">structures.h:237</a></div></div>
<div class="ttc" id="devnode_8c_html_a4f2642e0c38280a1516fbe153c9fa18f"><div class="ttname"><a href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f">updateconnected</a></div><div class="ttdeci">void updateconnected()</div><div class="ttdoc">Update the list of connected devices. </div><div class="ttdef"><b>Definition:</b> <a href="devnode_8c_source.html#l00081">devnode.c:81</a></div></div>
<div class="ttc" id="structures_8h_html_a1633179052fb1ef8df0dd803037b890e"><div class="ttname"><a href="structures_8h.html#a1633179052fb1ef8df0dd803037b890e">SERIAL_LEN</a></div><div class="ttdeci">#define SERIAL_LEN</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00175">structures.h:175</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-2" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-2-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-2-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-2-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a10ad381abfe51e67e341c882c92bb9ac_cgraph.png" border="0" usemap="#usb_8c_a10ad381abfe51e67e341c882c92bb9ac_cgraph" alt=""/></div>
<map name="usb_8c_a10ad381abfe51e67e341c882c92bb9ac_cgraph" id="usb_8c_a10ad381abfe51e67e341c882c92bb9ac_cgraph">
<area shape="rect" id="node2" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431" title="closeusb" alt="" coords="349,132,424,159"/><area shape="rect" id="node4" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. " alt="" coords="509,5,630,32"/><area shape="rect" id="node11" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . " alt="" coords="166,309,237,336"/><area shape="rect" id="node19" href="usb_8c.html#a25ded61622ec9349905b5aa2ed2cb48b" title="brief . " alt="" coords="160,411,243,437"/><area shape="rect" id="node20" href="devnode_8c.html#a0c3d1e3cd90f43a9b5ee0793f4a75041" title="Create a dev path for the keyboard at index. Returns 0 on success. " alt="" coords="158,461,245,488"/><area shape="rect" id="node23" href="usb_8c.html#af87f830e031d8f63d2d1c3fc14fdad20" title="brief . " alt="" coords="526,512,613,539"/><area shape="rect" id="node24" href="usb_8c.html#a8e6389e8183a834fedb6ed317dd26f94" title="brief . " alt="" coords="528,563,611,589"/><area shape="rect" id="node25" href="usb_8h.html#a9e5784bfca2e4612f498ce67c7dab275" title="os_inputmain is run in a separate thread and will be detached from the main thread, so it needs to clean up its own resources. " alt="" coords="152,683,251,709"/><area shape="rect" id="node42" href="input_8h.html#ac73b3c2c38b916b901b4cca6b350a863" title="os_inputopen " alt="" coords="152,771,251,797"/><area shape="rect" id="node44" href="input_8h.html#a081bbacaa312d4a1a63bc1cab5d3520f" title="os_setupindicators" alt="" coords="136,897,267,924"/><area shape="rect" id="node46" href="usb_8h.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb OS&#45;specific setup for a specific usb device. " alt="" coords="153,980,249,1007"/><area shape="rect" id="node48" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset" alt="" coords="339,1069,434,1096"/><area shape="rect" id="node3" href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a" title="os_inputclose" alt="" coords="518,107,621,133"/><area shape="rect" id="node6" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb unclaim it, destroy the udev device and clear data structures at kb " alt="" coords="522,56,617,83"/><area shape="rect" id="node8" href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f" title="Remove the dev path for the keyboard at index. Returns 0 on success. " alt="" coords="528,259,611,285"/><area shape="rect" id="node5" href="devnode_8c.html#acc36eaba5eb854461ab3c0a4d146e9c9" title="_updateconnected Update the list of connected devices. " alt="" coords="680,5,808,32"/><area shape="rect" id="node7" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="700,56,788,83"/><area shape="rect" id="node9" href="devnode_8c.html#a9d97ede033e4f6c6bdd1c66fc82aa15e" title="_rmnotifynode" alt="" coords="692,208,796,235"/><area shape="rect" id="node10" href="devnode_8c.html#aac8f6f936a0ff6c16adc677622b226c4" title="rm_recursive" alt="" coords="695,284,793,311"/><area shape="rect" id="node12" href="devnode_8c.html#ac118005c75badc2028b4921be8d9bdd0" title="readlines_ctx_init" alt="" coords="325,233,448,260"/><area shape="rect" id="node13" href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7" title="readlines" alt="" coords="349,284,424,311"/><area shape="rect" id="node14" href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9" title="readcmd" alt="" coords="351,335,423,361"/><area shape="rect" id="node18" href="devnode_8c.html#a588ab2c69fcb283a5beb90c49a165979" title="readlines_ctx_free" alt="" coords="323,385,451,412"/><area shape="rect" id="node15" href="devnode_8c.html#a981305884de053a41d337efac23900ec" title="Creates a notification node for the specified keyboard. " alt="" coords="519,360,619,387"/><area shape="rect" id="node17" href="devnode_8c.html#a40e40a8ea3edccbfd8fdfefc44a76206" title="Removes a notification node for the specified keyboard. " alt="" coords="521,157,618,184"/><area shape="rect" id="node16" href="devnode_8c.html#a38fcf6ff044f9249ae04234340ee8e7b" title="_mknotifynode" alt="" coords="691,385,797,412"/><area shape="rect" id="node21" href="devnode_8c.html#a81c81014b2dfa89e326dd61769842953" title="_mkdevpath" alt="" coords="340,461,433,488"/><area shape="rect" id="node22" href="devnode_8c.html#ad130425a617cf973b28603a72607a057" title="Writes a keyboard&#39;s firmware version and poll rate to its device node. " alt="" coords="528,411,611,437"/><area shape="rect" id="node26" href="keymap_8c.html#a092f675ff366b5823c73b25f83d513f9" title="hid_mouse_translate" alt="" coords="315,664,458,691"/><area shape="rect" id="node27" href="keymap_8c.html#a0dc9a16564cc51b35a35d28af1a96fb0" title="corsair_mousecopy" alt="" coords="319,715,454,741"/><area shape="rect" id="node28" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889" title="hid_kb_translate" alt="" coords="328,765,445,792"/><area shape="rect" id="node29" href="keymap_8c.html#ad39ede76abd657f5123fa331853db017" title="corsair_kbcopy" alt="" coords="331,816,442,843"/><area shape="rect" id="node30" href="input_8c.html#ae360d0b9a764a1d38c5be5464be8b70a" title="inputupdate" alt="" coords="342,613,431,640"/><area shape="rect" id="node31" href="input_8c.html#aed8e9842ed5750c1d328c5dc4c1ba2bd" title="inputupdate_keys Handle input from Keyboard or mouse; start Macrof if detected. " alt="" coords="507,613,631,640"/><area shape="rect" id="node41" href="input_8h.html#a9f2cfb2d883ae4a3732047fe3f3da683" title="os_mousemove" alt="" coords="865,791,980,817"/><area shape="rect" id="node32" href="input_8c.html#a34b6a3d2e97732b6973cd608e35317c9" title="macro_pt_first returns the first pthread_id but does not remove the first entry. " alt="" coords="870,639,975,665"/><area shape="rect" id="node33" href="input_8c.html#abd38419ce56379559481f51d9491adeb" title="macromask" alt="" coords="699,487,789,513"/><area shape="rect" id="node34" href="notify_8c.html#ac2411c0997dfdbefdebd45f2584a5d04" title="nprintkey" alt="" coords="707,537,781,564"/><area shape="rect" id="node36" href="input_8h.html#af0d3401f317f3214dadad7d1a3378c58" title="os_keypress" alt="" coords="875,588,971,615"/><area shape="rect" id="node38" href="input_8c.html#a42ef48810461524270042eeda9616dba" title="play_macro is the code for all threads started to play a macro. " alt="" coords="699,689,789,716"/><area shape="rect" id="node35" href="notify_8c.html#a7ac88f15243030290e4d57c3c9ac7c98" title="nprintf" alt="" coords="893,537,952,564"/><area shape="rect" id="node37" href="input__linux_8c.html#a14ff0fdf147e3702197db2cadb878460" title="isync" alt="" coords="1037,689,1091,716"/><area shape="rect" id="node39" href="input_8c.html#a712ce5a59c9a281c4d4c4d0ba3446de7" title="macro_pt_dequeue gets the first thread id of the list and returns the thread_id stored in it..." alt="" coords="857,689,989,716"/><area shape="rect" id="node40" href="input_8c.html#a225fb4bb1f20d4a8b524f5d72763367d" title="macro_pt_enqueue Save the new thread in the single linked list (FIFO). " alt="" coords="857,740,989,767"/><area shape="rect" id="node43" href="input__linux_8c.html#a5f050529d49f8cb5e8dda4617c5984b7" title="uinputopen" alt="" coords="344,867,429,893"/><area shape="rect" id="node45" href="input__linux_8c.html#a5d40cc9137eaefbc2d860fac76020460" title="_ledthread" alt="" coords="345,917,428,944"/><area shape="rect" id="node47" href="usb__linux_8c.html#ab694a2ac859b16b5af802b4484f5ba0b" title="strtrim" alt="" coords="357,968,416,995"/><area shape="rect" id="node49" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626" title="usbclaim" alt="" coords="349,1019,424,1045"/></map>
</div>
</p>

<p><div id="dynsection-3" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-3-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-3-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-3-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a10ad381abfe51e67e341c882c92bb9ac_icgraph.png" border="0" usemap="#usb_8c_a10ad381abfe51e67e341c882c92bb9ac_icgraph" alt=""/></div>
<map name="usb_8c_a10ad381abfe51e67e341c882c92bb9ac_icgraph" id="usb_8c_a10ad381abfe51e67e341c882c92bb9ac_icgraph">
<area shape="rect" id="node2" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="136,31,211,57"/><area shape="rect" id="node3" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="259,31,323,57"/><area shape="rect" id="node4" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="371,31,487,57"/><area shape="rect" id="node5" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="537,5,626,32"/><area shape="rect" id="node6" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="675,31,746,57"/><area shape="rect" id="node7" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="795,31,845,57"/><area shape="rect" id="node8" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="893,31,952,57"/><area shape="rect" id="node9" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1000,31,1091,57"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a5a548f93d4c1c56910b840cebe88d0c2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int _usbrecv </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *&#160;</td>
          <td class="paramname"><em>out_msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *&#160;</td>
          <td class="paramname"><em>in_msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>line</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>_usbrecv Request data from a USB device by first sending an output packet and then reading the response.</p>
<p>To fully understand this, you need to know about usb: All control is at the usb host (the CPU). If the device wants to communicate something to the host, it must wait for the host to ask. The usb protocol defines the cycles and periods in which actions are to be taken.</p>
<p>So in order to receive a data packet from the device, the host must first send a send request. <br/>
 This is done by <a class="el" href="usb_8h.html#a5a548f93d4c1c56910b840cebe88d0c2" title="_usbrecv Request data from a USB device by first sending an output packet and then reading the respon...">_usbrecv()</a> in the first block by sending the MSG_SIZE large data block from <b>out_msg</b> via <a class="el" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long ">os_usbsend()</a> as it is a machine depending implementation. The usb target device is as always determined over kb.</p>
<p>For <a class="el" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long ">os_usbsend()</a> to know that it is a receive request, the <b>is_recv</b> parameter is set to true (1). With this, os_usbsend () generates a control package for the hardware, not a data packet.</p>
<p>If sending of the control package is not successful, a maximum of 5 times the transmission is repeated (including the first attempt). If a non-cancelable error is signaled or the drive is stopped via reset_stop, <a class="el" href="usb_8h.html#a5a548f93d4c1c56910b840cebe88d0c2" title="_usbrecv Request data from a USB device by first sending an output packet and then reading the respon...">_usbrecv()</a> immediately returns 0.</p>
<p>After this, the function waits for the requested response from the device using os_usbrecv ().</p>
<p><a class="el" href="usb_8h.html#a5694446920cfae8c887163847312a8f8" title="os_usbrecv receives a max MSGSIZE long buffer from usb device ">os_usbrecv()</a> returns 0, -1 or something else. <br/>
 Zero signals a serious error which is not treatable and <a class="el" href="usb_8h.html#a5a548f93d4c1c56910b840cebe88d0c2" title="_usbrecv Request data from a USB device by first sending an output packet and then reading the respon...">_usbrecv()</a> also returns 0. <br/>
 -1 means that it is a treatable error - a timeout for example - and therefore the next transfer attempt is started after a long pause (DELAY_LONG) if not reset_stop or the wrong hwload_mode require a termination with a return value of 0.</p>
<p>After 5 attempts, _usbrecv () returns and returns 0 as well as an error message.</p>
<p>When data is received, the number of received bytes is returned. This should always be MSG_SIZE, but <a class="el" href="usb_8h.html#a5694446920cfae8c887163847312a8f8" title="os_usbrecv receives a max MSGSIZE long buffer from usb device ">os_usbrecv()</a> can also return less. It should not be more, because then there would be an unhandled buffer overflow, but it could be less. This would be signaled in os_usbrecv () with a message.</p>
<p>The buffers behind <b>out_msg</b> and <b>in_msg</b> are MSG_SIZE at least (currently 64 Bytes). More is ok but useless, less brings unpredictable behavior. </p>
<p>&lt; Synchonization between macro and color information </p>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00601">601</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00048">ckb_err_fn</a>, <a class="el" href="usb_8h_source.html#l00155">DELAY_LONG</a>, <a class="el" href="usb_8h_source.html#l00152">DELAY_MEDIUM</a>, <a class="el" href="usb_8h_source.html#l00149">DELAY_SHORT</a>, <a class="el" href="device_8c_source.html#l00007">hwload_mode</a>, <a class="el" href="device_8h_source.html#l00026">mmutex</a>, <a class="el" href="usb__linux_8c_source.html#l00129">os_usbrecv()</a>, <a class="el" href="usb__linux_8c_source.html#l00068">os_usbsend()</a>, and <a class="el" href="usb_8c_source.html#l00025">reset_stop</a>.</p>
<div class="fragment"><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                                                                                            {</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="comment">// Try a maximum of 5 times</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <span class="keywordflow">try</span> = 0; <span class="keywordflow">try</span> &lt; 5; <span class="keywordflow">try</span>++) {</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <span class="comment">// Send the output message</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        pthread_mutex_lock(<a class="code" href="device_8h.html#a7c03b451627e1eefc2e17de9da445619">mmutex</a>(kb)); </div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        <a class="code" href="usb_8h.html#a73130b0fe3277a0fd9481eceb4f0e483">DELAY_SHORT</a>(kb);</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        <span class="keywordtype">int</span> res = <a class="code" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894">os_usbsend</a>(kb, out_msg, 1, file, line);</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        pthread_mutex_unlock(<a class="code" href="device_8h.html#a7c03b451627e1eefc2e17de9da445619">mmutex</a>(kb));</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        <span class="keywordflow">if</span> (res == 0)</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == -1) {</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;            <span class="comment">// Retry on temporary failure</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#acfc08dcd9203a7489c1c43362e2ff138">reset_stop</a>)</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;            <a class="code" href="usb_8h.html#a8de6458e3d59d88350ef3e73359c3526">DELAY_LONG</a>(kb);</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        }</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        <span class="comment">// Wait for the response</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        <a class="code" href="usb_8h.html#aff3be8eafb827438a28c97b8f9d2ddcc">DELAY_MEDIUM</a>(kb);</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        res = <a class="code" href="usb_8h.html#a5694446920cfae8c887163847312a8f8">os_usbrecv</a>(kb, in_msg, file, line);</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        <span class="keywordflow">if</span>(res == 0)</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(res != -1)</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;            <span class="keywordflow">return</span> res;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="usb_8c.html#acfc08dcd9203a7489c1c43362e2ff138">reset_stop</a> || <a class="code" href="usb_8c.html#a94d4a8df060c5f77d94f3656fefe6c32">hwload_mode</a> != 2)</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        <a class="code" href="usb_8h.html#a8de6458e3d59d88350ef3e73359c3526">DELAY_LONG</a>(kb);</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    }</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="comment">// Give up</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <a class="code" href="includes_8h.html#a31d8dc974fcd529cb912ca80f05db462">ckb_err_fn</a>(<span class="stringliteral">&quot;Too many send/recv failures. Dropping.\n&quot;</span>, file, line);</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;}</div>
<div class="ttc" id="device_8h_html_a7c03b451627e1eefc2e17de9da445619"><div class="ttname"><a href="device_8h.html#a7c03b451627e1eefc2e17de9da445619">mmutex</a></div><div class="ttdeci">#define mmutex(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00026">device.h:26</a></div></div>
<div class="ttc" id="usb_8h_html_aff3be8eafb827438a28c97b8f9d2ddcc"><div class="ttname"><a href="usb_8h.html#aff3be8eafb827438a28c97b8f9d2ddcc">DELAY_MEDIUM</a></div><div class="ttdeci">#define DELAY_MEDIUM(kb)</div><div class="ttdoc">the medium delay is used after sending a command before waiting for the answer. </div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00152">usb.h:152</a></div></div>
<div class="ttc" id="usb_8h_html_a73130b0fe3277a0fd9481eceb4f0e483"><div class="ttname"><a href="usb_8h.html#a73130b0fe3277a0fd9481eceb4f0e483">DELAY_SHORT</a></div><div class="ttdeci">#define DELAY_SHORT(kb)</div><div class="ttdoc">USB delays for when the keyboards get picky about timing That was the original comment, but it is used anytime. The short delay is used before any send or receive. </div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00149">usb.h:149</a></div></div>
<div class="ttc" id="usb_8h_html_a8de6458e3d59d88350ef3e73359c3526"><div class="ttname"><a href="usb_8h.html#a8de6458e3d59d88350ef3e73359c3526">DELAY_LONG</a></div><div class="ttdeci">#define DELAY_LONG(kb)</div><div class="ttdoc">The longest delay takes place where something went wrong (eg when resetting the device) ...</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00155">usb.h:155</a></div></div>
<div class="ttc" id="usb_8h_html_a5694446920cfae8c887163847312a8f8"><div class="ttname"><a href="usb_8h.html#a5694446920cfae8c887163847312a8f8">os_usbrecv</a></div><div class="ttdeci">int os_usbrecv(usbdevice *kb, uchar *in_msg, const char *file, int line)</div><div class="ttdoc">os_usbrecv receives a max MSGSIZE long buffer from usb device </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00129">usb_linux.c:129</a></div></div>
<div class="ttc" id="usb_8c_html_acfc08dcd9203a7489c1c43362e2ff138"><div class="ttname"><a href="usb_8c.html#acfc08dcd9203a7489c1c43362e2ff138">reset_stop</a></div><div class="ttdeci">volatile int reset_stop</div><div class="ttdoc">brief . </div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00025">usb.c:25</a></div></div>
<div class="ttc" id="usb_8c_html_a94d4a8df060c5f77d94f3656fefe6c32"><div class="ttname"><a href="usb_8c.html#a94d4a8df060c5f77d94f3656fefe6c32">hwload_mode</a></div><div class="ttdeci">int hwload_mode</div><div class="ttdoc">hwload_mode is defined in device.c </div><div class="ttdef"><b>Definition:</b> <a href="device_8c_source.html#l00007">device.c:7</a></div></div>
<div class="ttc" id="usb_8h_html_a9e813287cd0ee9c7b665002a929d2894"><div class="ttname"><a href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894">os_usbsend</a></div><div class="ttdeci">int os_usbsend(usbdevice *kb, const uchar *out_msg, int is_recv, const char *file, int line)</div><div class="ttdoc">os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00068">usb_linux.c:68</a></div></div>
<div class="ttc" id="includes_8h_html_a31d8dc974fcd529cb912ca80f05db462"><div class="ttname"><a href="includes_8h.html#a31d8dc974fcd529cb912ca80f05db462">ckb_err_fn</a></div><div class="ttdeci">#define ckb_err_fn(fmt, file, line, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00048">includes.h:48</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-4" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-4-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-4-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-4-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a5a548f93d4c1c56910b840cebe88d0c2_cgraph.png" border="0" usemap="#usb_8c_a5a548f93d4c1c56910b840cebe88d0c2_cgraph" alt=""/></div>
<map name="usb_8c_a5a548f93d4c1c56910b840cebe88d0c2_cgraph" id="usb_8c_a5a548f93d4c1c56910b840cebe88d0c2_cgraph">
<area shape="rect" id="node2" href="usb_8h.html#a5694446920cfae8c887163847312a8f8" title="os_usbrecv receives a max MSGSIZE long buffer from usb device " alt="" coords="130,5,219,32"/><area shape="rect" id="node3" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long " alt="" coords="129,56,221,83"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a992cce1d173047466101113bfff5d7a1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int _usbsend </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *&#160;</td>
          <td class="paramname"><em>messages</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>count</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>line</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>_usbsend send a logical message completely to the given device</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000011">Todo:</a></b></dt><dd>A lot of different conditions are combined in this code. Don't think, it is good in every combination...</dd></dl>
<p>The main task of _usbsend () is to transfer the complete logical message from the buffer beginning with <em>messages</em> to <b>count * MSG_SIZE</b>. <br/>
 According to usb 2.0 specification, a USB transmits a maximum of 64 byte user data packets. For the transmission of longer messages we need a segmentation. And that is exactly what happens here.</p>
<p>The message is given one by one to <a class="el" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long ">os_usbsend()</a> in MSG_SIZE (= 64) byte large bites. </p>
<dl class="section attention"><dt>Attention</dt><dd>This means that the buffer given as argument must be n * MSG_SIZE Byte long.</dd></dl>
<p>An essential constant parameter which is relevant for <a class="el" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long ">os_usbsend()</a> only is is_recv = 0, which means sending.</p>
<p>Now it gets a little complicated again:</p>
<ul>
<li>If <a class="el" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long ">os_usbsend()</a> returns 0, only zero bytes could be sent in one of the packets, or it was an error (-1 from the systemcall), but not a timeout. How many Bytes were sent in total from earlier calls does not seem to matter, <a class="el" href="usb_8h.html#a992cce1d173047466101113bfff5d7a1" title="_usbsend send a logical message completely to the given device ">_usbsend()</a> returns a total of 0.</li>
<li>Returns <a class="el" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long ">os_usbsend()</a> -1, first check if <b>reset_stop</b> is set globally or (incomprehensible) hwload_mode is not set to "always". In either case, <a class="el" href="usb_8h.html#a992cce1d173047466101113bfff5d7a1" title="_usbsend send a logical message completely to the given device ">_usbsend()</a> returns 0, otherwise it is assumed to be a temporary transfer error and it simply retransmits the physical packet after a long delay.</li>
<li>If the return value of <a class="el" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long ">os_usbsend()</a> was neither 0 nor -1, it specifies the numer of bytes transferred. <br/>
 Here is an information hiding conflict with <a class="el" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long ">os_usbsend()</a> (at least in the Linux version): <br/>
 If <a class="el" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long ">os_usbsend()</a> can not transfer the entire packet, errors are thrown and the number of bytes sent is returned. <a class="el" href="usb_8h.html#a992cce1d173047466101113bfff5d7a1" title="_usbsend send a logical message completely to the given device ">_usbsend()</a> interprets this as well and remembers the total number of bytes transferred in the local variable <b>total_sent</b>. Subsequently, however, transmission is continued with the next complete MSG_SIZE block and not with the first of the possibly missing bytes. <dl class="todo"><dt><b><a class="el" href="todo.html#_todo000012">Todo:</a></b></dt><dd>Check whether this is the same in the macOS variant. It is not dramatic, but if errors occur, it can certainly irritate the devices completely if they receive incomplete data streams. Do we have errors with the messages "Wrote YY bytes (expected 64)" in the system logs? If not, we do not need to look any further.</dd></dl>
</li>
</ul>
<p>When the last packet is transferred, <a class="el" href="usb_8h.html#a992cce1d173047466101113bfff5d7a1" title="_usbsend send a logical message completely to the given device ">_usbsend()</a> returns the effectively counted set of bytes (from <b>total_sent</b>). This at least gives the caller the opportunity to check whether something has been lost in the middle.</p>
<p>A bit strange is the structure of the program: Handling the <b>count</b> MSG_SIZE blocks to be transferred is done in the outer for (...) loop. Repeating the transfer with a treatable error is managed by the inner while(1) loop. <br/>
 This must be considered when reading the code; The "break" on successful block transfer leaves the inner while, not the for (...). </p>
<p>&lt; Synchonization between macro and color information </p>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00532">532</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="usb_8h_source.html#l00155">DELAY_LONG</a>, <a class="el" href="usb_8h_source.html#l00149">DELAY_SHORT</a>, <a class="el" href="device_8c_source.html#l00007">hwload_mode</a>, <a class="el" href="device_8h_source.html#l00026">mmutex</a>, <a class="el" href="structures_8h_source.html#l00176">MSG_SIZE</a>, <a class="el" href="usb__linux_8c_source.html#l00068">os_usbsend()</a>, and <a class="el" href="usb_8c_source.html#l00025">reset_stop</a>.</p>
<div class="fragment"><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                                                                                         {</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="keywordtype">int</span> total_sent = 0;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; count; i++){</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        <span class="comment">// Send each message via the OS function</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        <span class="keywordflow">while</span>(1){</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;            pthread_mutex_lock(<a class="code" href="device_8h.html#a7c03b451627e1eefc2e17de9da445619">mmutex</a>(kb)); </div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;            <a class="code" href="usb_8h.html#a73130b0fe3277a0fd9481eceb4f0e483">DELAY_SHORT</a>(kb);</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;            <span class="keywordtype">int</span> res = <a class="code" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894">os_usbsend</a>(kb, messages + i * <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>, 0, file, line);</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            pthread_mutex_unlock(<a class="code" href="device_8h.html#a7c03b451627e1eefc2e17de9da445619">mmutex</a>(kb));</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;            <span class="keywordflow">if</span>(res == 0)</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(res != -1){</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                total_sent += res;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;            }</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;            <span class="comment">// Stop immediately if the program is shutting down or hardware load is set to tryonce</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="usb_8c.html#acfc08dcd9203a7489c1c43362e2ff138">reset_stop</a> || <a class="code" href="usb_8c.html#a94d4a8df060c5f77d94f3656fefe6c32">hwload_mode</a> != 2)</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;            <span class="comment">// Retry as long as the result is temporary failure</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;            <a class="code" href="usb_8h.html#a8de6458e3d59d88350ef3e73359c3526">DELAY_LONG</a>(kb);</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        }</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    }</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="keywordflow">return</span> total_sent;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;}</div>
<div class="ttc" id="structures_8h_html_ad4d025ecf1bdbf8b244ca688df8e478d"><div class="ttname"><a href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a></div><div class="ttdeci">#define MSG_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00176">structures.h:176</a></div></div>
<div class="ttc" id="device_8h_html_a7c03b451627e1eefc2e17de9da445619"><div class="ttname"><a href="device_8h.html#a7c03b451627e1eefc2e17de9da445619">mmutex</a></div><div class="ttdeci">#define mmutex(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00026">device.h:26</a></div></div>
<div class="ttc" id="usb_8h_html_a73130b0fe3277a0fd9481eceb4f0e483"><div class="ttname"><a href="usb_8h.html#a73130b0fe3277a0fd9481eceb4f0e483">DELAY_SHORT</a></div><div class="ttdeci">#define DELAY_SHORT(kb)</div><div class="ttdoc">USB delays for when the keyboards get picky about timing That was the original comment, but it is used anytime. The short delay is used before any send or receive. </div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00149">usb.h:149</a></div></div>
<div class="ttc" id="usb_8h_html_a8de6458e3d59d88350ef3e73359c3526"><div class="ttname"><a href="usb_8h.html#a8de6458e3d59d88350ef3e73359c3526">DELAY_LONG</a></div><div class="ttdeci">#define DELAY_LONG(kb)</div><div class="ttdoc">The longest delay takes place where something went wrong (eg when resetting the device) ...</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00155">usb.h:155</a></div></div>
<div class="ttc" id="usb_8c_html_acfc08dcd9203a7489c1c43362e2ff138"><div class="ttname"><a href="usb_8c.html#acfc08dcd9203a7489c1c43362e2ff138">reset_stop</a></div><div class="ttdeci">volatile int reset_stop</div><div class="ttdoc">brief . </div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00025">usb.c:25</a></div></div>
<div class="ttc" id="usb_8c_html_a94d4a8df060c5f77d94f3656fefe6c32"><div class="ttname"><a href="usb_8c.html#a94d4a8df060c5f77d94f3656fefe6c32">hwload_mode</a></div><div class="ttdeci">int hwload_mode</div><div class="ttdoc">hwload_mode is defined in device.c </div><div class="ttdef"><b>Definition:</b> <a href="device_8c_source.html#l00007">device.c:7</a></div></div>
<div class="ttc" id="usb_8h_html_a9e813287cd0ee9c7b665002a929d2894"><div class="ttname"><a href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894">os_usbsend</a></div><div class="ttdeci">int os_usbsend(usbdevice *kb, const uchar *out_msg, int is_recv, const char *file, int line)</div><div class="ttdoc">os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00068">usb_linux.c:68</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-5" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-5-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-5-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-5-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a992cce1d173047466101113bfff5d7a1_cgraph.png" border="0" usemap="#usb_8c_a992cce1d173047466101113bfff5d7a1_cgraph" alt=""/></div>
<map name="usb_8c_a992cce1d173047466101113bfff5d7a1_cgraph" id="usb_8c_a992cce1d173047466101113bfff5d7a1_cgraph">
<area shape="rect" id="node2" href="usb_8h.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long " alt="" coords="134,5,226,32"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a8732b3ade76da4ae362996232ef95431"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int closeusb </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>closeusb Close a USB device and remove device entry.</p>
<p>An imutex lock ensures first of all, that no communication is currently running from the viewpoint of the driver to the user input device (ie the virtual driver with which characters or mouse movements are sent from the daemon to the operating system as inputs).</p>
<p>If the <b>kb</b> has an acceptable value != 0, the index of the device is looked for and with this index <a class="el" href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a">os_inputclose()</a> is called. After this no more characters can be sent to the operating system.</p>
<p>Then the connection to the usb device is capped by <a class="el" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb unclaim it, destroy the udev device and clear data structures at kb ">os_closeusb()</a>. </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000013">Todo:</a></b></dt><dd>What is not yet comprehensible is the call to <a class="el" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. ">updateconnected()</a> BEFORE <a class="el" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb unclaim it, destroy the udev device and clear data structures at kb ">os_closeusb()</a>. Should that be in the other sequence? Or is <a class="el" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. ">updateconnected()</a> not displaying the connected usb devices, but the representation which uinput devices are loaded? Questions about questions ...</dd></dl>
<p>If there is no valid <b>handle</b>, only <a class="el" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. ">updateconnected()</a> is called. We are probably trying to disconnect a connection under construction. Not clear.</p>
<p>The cmd pipe as well as all open notify pipes are deleted via rmdevpath (). <br/>
 This means that nothing can happen to the input path - so the device-specific imutex is unlocked again and remains unlocked.</p>
<p>Also the dmutex is unlocked now, but only to join the thread, which was originally taken under <b>kb-&gt;thread</b> (which started with <a class="el" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . ">_setupusb()</a>) with pthread_join() again. Because of the closed devices that thread would have to quit sometime </p>
<dl class="section see"><dt>See Also</dt><dd>the hack note with <a class="el" href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f" title="Remove the dev path for the keyboard at index. Returns 0 on success. ">rmdevpath()</a>)</dd></dl>
<p>As soon as the thread is caught, the dmutex is locked again, which is what I do not understand yet: What other thread can do usb communication now? <br/>
 If the vtabel exists for the given kb (why not? It seems to have race conditions here!!), via the vtable the actually device-specific, but still everywhere identical <a class="el" href="profile_8c.html#a1cc4119abc10fdf812f41fe5eecef439">freeprofile()</a> is called. This frees areas that are no longer needed. Then the <b>usbdevice</b> structure in its array is set to zero completely.</p>
<p>Error handling is rather unusual in <a class="el" href="usb_8h.html#a8732b3ade76da4ae362996232ef95431" title="closeusb Close a USB device and remove device entry. ">closeusb()</a>; Everything works (no matter what the called functions return), and <a class="el" href="usb_8h.html#a8732b3ade76da4ae362996232ef95431" title="closeusb Close a USB device and remove device entry. ">closeusb()</a> always returns zero (success). </p>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00677">677</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00055">ckb_info</a>, <a class="el" href="devnode_8c_source.html#l00011">devpath</a>, <a class="el" href="device_8h_source.html#l00018">dmutex</a>, <a class="el" href="structures_8h_source.html#l00187">usbdevice::handle</a>, <a class="el" href="device_8h_source.html#l00022">imutex</a>, <a class="el" href="includes_8h_source.html#l00027">INDEX_OF</a>, <a class="el" href="device_8c_source.html#l00010">keyboard</a>, <a class="el" href="usb__linux_8c_source.html#l00435">os_closeusb()</a>, <a class="el" href="input__linux_8c_source.html#l00076">os_inputclose()</a>, <a class="el" href="devnode_8c_source.html#l00275">rmdevpath()</a>, <a class="el" href="structures_8h_source.html#l00217">usbdevice::thread</a>, <a class="el" href="devnode_8c_source.html#l00081">updateconnected()</a>, and <a class="el" href="structures_8h_source.html#l00180">usbdevice::vtable</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00214">_setupusb()</a>, <a class="el" href="usb_8c_source.html#l00135">devmain()</a>, <a class="el" href="main_8c_source.html#l00040">quitWithLock()</a>, and <a class="el" href="usb__linux_8c_source.html#l00720">usb_rm_device()</a>.</p>
<div class="fragment"><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                           {</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    pthread_mutex_lock(<a class="code" href="device_8h.html#aa87bd893f7d4bd0700cb699c88dd860b">imutex</a>(kb));</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <span class="keywordflow">if</span>(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a>){</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        <span class="keywordtype">int</span> index = <a class="code" href="includes_8h.html#ac114b913ed9d0b7cab3b83188f111530">INDEX_OF</a>(kb, <a class="code" href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a>);</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        <a class="code" href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a>(<span class="stringliteral">&quot;Disconnecting %s%d\n&quot;</span>, <a class="code" href="devnode_8c.html#a6bb60389c0bd8be714f8fe2459205c89">devpath</a>, index);</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;        <a class="code" href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a">os_inputclose</a>(kb);</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        <a class="code" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f">updateconnected</a>();</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        <span class="comment">// Close USB device</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        <a class="code" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8">os_closeusb</a>(kb);</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    } <span class="keywordflow">else</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;        <a class="code" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f">updateconnected</a>();</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <a class="code" href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f">rmdevpath</a>(kb);</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <span class="comment">// Wait for thread to close</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    pthread_mutex_unlock(<a class="code" href="device_8h.html#aa87bd893f7d4bd0700cb699c88dd860b">imutex</a>(kb));</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    pthread_mutex_unlock(<a class="code" href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a>(kb));</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    pthread_join(kb-&gt;<a class="code" href="structures_8h.html#a66ae3ceabd662fd1b7ee8352f303202c">thread</a>, 0);</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    pthread_mutex_lock(<a class="code" href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a>(kb));</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    <span class="comment">// Delete the profile and the control path</span></div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    <span class="keywordflow">if</span>(!kb-&gt;<a class="code" href="structures_8h.html#a3ad960bd68547aca1f870fac1138023b">vtable</a>)</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    kb-&gt;<a class="code" href="structures_8h.html#a3ad960bd68547aca1f870fac1138023b">vtable</a>-&gt;freeprofile(kb);</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    memset(kb, 0, <span class="keyword">sizeof</span>(<a class="code" href="structures_8h.html#structusbdevice">usbdevice</a>));</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;}</div>
<div class="ttc" id="device_8c_html_a5f2ad0f3998226c000c52c5c375c2661"><div class="ttname"><a href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a></div><div class="ttdeci">usbdevice keyboard[9]</div><div class="ttdoc">remember all usb devices. Needed for closeusb(). </div><div class="ttdef"><b>Definition:</b> <a href="device_8c_source.html#l00010">device.c:10</a></div></div>
<div class="ttc" id="usb_8h_html_a6a62575e9073fae15efb58f24fbfe5b8"><div class="ttname"><a href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8">os_closeusb</a></div><div class="ttdeci">void os_closeusb(usbdevice *kb)</div><div class="ttdoc">os_closeusb unclaim it, destroy the udev device and clear data structures at kb </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00435">usb_linux.c:435</a></div></div>
<div class="ttc" id="devnode_8c_html_a6bb60389c0bd8be714f8fe2459205c89"><div class="ttname"><a href="devnode_8c.html#a6bb60389c0bd8be714f8fe2459205c89">devpath</a></div><div class="ttdeci">const char *const devpath</div><div class="ttdef"><b>Definition:</b> <a href="devnode_8c_source.html#l00011">devnode.c:11</a></div></div>
<div class="ttc" id="includes_8h_html_af3b6c3fbbe2da20e4058fd83084329a6"><div class="ttname"><a href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a></div><div class="ttdeci">#define ckb_info(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00055">includes.h:55</a></div></div>
<div class="ttc" id="includes_8h_html_ac114b913ed9d0b7cab3b83188f111530"><div class="ttname"><a href="includes_8h.html#ac114b913ed9d0b7cab3b83188f111530">INDEX_OF</a></div><div class="ttdeci">#define INDEX_OF(entry, array)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00027">includes.h:27</a></div></div>
<div class="ttc" id="structures_8h_html_a3ad960bd68547aca1f870fac1138023b"><div class="ttname"><a href="structures_8h.html#a3ad960bd68547aca1f870fac1138023b">usbdevice::vtable</a></div><div class="ttdeci">const union devcmd * vtable</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00180">structures.h:180</a></div></div>
<div class="ttc" id="structures_8h_html_structusbdevice"><div class="ttname"><a href="structures_8h.html#structusbdevice">usbdevice</a></div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00178">structures.h:178</a></div></div>
<div class="ttc" id="device_8h_html_aa87bd893f7d4bd0700cb699c88dd860b"><div class="ttname"><a href="device_8h.html#aa87bd893f7d4bd0700cb699c88dd860b">imutex</a></div><div class="ttdeci">#define imutex(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00022">device.h:22</a></div></div>
<div class="ttc" id="structures_8h_html_a1e1d8c37298aa076d30ba95dd97465ef"><div class="ttname"><a href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">usbdevice::handle</a></div><div class="ttdeci">int handle</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00187">structures.h:187</a></div></div>
<div class="ttc" id="input_8h_html_a44df5105a6a3f2eda5bc39a88201bd1a"><div class="ttname"><a href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a">os_inputclose</a></div><div class="ttdeci">void os_inputclose(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="input__linux_8c_source.html#l00076">input_linux.c:76</a></div></div>
<div class="ttc" id="structures_8h_html_a66ae3ceabd662fd1b7ee8352f303202c"><div class="ttname"><a href="structures_8h.html#a66ae3ceabd662fd1b7ee8352f303202c">usbdevice::thread</a></div><div class="ttdeci">pthread_t thread</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00217">structures.h:217</a></div></div>
<div class="ttc" id="device_8h_html_a96bbdd939f65eebc392e07d74e6e6605"><div class="ttname"><a href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a></div><div class="ttdeci">#define dmutex(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00018">device.h:18</a></div></div>
<div class="ttc" id="devnode_8c_html_a8d0aeeebb364608943b78573adb85c7f"><div class="ttname"><a href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f">rmdevpath</a></div><div class="ttdeci">int rmdevpath(usbdevice *kb)</div><div class="ttdoc">Remove the dev path for the keyboard at index. Returns 0 on success. </div><div class="ttdef"><b>Definition:</b> <a href="devnode_8c_source.html#l00275">devnode.c:275</a></div></div>
<div class="ttc" id="devnode_8c_html_a4f2642e0c38280a1516fbe153c9fa18f"><div class="ttname"><a href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f">updateconnected</a></div><div class="ttdeci">void updateconnected()</div><div class="ttdoc">Update the list of connected devices. </div><div class="ttdef"><b>Definition:</b> <a href="devnode_8c_source.html#l00081">devnode.c:81</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-6" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-6-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-6-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-6-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a8732b3ade76da4ae362996232ef95431_cgraph.png" border="0" usemap="#usb_8c_a8732b3ade76da4ae362996232ef95431_cgraph" alt=""/></div>
<map name="usb_8c_a8732b3ade76da4ae362996232ef95431_cgraph" id="usb_8c_a8732b3ade76da4ae362996232ef95431_cgraph">
<area shape="rect" id="node2" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb unclaim it, destroy the udev device and clear data structures at kb " alt="" coords="142,5,237,32"/><area shape="rect" id="node4" href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a" title="os_inputclose" alt="" coords="138,56,241,83"/><area shape="rect" id="node5" href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f" title="Remove the dev path for the keyboard at index. Returns 0 on success. " alt="" coords="148,107,231,133"/><area shape="rect" id="node8" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. " alt="" coords="129,157,250,184"/><area shape="rect" id="node3" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="319,5,407,32"/><area shape="rect" id="node6" href="devnode_8c.html#a9d97ede033e4f6c6bdd1c66fc82aa15e" title="_rmnotifynode" alt="" coords="311,56,415,83"/><area shape="rect" id="node7" href="devnode_8c.html#aac8f6f936a0ff6c16adc677622b226c4" title="rm_recursive" alt="" coords="314,107,411,133"/><area shape="rect" id="node9" href="devnode_8c.html#acc36eaba5eb854461ab3c0a4d146e9c9" title="_updateconnected Update the list of connected devices. " alt="" coords="299,157,427,184"/></map>
</div>
</p>

<p><div id="dynsection-7" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-7-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-7-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-7-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a8732b3ade76da4ae362996232ef95431_icgraph.png" border="0" usemap="#usb_8c_a8732b3ade76da4ae362996232ef95431_icgraph" alt=""/></div>
<map name="usb_8c_a8732b3ade76da4ae362996232ef95431_icgraph" id="usb_8c_a8732b3ade76da4ae362996232ef95431_icgraph">
<area shape="rect" id="node2" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="263,81,345,108"/><area shape="rect" id="node11" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . " alt="" coords="129,56,199,83"/><area shape="rect" id="node12" href="main_8c.html#a24a012c29e291fef5fa13f4a07fffd33" title="quitWithLock " alt="" coords="652,157,751,184"/><area shape="rect" id="node15" href="usb__linux_8c.html#adeffaa2b04d01b15c8623255719420ef" title="usb_rm_device find the usb port to remove and close it via closeusb(). " alt="" coords="249,5,359,32"/><area shape="rect" id="node3" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="408,81,483,108"/><area shape="rect" id="node4" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="531,81,595,108"/><area shape="rect" id="node5" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="643,81,759,108"/><area shape="rect" id="node6" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="809,107,898,133"/><area shape="rect" id="node7" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="953,56,1023,83"/><area shape="rect" id="node8" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1077,132,1128,159"/><area shape="rect" id="node9" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1176,132,1235,159"/><area shape="rect" id="node10" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1283,132,1373,159"/><area shape="rect" id="node13" href="main_8c.html#acd1527386a48875050e637e4bb872f11" title="quit Stop working the daemon. function is called if the daemon received a sigterm In this case..." alt="" coords="832,157,875,184"/><area shape="rect" id="node14" href="main_8c.html#a05f9b9989842b986a26caf9e4c66a4c7" title="sighandler" alt="" coords="947,107,1029,133"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab8c22b4f7012c6d9fe1a0d5e2a93df65"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void* devmain </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>devmain is called by _setupusb </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">kb</td><td>the pointer to the device. Even if it has the name kb, it is valid also for a mouse (the whole driver seems to be implemented first for a keyboard). </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>always a nullptr</dd></dl>
<h1>Synchronization</h1>
<p>The syncing via mutexes is interesting:</p>
<ol type="1">
<li><em>imutex</em> (the Input mutex)<br/>
This one is locked in <code><a class="el" href="usb_8c.html#a1ab9d61dd894466125283465201161cd">setupusb()</a></code>. That function does only two things: Locking the mutex and trying to start a thread at <code><a class="el" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . ">_setupusb()</a></code>. <a class="el" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . ">_setupusb()</a> unlocks <em>imutex</em> after getting some buffers and initalizing internal structures from the indicators (this function often gets problems with error messages like "unable to read indicators" or "Timeout bla blubb"). <dl class="section warning"><dt>Warning</dt><dd>have a look at <em>updateindicators()</em> later. </dd>
<dd>
if creating the thread is not successful, the <em>imutex</em> remains blocked. Have a look at <a class="el" href="usb_8c.html#a1ab9d61dd894466125283465201161cd">setupusb()</a> later.</dd></dl>
</li>
<li><em>dmutex</em> (the Device mutex)<br/>
This one is very interesting, because it is handled in <a class="el" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . ">devmain()</a>. It seems that it is locked only in <em><a class="el" href="input__linux_8c.html#a5d40cc9137eaefbc2d860fac76020460">_ledthread()</a></em>, which is a thread created in <em><a class="el" href="input_8h.html#a081bbacaa312d4a1a63bc1cab5d3520f">os_setupindicators()</a></em>. <a class="el" href="input_8h.html#a081bbacaa312d4a1a63bc1cab5d3520f">os_setupindicators()</a> again is called in <em><a class="el" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . ">_setupusb()</a></em> long before calling <a class="el" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . ">devmain()</a>. So this mutex is locked when we start the function as the old comment says.<br/>
Before reading from the FIFO and direct afterwards an unlock..lock sequence is implemented here. Even if only the function <a class="el" href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7">readlines()</a> should be surrounded by the unlock..lock, the variable definition of the line pointer is also included here. Not nice, but does not bother either. Probably the Unlock..lock is needed so that now another process can change the control structure <em>linectx</em> while we wait in <a class="el" href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7">readlines()</a>. <dl class="todo"><dt><b><a class="el" href="todo.html#_todo000006">Todo:</a></b></dt><dd>Hope to find the need for dmutex usage later. <br/>
 Should this function be declared as pthread_t* function, because of the defintion of pthread-create? But void* works also... </dd></dl>
</li>
</ol>
<dl class="section attention"><dt>Attention</dt><dd>dmutex should still be locked when this is called</dd></dl>
<p>First a <em>readlines_ctx</em> buffer structure is initialized by <code><a class="el" href="devnode_8c.html#ac118005c75badc2028b4921be8d9bdd0">readlines_ctx_init()</a></code>.</p>
<p>After some setup functions, beginning in <a class="el" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . ">_setupusb()</a> which has called <a class="el" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . ">devmain()</a>, we read the command input-Fifo designated to that device in an endless loop. This loop has two possible exits (plus reaction to signals, not mentioned here).</p>
<p>If the reading via <a class="el" href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7">readlines()</a> is successful (we might have read multiple lines), the interpretation is done by <a class="el" href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9">readcmd()</a> iff the connection to the device is still available (checked via <a class="el" href="device_8h.html#abc841468973d04a23aad362c4387bc93">IS_CONNECTED(kb)</a>). This is true if the kb-structure has a handle and an event pointer both != Null). If not, the loop is left (the first exit point).</p>
<p>if nothing is in the line buffer (some magic interrupt?), continue in the endless while without any reaction.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000007">Todo:</a></b></dt><dd><a class="el" href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9">readcmd()</a> gets a <b>line</b>, not <b>lines</b>. Have a look on that later. <br/>
 Is the condition IS_CONNECTED valid? What functions change the condititon for the macro? </dd></dl>
<p>If interpretation and communication with the usb device got errors, they are signalled by <a class="el" href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9">readcmd()</a> (non zero retcode). In this case the usb device is closed via <a class="el" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431">closeusb()</a> and the endless loop is left (the second exit point).</p>
<p>After leaving the endless loop the readlines-ctx structure and its buffers are freed by <a class="el" href="devnode_8c.html#a588ab2c69fcb283a5beb90c49a165979">readlines_ctx_free()</a>. </p>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00135">135</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="usb_8c_source.html#l00677">closeusb()</a>, <a class="el" href="device_8h_source.html#l00018">dmutex</a>, <a class="el" href="structures_8h_source.html#l00225">usbdevice::infifo</a>, <a class="el" href="device_8h_source.html#l00012">IS_CONNECTED</a>, <a class="el" href="command_8c_source.html#l00068">readcmd()</a>, <a class="el" href="devnode_8c_source.html#l00353">readlines()</a>, <a class="el" href="devnode_8c_source.html#l00348">readlines_ctx_free()</a>, and <a class="el" href="devnode_8c_source.html#l00341">readlines_ctx_init()</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00214">_setupusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                                   {</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <span class="keywordtype">int</span> kbfifo = kb-&gt;<a class="code" href="structures_8h.html#a7d1cfa1502994290bd18f564a502e24f">infifo</a> - 1;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <a class="code" href="devnode_8c.html#struct__readlines__ctx">readlines_ctx</a> linectx;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <a class="code" href="devnode_8c.html#ac118005c75badc2028b4921be8d9bdd0">readlines_ctx_init</a>(&amp;linectx);</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordflow">while</span>(1){</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        pthread_mutex_unlock(<a class="code" href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a>(kb));</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <span class="comment">// Read from FIFO</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span>* line;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <span class="keywordtype">int</span> lines = <a class="code" href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7">readlines</a>(kbfifo, linectx, &amp;line);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        pthread_mutex_lock(<a class="code" href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a>(kb));</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="comment">// End thread when the handle is removed</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="keywordflow">if</span>(!<a class="code" href="device_8h.html#abc841468973d04a23aad362c4387bc93">IS_CONNECTED</a>(kb))</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="keywordflow">if</span>(lines){</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9">readcmd</a>(kb, line)){</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                <span class="comment">// USB transfer failed; destroy device</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                <a class="code" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431">closeusb</a>(kb);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            }</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        }</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    }</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    pthread_mutex_unlock(<a class="code" href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a>(kb));</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <a class="code" href="devnode_8c.html#a588ab2c69fcb283a5beb90c49a165979">readlines_ctx_free</a>(linectx);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;}</div>
<div class="ttc" id="device_8h_html_abc841468973d04a23aad362c4387bc93"><div class="ttname"><a href="device_8h.html#abc841468973d04a23aad362c4387bc93">IS_CONNECTED</a></div><div class="ttdeci">#define IS_CONNECTED(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00012">device.h:12</a></div></div>
<div class="ttc" id="command_8c_html_ad7239680e0942b0b85a6cd3e9fff25a9"><div class="ttname"><a href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9">readcmd</a></div><div class="ttdeci">int readcmd(usbdevice *kb, const char *line)</div><div class="ttdef"><b>Definition:</b> <a href="command_8c_source.html#l00068">command.c:68</a></div></div>
<div class="ttc" id="devnode_8c_html_a1062ed70d4ea0310fbf5eeee928b58b7"><div class="ttname"><a href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7">readlines</a></div><div class="ttdeci">unsigned readlines(int fd, readlines_ctx ctx, const char **input)</div><div class="ttdef"><b>Definition:</b> <a href="devnode_8c_source.html#l00353">devnode.c:353</a></div></div>
<div class="ttc" id="structures_8h_html_a7d1cfa1502994290bd18f564a502e24f"><div class="ttname"><a href="structures_8h.html#a7d1cfa1502994290bd18f564a502e24f">usbdevice::infifo</a></div><div class="ttdeci">int infifo</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00225">structures.h:225</a></div></div>
<div class="ttc" id="devnode_8c_html_ac118005c75badc2028b4921be8d9bdd0"><div class="ttname"><a href="devnode_8c.html#ac118005c75badc2028b4921be8d9bdd0">readlines_ctx_init</a></div><div class="ttdeci">void readlines_ctx_init(readlines_ctx *ctx)</div><div class="ttdef"><b>Definition:</b> <a href="devnode_8c_source.html#l00341">devnode.c:341</a></div></div>
<div class="ttc" id="usb_8c_html_a8732b3ade76da4ae362996232ef95431"><div class="ttname"><a href="usb_8c.html#a8732b3ade76da4ae362996232ef95431">closeusb</a></div><div class="ttdeci">int closeusb(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00677">usb.c:677</a></div></div>
<div class="ttc" id="devnode_8c_html_struct__readlines__ctx"><div class="ttname"><a href="devnode_8c.html#struct__readlines__ctx">_readlines_ctx</a></div><div class="ttdef"><b>Definition:</b> <a href="devnode_8c_source.html#l00335">devnode.c:335</a></div></div>
<div class="ttc" id="device_8h_html_a96bbdd939f65eebc392e07d74e6e6605"><div class="ttname"><a href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a></div><div class="ttdeci">#define dmutex(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00018">device.h:18</a></div></div>
<div class="ttc" id="devnode_8c_html_a588ab2c69fcb283a5beb90c49a165979"><div class="ttname"><a href="devnode_8c.html#a588ab2c69fcb283a5beb90c49a165979">readlines_ctx_free</a></div><div class="ttdeci">void readlines_ctx_free(readlines_ctx ctx)</div><div class="ttdef"><b>Definition:</b> <a href="devnode_8c_source.html#l00348">devnode.c:348</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-8" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-8-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-8-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-8-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_ab8c22b4f7012c6d9fe1a0d5e2a93df65_cgraph.png" border="0" usemap="#usb_8c_ab8c22b4f7012c6d9fe1a0d5e2a93df65_cgraph" alt=""/></div>
<map name="usb_8c_ab8c22b4f7012c6d9fe1a0d5e2a93df65_cgraph" id="usb_8c_ab8c22b4f7012c6d9fe1a0d5e2a93df65_cgraph">
<area shape="rect" id="node2" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431" title="closeusb" alt="" coords="152,107,227,133"/><area shape="rect" id="node11" href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9" title="readcmd" alt="" coords="153,208,225,235"/><area shape="rect" id="node15" href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7" title="readlines" alt="" coords="152,259,227,285"/><area shape="rect" id="node16" href="devnode_8c.html#a588ab2c69fcb283a5beb90c49a165979" title="readlines_ctx_free" alt="" coords="125,309,253,336"/><area shape="rect" id="node17" href="devnode_8c.html#ac118005c75badc2028b4921be8d9bdd0" title="readlines_ctx_init" alt="" coords="128,360,251,387"/><area shape="rect" id="node3" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb unclaim it, destroy the udev device and clear data structures at kb " alt="" coords="315,56,410,83"/><area shape="rect" id="node5" href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a" title="os_inputclose" alt="" coords="311,157,414,184"/><area shape="rect" id="node6" href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f" title="Remove the dev path for the keyboard at index. Returns 0 on success. " alt="" coords="321,107,404,133"/><area shape="rect" id="node9" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. " alt="" coords="302,5,423,32"/><area shape="rect" id="node4" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="492,56,580,83"/><area shape="rect" id="node7" href="devnode_8c.html#a9d97ede033e4f6c6bdd1c66fc82aa15e" title="_rmnotifynode" alt="" coords="484,183,588,209"/><area shape="rect" id="node8" href="devnode_8c.html#aac8f6f936a0ff6c16adc677622b226c4" title="rm_recursive" alt="" coords="487,107,585,133"/><area shape="rect" id="node10" href="devnode_8c.html#acc36eaba5eb854461ab3c0a4d146e9c9" title="_updateconnected Update the list of connected devices. " alt="" coords="472,5,600,32"/><area shape="rect" id="node12" href="devnode_8c.html#a981305884de053a41d337efac23900ec" title="Creates a notification node for the specified keyboard. " alt="" coords="313,259,413,285"/><area shape="rect" id="node14" href="devnode_8c.html#a40e40a8ea3edccbfd8fdfefc44a76206" title="Removes a notification node for the specified keyboard. " alt="" coords="314,208,411,235"/><area shape="rect" id="node13" href="devnode_8c.html#a38fcf6ff044f9249ae04234340ee8e7b" title="_mknotifynode" alt="" coords="483,259,589,285"/></map>
</div>
</p>

<p><div id="dynsection-9" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-9-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-9-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-9-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_ab8c22b4f7012c6d9fe1a0d5e2a93df65_icgraph.png" border="0" usemap="#usb_8c_ab8c22b4f7012c6d9fe1a0d5e2a93df65_icgraph" alt=""/></div>
<map name="usb_8c_ab8c22b4f7012c6d9fe1a0d5e2a93df65_icgraph" id="usb_8c_ab8c22b4f7012c6d9fe1a0d5e2a93df65_icgraph">
<area shape="rect" id="node2" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="125,31,208,57"/><area shape="rect" id="node3" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="256,31,331,57"/><area shape="rect" id="node4" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="379,31,443,57"/><area shape="rect" id="node5" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="491,31,607,57"/><area shape="rect" id="node6" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="657,5,746,32"/><area shape="rect" id="node7" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="795,31,866,57"/><area shape="rect" id="node8" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="915,31,965,57"/><area shape="rect" id="node9" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1013,31,1072,57"/><area shape="rect" id="node10" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1120,31,1211,57"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a25ded61622ec9349905b5aa2ed2cb48b"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static const <a class="el" href="command_8h.html#uniondevcmd">devcmd</a>* get_vtable </td>
          <td>(</td>
          <td class="paramtype">short&#160;</td>
          <td class="paramname"><em>vendor</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short&#160;</td>
          <td class="paramname"><em>product</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>get_vtable returns the correct vtable pointer </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">vendor</td><td>short usb vendor ID </td></tr>
    <tr><td class="paramname">product</td><td>short usb product ID </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Depending on the type and model, the corresponding vtable pointer is returned (see below)</dd></dl>
<p>At present, we have three different vtables:</p>
<ul>
<li><code>vtable_mouse</code> is used for all mouse types. This may be wrong with some newer mice?</li>
<li><code>vtable_keyboard</code> is used for all RGB Keyboards.</li>
<li><code>vtable_keyboard_nonrgb</code> for all the rest.</li>
</ul>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd>Is the last point really a good decision and always correct? </dd></dl>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00102">102</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="usb_8h_source.html#l00141">IS_MOUSE</a>, <a class="el" href="usb_8h_source.html#l00124">IS_RGB</a>, <a class="el" href="device__vtable_8c_source.html#l00029">vtable_keyboard</a>, <a class="el" href="device__vtable_8c_source.html#l00076">vtable_keyboard_nonrgb</a>, and <a class="el" href="device__vtable_8c_source.html#l00123">vtable_mouse</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00214">_setupusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                                                            {</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="usb_8h.html#a9aa1b86ddc13dc886bb403fda7c72ee7">IS_MOUSE</a>(vendor, product) ? &amp;<a class="code" href="device__vtable_8c.html#afa8a83a5c15f4ccbfd482a84cac762cc">vtable_mouse</a> : <a class="code" href="usb_8h.html#ab8fdd4551fc9bedbcef101983ef0ef93">IS_RGB</a>(vendor, product) ? &amp;<a class="code" href="device__vtable_8c.html#a9a07bc0f7d10b19ccc5633d73281647a">vtable_keyboard</a> : &amp;<a class="code" href="device__vtable_8c.html#a6c0de1efba43f5790d2ad7e7cb285fc0">vtable_keyboard_nonrgb</a>;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;}</div>
<div class="ttc" id="usb_8h_html_ab8fdd4551fc9bedbcef101983ef0ef93"><div class="ttname"><a href="usb_8h.html#ab8fdd4551fc9bedbcef101983ef0ef93">IS_RGB</a></div><div class="ttdeci">#define IS_RGB(vendor, product)</div><div class="ttdoc">RGB vs non-RGB test (note: non-RGB Strafe is still considered &quot;RGB&quot; in that it shares the same protoc...</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00124">usb.h:124</a></div></div>
<div class="ttc" id="device__vtable_8c_html_afa8a83a5c15f4ccbfd482a84cac762cc"><div class="ttname"><a href="device__vtable_8c.html#afa8a83a5c15f4ccbfd482a84cac762cc">vtable_mouse</a></div><div class="ttdeci">const devcmd vtable_mouse</div><div class="ttdef"><b>Definition:</b> <a href="device__vtable_8c_source.html#l00123">device_vtable.c:123</a></div></div>
<div class="ttc" id="usb_8h_html_a9aa1b86ddc13dc886bb403fda7c72ee7"><div class="ttname"><a href="usb_8h.html#a9aa1b86ddc13dc886bb403fda7c72ee7">IS_MOUSE</a></div><div class="ttdeci">#define IS_MOUSE(vendor, product)</div><div class="ttdoc">Mouse vs keyboard test. </div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00141">usb.h:141</a></div></div>
<div class="ttc" id="device__vtable_8c_html_a9a07bc0f7d10b19ccc5633d73281647a"><div class="ttname"><a href="device__vtable_8c.html#a9a07bc0f7d10b19ccc5633d73281647a">vtable_keyboard</a></div><div class="ttdeci">const devcmd vtable_keyboard</div><div class="ttdoc">RGB keyboard vtable holds functions for each device type. </div><div class="ttdef"><b>Definition:</b> <a href="device__vtable_8c_source.html#l00029">device_vtable.c:29</a></div></div>
<div class="ttc" id="device__vtable_8c_html_a6c0de1efba43f5790d2ad7e7cb285fc0"><div class="ttname"><a href="device__vtable_8c.html#a6c0de1efba43f5790d2ad7e7cb285fc0">vtable_keyboard_nonrgb</a></div><div class="ttdeci">const devcmd vtable_keyboard_nonrgb</div><div class="ttdef"><b>Definition:</b> <a href="device__vtable_8c_source.html#l00076">device_vtable.c:76</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-10" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-10-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-10-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-10-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a25ded61622ec9349905b5aa2ed2cb48b_icgraph.png" border="0" usemap="#usb_8c_a25ded61622ec9349905b5aa2ed2cb48b_icgraph" alt=""/></div>
<map name="usb_8c_a25ded61622ec9349905b5aa2ed2cb48b_icgraph" id="usb_8c_a25ded61622ec9349905b5aa2ed2cb48b_icgraph">
<area shape="rect" id="node2" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="136,31,219,57"/><area shape="rect" id="node3" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="267,31,341,57"/><area shape="rect" id="node4" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="389,31,453,57"/><area shape="rect" id="node5" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="502,31,618,57"/><area shape="rect" id="node6" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="667,5,757,32"/><area shape="rect" id="node7" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="806,31,877,57"/><area shape="rect" id="node8" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="925,31,976,57"/><area shape="rect" id="node9" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1024,31,1083,57"/><area shape="rect" id="node10" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1131,31,1221,57"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af87f830e031d8f63d2d1c3fc14fdad20"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* product_str </td>
          <td>(</td>
          <td class="paramtype">short&#160;</td>
          <td class="paramname"><em>product</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>product_str returns a condensed view on what type of device we have.</p>
<p>At present, various models and their properties are known from corsair products. Some models differ in principle (mice and keyboards), others differ in the way they function (for example, RGB and non RGB), but they are very similar.</p>
<p>Here, only the first point is taken into consideration and we return a unified model string. If the model is not known with its number, <em>product_str</em> returns an empty string.</p>
<p>The model numbers and corresponding strings wwith the numbers in hex-string are defined in <code><a class="el" href="usb_8h.html" title="Definitions for using USB interface. ">usb.h</a></code> </p>
<p>At present, this function is used to initialize <code>kb-&gt;name</code> and to give information in debug strings.</p>
<dl class="section attention"><dt>Attention</dt><dd>The combinations below have to fit to the combinations in the macros mentioned above. So if you add a device with a new number, change both.</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000004">Todo:</a></b></dt><dd>There are macros defined in <a class="el" href="usb_8h.html" title="Definitions for using USB interface. ">usb.h</a> to detect all the combinations below. the only difference is the parameter: The macros need the <em>kb*</em>, <a class="el" href="usb_8h.html#af87f830e031d8f63d2d1c3fc14fdad20" title="product_str returns a condensed view on what type of device we have. ">product_str()</a> needs the <em>product</em> <em>ID</em> </dd></dl>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00070">70</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="usb_8h_source.html#l00041">P_K65</a>, <a class="el" href="usb_8h_source.html#l00045">P_K65_LUX</a>, <a class="el" href="usb_8h_source.html#l00043">P_K65_NRGB</a>, <a class="el" href="usb_8h_source.html#l00047">P_K65_RFIRE</a>, <a class="el" href="usb_8h_source.html#l00051">P_K70</a>, <a class="el" href="usb_8h_source.html#l00055">P_K70_LUX</a>, <a class="el" href="usb_8h_source.html#l00057">P_K70_LUX_NRGB</a>, <a class="el" href="usb_8h_source.html#l00053">P_K70_NRGB</a>, <a class="el" href="usb_8h_source.html#l00059">P_K70_RFIRE</a>, <a class="el" href="usb_8h_source.html#l00061">P_K70_RFIRE_NRGB</a>, <a class="el" href="usb_8h_source.html#l00065">P_K95</a>, <a class="el" href="usb_8h_source.html#l00067">P_K95_NRGB</a>, <a class="el" href="usb_8h_source.html#l00069">P_K95_PLATINUM</a>, <a class="el" href="usb_8h_source.html#l00079">P_M65</a>, <a class="el" href="usb_8h_source.html#l00081">P_M65_PRO</a>, <a class="el" href="usb_8h_source.html#l00087">P_SABRE_L</a>, <a class="el" href="usb_8h_source.html#l00089">P_SABRE_N</a>, <a class="el" href="usb_8h_source.html#l00085">P_SABRE_O</a>, <a class="el" href="usb_8h_source.html#l00091">P_SABRE_O2</a>, <a class="el" href="usb_8h_source.html#l00095">P_SCIMITAR</a>, <a class="el" href="usb_8h_source.html#l00097">P_SCIMITAR_PRO</a>, <a class="el" href="usb_8h_source.html#l00073">P_STRAFE</a>, and <a class="el" href="usb_8h_source.html#l00075">P_STRAFE_NRGB</a>.</p>

<p>Referenced by <a class="el" href="devnode_8c_source.html#l00136">_mkdevpath()</a>, and <a class="el" href="usb_8c_source.html#l00214">_setupusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;                                      {</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="keywordflow">if</span>(product == <a class="code" href="usb_8h.html#a5f5e9b029c7eec8f6c491d73f0499bb5">P_K95</a> || product == <a class="code" href="usb_8h.html#ae8d1cf4b55023aae2b72ee607e214f84">P_K95_NRGB</a> || product == <a class="code" href="usb_8h.html#ab034dbd57f7ab5666729ce7e27d3e0b9">P_K95_PLATINUM</a>)</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&quot;k95&quot;</span>;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keywordflow">if</span>(product == <a class="code" href="usb_8h.html#a3133fa57f7b2d7c888ffafeadc4476ab">P_K70</a> || product == <a class="code" href="usb_8h.html#a7fea7ba58b4bb6a7def7c380ab695110">P_K70_NRGB</a> || product == <a class="code" href="usb_8h.html#a3fc42f14fec81381ff8251ca6a85b363">P_K70_LUX</a> || product == <a class="code" href="usb_8h.html#aa0f89f20ca96ad159330a8d071a45352">P_K70_LUX_NRGB</a> || product == <a class="code" href="usb_8h.html#a07e80868f8a95b9f8a2e85636833d45d">P_K70_RFIRE</a> || product == <a class="code" href="usb_8h.html#abb58ca12d172afdf2b5469266c0c9af8">P_K70_RFIRE_NRGB</a>)</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&quot;k70&quot;</span>;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keywordflow">if</span>(product == <a class="code" href="usb_8h.html#affc75c5e028c467b9a294360b8a66a17">P_K65</a> || product == <a class="code" href="usb_8h.html#a300ce7bf9091c9da9ebcb83600f13faa">P_K65_NRGB</a> || product == <a class="code" href="usb_8h.html#a976d0683dbfa2225bf40016d151f70d3">P_K65_LUX</a> || product == <a class="code" href="usb_8h.html#ae6a26ad33235021f82ada9c503e5661a">P_K65_RFIRE</a>)</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&quot;k65&quot;</span>;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keywordflow">if</span>(product == <a class="code" href="usb_8h.html#a26adb1ffc39cb46e583a236b14af9ace">P_STRAFE</a> || product == <a class="code" href="usb_8h.html#a3e6f75a59f49265384d17e5d65b054e0">P_STRAFE_NRGB</a>)</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&quot;strafe&quot;</span>;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keywordflow">if</span>(product == <a class="code" href="usb_8h.html#a26cd43fb89a7329b7043cb962a12383b">P_M65</a> || product == <a class="code" href="usb_8h.html#a427ec77ae3e03646e7ac0a66516d39cb">P_M65_PRO</a>)</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&quot;m65&quot;</span>;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keywordflow">if</span>(product == <a class="code" href="usb_8h.html#a0aa0f45f25df01bcee4abc96455e1138">P_SABRE_O</a> || product == <a class="code" href="usb_8h.html#a73e75008beef075e40fa5195d9c70bfe">P_SABRE_L</a> || product == <a class="code" href="usb_8h.html#a5b8bcefef6848c2e7889ecda124c8192">P_SABRE_N</a> || product == <a class="code" href="usb_8h.html#a294da39a7f6b6d23ff74b170b9423b4e">P_SABRE_O2</a>)</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&quot;sabre&quot;</span>;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="keywordflow">if</span>(product == <a class="code" href="usb_8h.html#af8ce90b65c8c9756870acd26a24054fc">P_SCIMITAR</a> || product == <a class="code" href="usb_8h.html#ab76215820c9c39d5438ed28b4e8d8110">P_SCIMITAR_PRO</a>)</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&quot;scimitar&quot;</span>;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;}</div>
<div class="ttc" id="usb_8h_html_abb58ca12d172afdf2b5469266c0c9af8"><div class="ttname"><a href="usb_8h.html#abb58ca12d172afdf2b5469266c0c9af8">P_K70_RFIRE_NRGB</a></div><div class="ttdeci">#define P_K70_RFIRE_NRGB</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00061">usb.h:61</a></div></div>
<div class="ttc" id="usb_8h_html_ab034dbd57f7ab5666729ce7e27d3e0b9"><div class="ttname"><a href="usb_8h.html#ab034dbd57f7ab5666729ce7e27d3e0b9">P_K95_PLATINUM</a></div><div class="ttdeci">#define P_K95_PLATINUM</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00069">usb.h:69</a></div></div>
<div class="ttc" id="usb_8h_html_a976d0683dbfa2225bf40016d151f70d3"><div class="ttname"><a href="usb_8h.html#a976d0683dbfa2225bf40016d151f70d3">P_K65_LUX</a></div><div class="ttdeci">#define P_K65_LUX</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00045">usb.h:45</a></div></div>
<div class="ttc" id="usb_8h_html_a5f5e9b029c7eec8f6c491d73f0499bb5"><div class="ttname"><a href="usb_8h.html#a5f5e9b029c7eec8f6c491d73f0499bb5">P_K95</a></div><div class="ttdeci">#define P_K95</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00065">usb.h:65</a></div></div>
<div class="ttc" id="usb_8h_html_a5b8bcefef6848c2e7889ecda124c8192"><div class="ttname"><a href="usb_8h.html#a5b8bcefef6848c2e7889ecda124c8192">P_SABRE_N</a></div><div class="ttdeci">#define P_SABRE_N</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00089">usb.h:89</a></div></div>
<div class="ttc" id="usb_8h_html_a0aa0f45f25df01bcee4abc96455e1138"><div class="ttname"><a href="usb_8h.html#a0aa0f45f25df01bcee4abc96455e1138">P_SABRE_O</a></div><div class="ttdeci">#define P_SABRE_O</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00085">usb.h:85</a></div></div>
<div class="ttc" id="usb_8h_html_affc75c5e028c467b9a294360b8a66a17"><div class="ttname"><a href="usb_8h.html#affc75c5e028c467b9a294360b8a66a17">P_K65</a></div><div class="ttdeci">#define P_K65</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00041">usb.h:41</a></div></div>
<div class="ttc" id="usb_8h_html_a7fea7ba58b4bb6a7def7c380ab695110"><div class="ttname"><a href="usb_8h.html#a7fea7ba58b4bb6a7def7c380ab695110">P_K70_NRGB</a></div><div class="ttdeci">#define P_K70_NRGB</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00053">usb.h:53</a></div></div>
<div class="ttc" id="usb_8h_html_a26cd43fb89a7329b7043cb962a12383b"><div class="ttname"><a href="usb_8h.html#a26cd43fb89a7329b7043cb962a12383b">P_M65</a></div><div class="ttdeci">#define P_M65</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00079">usb.h:79</a></div></div>
<div class="ttc" id="usb_8h_html_a26adb1ffc39cb46e583a236b14af9ace"><div class="ttname"><a href="usb_8h.html#a26adb1ffc39cb46e583a236b14af9ace">P_STRAFE</a></div><div class="ttdeci">#define P_STRAFE</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00073">usb.h:73</a></div></div>
<div class="ttc" id="usb_8h_html_a73e75008beef075e40fa5195d9c70bfe"><div class="ttname"><a href="usb_8h.html#a73e75008beef075e40fa5195d9c70bfe">P_SABRE_L</a></div><div class="ttdeci">#define P_SABRE_L</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00087">usb.h:87</a></div></div>
<div class="ttc" id="usb_8h_html_a427ec77ae3e03646e7ac0a66516d39cb"><div class="ttname"><a href="usb_8h.html#a427ec77ae3e03646e7ac0a66516d39cb">P_M65_PRO</a></div><div class="ttdeci">#define P_M65_PRO</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00081">usb.h:81</a></div></div>
<div class="ttc" id="usb_8h_html_a07e80868f8a95b9f8a2e85636833d45d"><div class="ttname"><a href="usb_8h.html#a07e80868f8a95b9f8a2e85636833d45d">P_K70_RFIRE</a></div><div class="ttdeci">#define P_K70_RFIRE</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00059">usb.h:59</a></div></div>
<div class="ttc" id="usb_8h_html_a300ce7bf9091c9da9ebcb83600f13faa"><div class="ttname"><a href="usb_8h.html#a300ce7bf9091c9da9ebcb83600f13faa">P_K65_NRGB</a></div><div class="ttdeci">#define P_K65_NRGB</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00043">usb.h:43</a></div></div>
<div class="ttc" id="usb_8h_html_ab76215820c9c39d5438ed28b4e8d8110"><div class="ttname"><a href="usb_8h.html#ab76215820c9c39d5438ed28b4e8d8110">P_SCIMITAR_PRO</a></div><div class="ttdeci">#define P_SCIMITAR_PRO</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00097">usb.h:97</a></div></div>
<div class="ttc" id="usb_8h_html_a3133fa57f7b2d7c888ffafeadc4476ab"><div class="ttname"><a href="usb_8h.html#a3133fa57f7b2d7c888ffafeadc4476ab">P_K70</a></div><div class="ttdeci">#define P_K70</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00051">usb.h:51</a></div></div>
<div class="ttc" id="usb_8h_html_ae8d1cf4b55023aae2b72ee607e214f84"><div class="ttname"><a href="usb_8h.html#ae8d1cf4b55023aae2b72ee607e214f84">P_K95_NRGB</a></div><div class="ttdeci">#define P_K95_NRGB</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00067">usb.h:67</a></div></div>
<div class="ttc" id="usb_8h_html_a294da39a7f6b6d23ff74b170b9423b4e"><div class="ttname"><a href="usb_8h.html#a294da39a7f6b6d23ff74b170b9423b4e">P_SABRE_O2</a></div><div class="ttdeci">#define P_SABRE_O2</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00091">usb.h:91</a></div></div>
<div class="ttc" id="usb_8h_html_a3e6f75a59f49265384d17e5d65b054e0"><div class="ttname"><a href="usb_8h.html#a3e6f75a59f49265384d17e5d65b054e0">P_STRAFE_NRGB</a></div><div class="ttdeci">#define P_STRAFE_NRGB</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00075">usb.h:75</a></div></div>
<div class="ttc" id="usb_8h_html_a3fc42f14fec81381ff8251ca6a85b363"><div class="ttname"><a href="usb_8h.html#a3fc42f14fec81381ff8251ca6a85b363">P_K70_LUX</a></div><div class="ttdeci">#define P_K70_LUX</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00055">usb.h:55</a></div></div>
<div class="ttc" id="usb_8h_html_aa0f89f20ca96ad159330a8d071a45352"><div class="ttname"><a href="usb_8h.html#aa0f89f20ca96ad159330a8d071a45352">P_K70_LUX_NRGB</a></div><div class="ttdeci">#define P_K70_LUX_NRGB</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00057">usb.h:57</a></div></div>
<div class="ttc" id="usb_8h_html_af8ce90b65c8c9756870acd26a24054fc"><div class="ttname"><a href="usb_8h.html#af8ce90b65c8c9756870acd26a24054fc">P_SCIMITAR</a></div><div class="ttdeci">#define P_SCIMITAR</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00095">usb.h:95</a></div></div>
<div class="ttc" id="usb_8h_html_ae6a26ad33235021f82ada9c503e5661a"><div class="ttname"><a href="usb_8h.html#ae6a26ad33235021f82ada9c503e5661a">P_K65_RFIRE</a></div><div class="ttdeci">#define P_K65_RFIRE</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00047">usb.h:47</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-11" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-11-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-11-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-11-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_af87f830e031d8f63d2d1c3fc14fdad20_icgraph.png" border="0" usemap="#usb_8c_af87f830e031d8f63d2d1c3fc14fdad20_icgraph" alt=""/></div>
<map name="usb_8c_af87f830e031d8f63d2d1c3fc14fdad20_icgraph" id="usb_8c_af87f830e031d8f63d2d1c3fc14fdad20_icgraph">
<area shape="rect" id="node2" href="devnode_8c.html#a81c81014b2dfa89e326dd61769842953" title="_mkdevpath" alt="" coords="141,5,235,32"/><area shape="rect" id="node4" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="419,56,501,83"/><area shape="rect" id="node3" href="devnode_8h.html#a0c3d1e3cd90f43a9b5ee0793f4a75041" title="Create a dev path for the keyboard at index. Returns 0 on success. " alt="" coords="283,5,370,32"/><area shape="rect" id="node10" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1208,31,1259,57"/><area shape="rect" id="node5" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="549,56,624,83"/><area shape="rect" id="node6" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="672,56,736,83"/><area shape="rect" id="node7" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="785,56,901,83"/><area shape="rect" id="node8" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="950,56,1039,83"/><area shape="rect" id="node9" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="1089,56,1159,83"/><area shape="rect" id="node11" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1307,31,1365,57"/><area shape="rect" id="node12" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1413,31,1504,57"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae30a52968bb209e98461f48ffb2ee82f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int revertusb </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>revertusb sets a given device to inactive (hardware controlled) mode if not a fw-ugrade is indicated</p>
<p>First is checked, whether a firmware-upgrade is indicated for the device. If so, <a class="el" href="usb_8h.html#ae30a52968bb209e98461f48ffb2ee82f" title="revertusb sets a given device to inactive (hardware controlled) mode if not a fw-ugrade is indicated ...">revertusb()</a> returns 0. </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000008">Todo:</a></b></dt><dd>Why is this useful? Are there problems seen with deactivating a device with older fw-version??? Why isn't this an error indicating reason and we return success (0)?</dd></dl>
<p>Anyway, the following steps are similar to some other procs, dealing with low level usb handling:</p>
<ul>
<li>If we do not have an RGB device, a simple setting to Hardware-mode (NK95_HWON) is sent to the device via n95cmd(). <dl class="todo"><dt><b><a class="el" href="todo.html#_todo000009">Todo:</a></b></dt><dd>The return value of <a class="el" href="usb_8h.html#aefc95e6120686dff0e06bba32ca21ad1" title="nk95cmd() macro is used to wrap _nk95cmd() with debugging information (file and lineno). the command structure is different:   Just the bits 23..16 are used as bits 7..0 for bRequest   Bits 15..0 are used as wValue ">nk95cmd()</a> is ignored (but sending the ioctl may produce an error and _nk95_cmd will indicate this), instead <a class="el" href="usb_8h.html#ae30a52968bb209e98461f48ffb2ee82f" title="revertusb sets a given device to inactive (hardware controlled) mode if not a fw-ugrade is indicated ...">revertusb()</a> returns success in any case.</dd></dl>
</li>
<li>If we have an RGB device, <a class="el" href="device_8h.html#afc841d1137ff44e8a225208262d97fae" title="setactive() calls via the corresponding kb-&gt;vtable either the active() or the idle() function...">setactive()</a> is called with second param active = false. That function will have a look on differences between keyboards and mice. <br/>
 More precisely <a class="el" href="device_8h.html#afc841d1137ff44e8a225208262d97fae" title="setactive() calls via the corresponding kb-&gt;vtable either the active() or the idle() function...">setactive()</a> is just a macro to call via the kb-&gt;vtable enties either the active() or the idle() function where the vtable points to. <a class="el" href="device_8h.html#afc841d1137ff44e8a225208262d97fae" title="setactive() calls via the corresponding kb-&gt;vtable either the active() or the idle() function...">setactive()</a> may return error indications. If so, <a class="el" href="usb_8h.html#ae30a52968bb209e98461f48ffb2ee82f" title="revertusb sets a given device to inactive (hardware controlled) mode if not a fw-ugrade is indicated ...">revertusb()</a> returns -1, otherwise 0 in any other case. </li>
</ul>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00407">407</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="structures_8h_source.html#l00136">FEAT_RGB</a>, <a class="el" href="structures_8h_source.html#l00157">HAS_FEATURES</a>, <a class="el" href="structures_8h_source.html#l00161">NEEDS_FW_UPDATE</a>, <a class="el" href="usb_8h_source.html#l00304">NK95_HWON</a>, <a class="el" href="usb_8h_source.html#l00296">nk95cmd</a>, and <a class="el" href="device_8h_source.html#l00044">setactive</a>.</p>

<p>Referenced by <a class="el" href="main_8c_source.html#l00040">quitWithLock()</a>.</p>
<div class="fragment"><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                            {</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="structures_8h.html#ac041871a5605e5dbcd73c3671ef2a8bc">NEEDS_FW_UPDATE</a>(kb))</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="keywordflow">if</span>(!<a class="code" href="structures_8h.html#ac5ce9f3f886e327076d6fa5393e7aa69">HAS_FEATURES</a>(kb, <a class="code" href="structures_8h.html#ae84210929bc758f0da372e723d002f8e">FEAT_RGB</a>)){</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        <a class="code" href="usb_8h.html#aefc95e6120686dff0e06bba32ca21ad1">nk95cmd</a>(kb, <a class="code" href="usb_8h.html#af4d21ffe463251f15ed249be2531d8c7">NK95_HWON</a>);</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    }</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="device_8h.html#afc841d1137ff44e8a225208262d97fae">setactive</a>(kb, 0))</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;}</div>
<div class="ttc" id="usb_8h_html_aefc95e6120686dff0e06bba32ca21ad1"><div class="ttname"><a href="usb_8h.html#aefc95e6120686dff0e06bba32ca21ad1">nk95cmd</a></div><div class="ttdeci">#define nk95cmd(kb, command)</div><div class="ttdoc">nk95cmd() macro is used to wrap _nk95cmd() with debugging information (file and lineno). the command structure is different:   Just the bits 23..16 are used as bits 7..0 for bRequest   Bits 15..0 are used as wValue </div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00296">usb.h:296</a></div></div>
<div class="ttc" id="structures_8h_html_ae84210929bc758f0da372e723d002f8e"><div class="ttname"><a href="structures_8h.html#ae84210929bc758f0da372e723d002f8e">FEAT_RGB</a></div><div class="ttdeci">#define FEAT_RGB</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00136">structures.h:136</a></div></div>
<div class="ttc" id="usb_8h_html_af4d21ffe463251f15ed249be2531d8c7"><div class="ttname"><a href="usb_8h.html#af4d21ffe463251f15ed249be2531d8c7">NK95_HWON</a></div><div class="ttdeci">#define NK95_HWON</div><div class="ttdoc">Hardware playback on. </div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00304">usb.h:304</a></div></div>
<div class="ttc" id="structures_8h_html_ac041871a5605e5dbcd73c3671ef2a8bc"><div class="ttname"><a href="structures_8h.html#ac041871a5605e5dbcd73c3671ef2a8bc">NEEDS_FW_UPDATE</a></div><div class="ttdeci">#define NEEDS_FW_UPDATE(kb)</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00161">structures.h:161</a></div></div>
<div class="ttc" id="structures_8h_html_ac5ce9f3f886e327076d6fa5393e7aa69"><div class="ttname"><a href="structures_8h.html#ac5ce9f3f886e327076d6fa5393e7aa69">HAS_FEATURES</a></div><div class="ttdeci">#define HAS_FEATURES(kb, feat)</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00157">structures.h:157</a></div></div>
<div class="ttc" id="device_8h_html_afc841d1137ff44e8a225208262d97fae"><div class="ttname"><a href="device_8h.html#afc841d1137ff44e8a225208262d97fae">setactive</a></div><div class="ttdeci">#define setactive(kb, makeactive)</div><div class="ttdoc">setactive() calls via the corresponding kb-&gt;vtable either the active() or the idle() function...</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00044">device.h:44</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-12" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-12-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-12-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-12-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_ae30a52968bb209e98461f48ffb2ee82f_icgraph.png" border="0" usemap="#usb_8c_ae30a52968bb209e98461f48ffb2ee82f_icgraph" alt=""/></div>
<map name="usb_8c_ae30a52968bb209e98461f48ffb2ee82f_icgraph" id="usb_8c_ae30a52968bb209e98461f48ffb2ee82f_icgraph">
<area shape="rect" id="node2" href="main_8c.html#a24a012c29e291fef5fa13f4a07fffd33" title="quitWithLock " alt="" coords="131,47,229,74"/><area shape="rect" id="node3" href="main_8c.html#acd1527386a48875050e637e4bb872f11" title="quit Stop working the daemon. function is called if the daemon received a sigterm In this case..." alt="" coords="277,22,320,49"/><area shape="rect" id="node5" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="597,22,656,49"/><area shape="rect" id="node4" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="499,22,549,49"/><area shape="rect" id="node7" href="main_8c.html#a05f9b9989842b986a26caf9e4c66a4c7" title="sighandler" alt="" coords="369,22,450,49"/><area shape="rect" id="node6" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="704,22,795,49"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a1ab9d61dd894466125283465201161cd"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setupusb </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>setupusb starts a thread with kb as parameter and <a class="el" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . ">_setupusb()</a> as entrypoint.</p>
<p>Set up a USB device after its handle is open. Spawns a new thread <a class="el" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . ">_setupusb()</a> with standard parameter kb. dmutex must be locked prior to calling this function. The function will unlock it when finished. In kb-&gt;thread the thread id is mentioned, because <a class="el" href="usb_8h.html#a8732b3ade76da4ae362996232ef95431" title="closeusb Close a USB device and remove device entry. ">closeusb()</a> needs this info for joining that thread again. </p>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00386">386</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="usb_8c_source.html#l00214">_setupusb()</a>, <a class="el" href="includes_8h_source.html#l00049">ckb_err</a>, <a class="el" href="device_8h_source.html#l00022">imutex</a>, and <a class="el" href="structures_8h_source.html#l00217">usbdevice::thread</a>.</p>

<p>Referenced by <a class="el" href="usb__linux_8c_source.html#l00593">usbadd()</a>.</p>
<div class="fragment"><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                            {</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    pthread_mutex_lock(<a class="code" href="device_8h.html#aa87bd893f7d4bd0700cb699c88dd860b">imutex</a>(kb));</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordflow">if</span>(pthread_create(&amp;kb-&gt;<a class="code" href="structures_8h.html#a66ae3ceabd662fd1b7ee8352f303202c">thread</a>, 0, <a class="code" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac">_setupusb</a>, kb))</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <a class="code" href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a>(<span class="stringliteral">&quot;Failed to create USB thread\n&quot;</span>);</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;}</div>
<div class="ttc" id="includes_8h_html_a8312a1a42e03986afb7c76557f4d3e25"><div class="ttname"><a href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a></div><div class="ttdeci">#define ckb_err(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00049">includes.h:49</a></div></div>
<div class="ttc" id="usb_8c_html_a10ad381abfe51e67e341c882c92bb9ac"><div class="ttname"><a href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac">_setupusb</a></div><div class="ttdeci">static void * _setupusb(void *context)</div><div class="ttdoc">brief . </div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00214">usb.c:214</a></div></div>
<div class="ttc" id="device_8h_html_aa87bd893f7d4bd0700cb699c88dd860b"><div class="ttname"><a href="device_8h.html#aa87bd893f7d4bd0700cb699c88dd860b">imutex</a></div><div class="ttdeci">#define imutex(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00022">device.h:22</a></div></div>
<div class="ttc" id="structures_8h_html_a66ae3ceabd662fd1b7ee8352f303202c"><div class="ttname"><a href="structures_8h.html#a66ae3ceabd662fd1b7ee8352f303202c">usbdevice::thread</a></div><div class="ttdeci">pthread_t thread</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00217">structures.h:217</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-13" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-13-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-13-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-13-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a1ab9d61dd894466125283465201161cd_cgraph.png" border="0" usemap="#usb_8c_a1ab9d61dd894466125283465201161cd_cgraph" alt=""/></div>
<map name="usb_8c_a1ab9d61dd894466125283465201161cd_cgraph" id="usb_8c_a1ab9d61dd894466125283465201161cd_cgraph">
<area shape="rect" id="node2" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="128,537,211,564"/><area shape="rect" id="node3" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431" title="closeusb" alt="" coords="472,119,547,145"/><area shape="rect" id="node10" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. " alt="" coords="631,5,753,32"/><area shape="rect" id="node12" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . " alt="" coords="289,271,359,297"/><area shape="rect" id="node20" href="usb_8c.html#a25ded61622ec9349905b5aa2ed2cb48b" title="brief . " alt="" coords="283,563,365,589"/><area shape="rect" id="node21" href="devnode_8c.html#a0c3d1e3cd90f43a9b5ee0793f4a75041" title="Create a dev path for the keyboard at index. Returns 0 on success. " alt="" coords="281,411,367,437"/><area shape="rect" id="node24" href="usb_8c.html#af87f830e031d8f63d2d1c3fc14fdad20" title="brief . " alt="" coords="649,512,735,539"/><area shape="rect" id="node25" href="usb_8c.html#a8e6389e8183a834fedb6ed317dd26f94" title="brief . " alt="" coords="651,563,733,589"/><area shape="rect" id="node26" href="usb_8h.html#a9e5784bfca2e4612f498ce67c7dab275" title="os_inputmain is run in a separate thread and will be detached from the main thread, so it needs to clean up its own resources. " alt="" coords="275,639,373,665"/><area shape="rect" id="node43" href="input_8h.html#ac73b3c2c38b916b901b4cca6b350a863" title="os_inputopen " alt="" coords="275,715,373,741"/><area shape="rect" id="node45" href="input_8h.html#a081bbacaa312d4a1a63bc1cab5d3520f" title="os_setupindicators" alt="" coords="259,816,389,843"/><area shape="rect" id="node47" href="usb_8h.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb OS&#45;specific setup for a specific usb device. " alt="" coords="276,929,372,956"/><area shape="rect" id="node49" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset" alt="" coords="462,1019,557,1045"/><area shape="rect" id="node4" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb unclaim it, destroy the udev device and clear data structures at kb " alt="" coords="645,107,739,133"/><area shape="rect" id="node6" href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a" title="os_inputclose" alt="" coords="641,56,743,83"/><area shape="rect" id="node7" href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f" title="Remove the dev path for the keyboard at index. Returns 0 on success. " alt="" coords="651,259,733,285"/><area shape="rect" id="node5" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="823,107,911,133"/><area shape="rect" id="node8" href="devnode_8c.html#a9d97ede033e4f6c6bdd1c66fc82aa15e" title="_rmnotifynode" alt="" coords="815,245,919,272"/><area shape="rect" id="node9" href="devnode_8c.html#aac8f6f936a0ff6c16adc677622b226c4" title="rm_recursive" alt="" coords="818,303,915,329"/><area shape="rect" id="node11" href="devnode_8c.html#acc36eaba5eb854461ab3c0a4d146e9c9" title="_updateconnected Update the list of connected devices. " alt="" coords="803,169,931,196"/><area shape="rect" id="node13" href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9" title="readcmd" alt="" coords="473,296,545,323"/><area shape="rect" id="node17" href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7" title="readlines" alt="" coords="472,347,547,373"/><area shape="rect" id="node18" href="devnode_8c.html#a588ab2c69fcb283a5beb90c49a165979" title="readlines_ctx_free" alt="" coords="445,195,573,221"/><area shape="rect" id="node19" href="devnode_8c.html#ac118005c75badc2028b4921be8d9bdd0" title="readlines_ctx_init" alt="" coords="448,245,571,272"/><area shape="rect" id="node14" href="devnode_8c.html#a981305884de053a41d337efac23900ec" title="Creates a notification node for the specified keyboard. " alt="" coords="642,360,742,387"/><area shape="rect" id="node16" href="devnode_8c.html#a40e40a8ea3edccbfd8fdfefc44a76206" title="Removes a notification node for the specified keyboard. " alt="" coords="643,157,741,184"/><area shape="rect" id="node15" href="devnode_8c.html#a38fcf6ff044f9249ae04234340ee8e7b" title="_mknotifynode" alt="" coords="813,411,920,437"/><area shape="rect" id="node22" href="devnode_8c.html#a81c81014b2dfa89e326dd61769842953" title="_mkdevpath" alt="" coords="463,411,556,437"/><area shape="rect" id="node23" href="devnode_8c.html#ad130425a617cf973b28603a72607a057" title="Writes a keyboard&#39;s firmware version and poll rate to its device node. " alt="" coords="651,411,733,437"/><area shape="rect" id="node27" href="keymap_8c.html#a092f675ff366b5823c73b25f83d513f9" title="hid_mouse_translate" alt="" coords="438,715,581,741"/><area shape="rect" id="node28" href="keymap_8c.html#a0dc9a16564cc51b35a35d28af1a96fb0" title="corsair_mousecopy" alt="" coords="442,765,577,792"/><area shape="rect" id="node29" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889" title="hid_kb_translate" alt="" coords="451,563,568,589"/><area shape="rect" id="node30" href="keymap_8c.html#ad39ede76abd657f5123fa331853db017" title="corsair_kbcopy" alt="" coords="454,613,565,640"/><area shape="rect" id="node31" href="input_8c.html#ae360d0b9a764a1d38c5be5464be8b70a" title="inputupdate" alt="" coords="465,664,554,691"/><area shape="rect" id="node32" href="input_8c.html#aed8e9842ed5750c1d328c5dc4c1ba2bd" title="inputupdate_keys Handle input from Keyboard or mouse; start Macrof if detected. " alt="" coords="630,639,754,665"/><area shape="rect" id="node42" href="input_8h.html#a9f2cfb2d883ae4a3732047fe3f3da683" title="os_mousemove" alt="" coords="988,816,1103,843"/><area shape="rect" id="node33" href="input_8c.html#a34b6a3d2e97732b6973cd608e35317c9" title="macro_pt_first returns the first pthread_id but does not remove the first entry. " alt="" coords="993,613,1098,640"/><area shape="rect" id="node34" href="input_8c.html#abd38419ce56379559481f51d9491adeb" title="macromask" alt="" coords="821,512,912,539"/><area shape="rect" id="node35" href="notify_8c.html#ac2411c0997dfdbefdebd45f2584a5d04" title="nprintkey" alt="" coords="829,563,904,589"/><area shape="rect" id="node37" href="input_8h.html#af0d3401f317f3214dadad7d1a3378c58" title="os_keypress" alt="" coords="997,664,1093,691"/><area shape="rect" id="node39" href="input_8c.html#a42ef48810461524270042eeda9616dba" title="play_macro is the code for all threads started to play a macro. " alt="" coords="822,715,911,741"/><area shape="rect" id="node36" href="notify_8c.html#a7ac88f15243030290e4d57c3c9ac7c98" title="nprintf" alt="" coords="1016,563,1075,589"/><area shape="rect" id="node38" href="input__linux_8c.html#a14ff0fdf147e3702197db2cadb878460" title="isync" alt="" coords="1160,740,1213,767"/><area shape="rect" id="node40" href="input_8c.html#a712ce5a59c9a281c4d4c4d0ba3446de7" title="macro_pt_dequeue gets the first thread id of the list and returns the thread_id stored in it..." alt="" coords="979,765,1111,792"/><area shape="rect" id="node41" href="input_8c.html#a225fb4bb1f20d4a8b524f5d72763367d" title="macro_pt_enqueue Save the new thread in the single linked list (FIFO). " alt="" coords="979,715,1111,741"/><area shape="rect" id="node44" href="input__linux_8c.html#a5f050529d49f8cb5e8dda4617c5984b7" title="uinputopen" alt="" coords="467,816,552,843"/><area shape="rect" id="node46" href="input__linux_8c.html#a5d40cc9137eaefbc2d860fac76020460" title="_ledthread" alt="" coords="468,867,551,893"/><area shape="rect" id="node48" href="usb__linux_8c.html#ab694a2ac859b16b5af802b4484f5ba0b" title="strtrim" alt="" coords="480,917,539,944"/><area shape="rect" id="node50" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626" title="usbclaim" alt="" coords="472,968,547,995"/></map>
</div>
</p>

<p><div id="dynsection-14" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-14-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-14-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-14-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a1ab9d61dd894466125283465201161cd_icgraph.png" border="0" usemap="#usb_8c_a1ab9d61dd894466125283465201161cd_icgraph" alt=""/></div>
<map name="usb_8c_a1ab9d61dd894466125283465201161cd_icgraph" id="usb_8c_a1ab9d61dd894466125283465201161cd_icgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="128,31,192,57"/><area shape="rect" id="node3" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="241,31,357,57"/><area shape="rect" id="node4" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="406,5,495,32"/><area shape="rect" id="node5" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="545,31,615,57"/><area shape="rect" id="node6" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="664,31,715,57"/><area shape="rect" id="node7" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="763,31,821,57"/><area shape="rect" id="node8" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="869,31,960,57"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a8a1c88df5e127732cb63f1a8be180926"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int usb_tryreset </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>usb_tryreset does what the name means: Try to reset the usb via <a class="el" href="usb_8h.html#ae1550dc55de346b46df8c4b6930613e9" title="resetusb() is just a macro to call _resetusb() with debuggin constants (file, lineno) ...">resetusb()</a></p>
<p>This function is called if an usb command ran into an error in case of one of the following two situations:</p>
<ul>
<li>When setting up a new usb device and the start() function got an error (<dl class="section see"><dt>See Also</dt><dd><a class="el" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . ">_setupusb()</a>)</dd></dl>
</li>
<li>If upgrading to a new firmware gets an error (<dl class="section see"><dt>See Also</dt><dd><a class="el" href="firmware_8c.html#acf906b981c18cd97f25f7f00274f6026">cmd_fwupdate()</a>).</dd></dl>
The previous action which got the error will NOT be re-attempted.</li>
</ul>
<p>In an endless loop <a class="el" href="usb_8h.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset does what the name means: Try to reset the usb via resetusb() ">usb_tryreset()</a> tries to reset the given usb device via the macro <a class="el" href="usb_8h.html#ae1550dc55de346b46df8c4b6930613e9" title="resetusb() is just a macro to call _resetusb() with debuggin constants (file, lineno) ...">resetusb()</a>. <br/>
 This macro calls <a class="el" href="usb_8h.html#a9ea008b77417f82b177117dce9a50b48" title="_resetusb Reset a USB device. ">_resetusb()</a> with debugging information. <br/>
 <a class="el" href="usb_8h.html#a9ea008b77417f82b177117dce9a50b48" title="_resetusb Reset a USB device. ">_resetusb()</a> sends a command via the operating system dependent function <a class="el" href="usb_8h.html#a0fd9533617cdae390dc65aa4594e33d2" title="os_resetusb is the os specific implementation for resetting usb ">os_resetusb()</a> and - if successful - reinitializes the device. <a class="el" href="usb_8h.html#a0fd9533617cdae390dc65aa4594e33d2" title="os_resetusb is the os specific implementation for resetting usb ">os_resetusb()</a> returns -2 to indicate a broken device and all structures should be removed for it. <br/>
 In that case, the loop is terminated, an error message is produced and <a class="el" href="usb_8h.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset does what the name means: Try to reset the usb via resetusb() ">usb_tryreset()</a> returns -1.</p>
<p>In case <a class="el" href="usb_8h.html#ae1550dc55de346b46df8c4b6930613e9" title="resetusb() is just a macro to call _resetusb() with debuggin constants (file, lineno) ...">resetusb()</a> has success, the endless loop is left via a return 0 (success). <br/>
 If the return value from <a class="el" href="usb_8h.html#ae1550dc55de346b46df8c4b6930613e9" title="resetusb() is just a macro to call _resetusb() with debuggin constants (file, lineno) ...">resetusb()</a> is -1, the loop is continued with the next try.</p>
<p>If the global variable <b>reset_stop</b> is set directly when the function is called or after each try, <a class="el" href="usb_8h.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset does what the name means: Try to reset the usb via resetusb() ">usb_tryreset()</a> stops working and returns -1.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000010">Todo:</a></b></dt><dd>Why does <a class="el" href="usb_8h.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset does what the name means: Try to reset the usb via resetusb() ">usb_tryreset()</a> hide the information returned from <a class="el" href="usb_8h.html#ae1550dc55de346b46df8c4b6930613e9" title="resetusb() is just a macro to call _resetusb() with debuggin constants (file, lineno) ...">resetusb()</a>? Isn't it needed by the callers? </dd></dl>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00465">465</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00049">ckb_err</a>, <a class="el" href="includes_8h_source.html#l00055">ckb_info</a>, <a class="el" href="usb_8c_source.html#l00025">reset_stop</a>, and <a class="el" href="usb_8h_source.html#l00214">resetusb</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00214">_setupusb()</a>, <a class="el" href="firmware_8c_source.html#l00154">cmd_fwupdate()</a>, <a class="el" href="usb__linux_8c_source.html#l00213">os_sendindicators()</a>, and <a class="el" href="usb__linux_8c_source.html#l00535">os_setupusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                               {</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="usb_8c.html#acfc08dcd9203a7489c1c43362e2ff138">reset_stop</a>)</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <a class="code" href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a>(<span class="stringliteral">&quot;Attempting reset...\n&quot;</span>);</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    <span class="keywordflow">while</span>(1){</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        <span class="keywordtype">int</span> res = <a class="code" href="usb_8h.html#ae1550dc55de346b46df8c4b6930613e9">resetusb</a>(kb);</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        <span class="keywordflow">if</span>(!res){</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;            <a class="code" href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a>(<span class="stringliteral">&quot;Reset success\n&quot;</span>);</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        }</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="keywordflow">if</span>(res == -2 || <a class="code" href="usb_8c.html#acfc08dcd9203a7489c1c43362e2ff138">reset_stop</a>)</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    }</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <a class="code" href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a>(<span class="stringliteral">&quot;Reset failed. Disconnecting.\n&quot;</span>);</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;}</div>
<div class="ttc" id="includes_8h_html_a8312a1a42e03986afb7c76557f4d3e25"><div class="ttname"><a href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a></div><div class="ttdeci">#define ckb_err(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00049">includes.h:49</a></div></div>
<div class="ttc" id="usb_8c_html_acfc08dcd9203a7489c1c43362e2ff138"><div class="ttname"><a href="usb_8c.html#acfc08dcd9203a7489c1c43362e2ff138">reset_stop</a></div><div class="ttdeci">volatile int reset_stop</div><div class="ttdoc">brief . </div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00025">usb.c:25</a></div></div>
<div class="ttc" id="includes_8h_html_af3b6c3fbbe2da20e4058fd83084329a6"><div class="ttname"><a href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a></div><div class="ttdeci">#define ckb_info(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00055">includes.h:55</a></div></div>
<div class="ttc" id="usb_8h_html_ae1550dc55de346b46df8c4b6930613e9"><div class="ttname"><a href="usb_8h.html#ae1550dc55de346b46df8c4b6930613e9">resetusb</a></div><div class="ttdeci">#define resetusb(kb)</div><div class="ttdoc">resetusb() is just a macro to call _resetusb() with debuggin constants (file, lineno) ...</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00214">usb.h:214</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-15" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-15-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-15-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-15-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a8a1c88df5e127732cb63f1a8be180926_icgraph.png" border="0" usemap="#usb_8c_a8a1c88df5e127732cb63f1a8be180926_icgraph" alt=""/></div>
<map name="usb_8c_a8a1c88df5e127732cb63f1a8be180926_icgraph" id="usb_8c_a8a1c88df5e127732cb63f1a8be180926_icgraph">
<area shape="rect" id="node2" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="353,31,436,57"/><area shape="rect" id="node11" href="firmware_8h.html#acf906b981c18cd97f25f7f00274f6026" title="cmd_fwupdate" alt="" coords="160,31,267,57"/><area shape="rect" id="node12" href="usb__linux_8c.html#afa51c505c8f442f49ea2d712c61faea2" title="os_sendindicators" alt="" coords="150,132,277,159"/><area shape="rect" id="node14" href="usb__linux_8c.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb" alt="" coords="165,81,261,108"/><area shape="rect" id="node3" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="512,31,587,57"/><area shape="rect" id="node4" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="635,31,699,57"/><area shape="rect" id="node5" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="747,31,863,57"/><area shape="rect" id="node6" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="913,5,1002,32"/><area shape="rect" id="node7" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="1051,31,1122,57"/><area shape="rect" id="node8" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1171,31,1221,57"/><area shape="rect" id="node9" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1269,31,1328,57"/><area shape="rect" id="node10" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1376,31,1467,57"/><area shape="rect" id="node13" href="input_8h.html#a1126a054e3319ba8cbd74bfbd39099eb" title="updateindicators_kb" alt="" coords="325,132,464,159"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a8e6389e8183a834fedb6ed317dd26f94"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* vendor_str </td>
          <td>(</td>
          <td class="paramtype">short&#160;</td>
          <td class="paramname"><em>vendor</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>uncomment the following Define to see USB packets sent to the device</p>
<p>vendor_str returns "corsair" iff the given <em>vendor</em> argument is equal to <em>V_CORSAIR</em> <code></code>(0x1bc) else it returns ""</p>
<dl class="section attention"><dt>Attention</dt><dd>There is also a string defined V_CORSAIR_STR, which returns the device number as string in hex "1b1c". </dd></dl>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00043">43</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>References <a class="el" href="usb_8h_source.html#l00038">V_CORSAIR</a>.</p>

<p>Referenced by <a class="el" href="devnode_8c_source.html#l00136">_mkdevpath()</a>, and <a class="el" href="usb_8c_source.html#l00214">_setupusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;                                    {</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="keywordflow">if</span>(vendor == <a class="code" href="usb_8h.html#a2aa27325e30aac7dcec6203d4f11e996">V_CORSAIR</a>)</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&quot;corsair&quot;</span>;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;}</div>
<div class="ttc" id="usb_8h_html_a2aa27325e30aac7dcec6203d4f11e996"><div class="ttname"><a href="usb_8h.html#a2aa27325e30aac7dcec6203d4f11e996">V_CORSAIR</a></div><div class="ttdeci">#define V_CORSAIR</div><div class="ttdoc">For the following Defines please see &quot;Detailed Description&quot;. </div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00038">usb.h:38</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-16" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-16-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-16-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-16-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb_8c_a8e6389e8183a834fedb6ed317dd26f94_icgraph.png" border="0" usemap="#usb_8c_a8e6389e8183a834fedb6ed317dd26f94_icgraph" alt=""/></div>
<map name="usb_8c_a8e6389e8183a834fedb6ed317dd26f94_icgraph" id="usb_8c_a8e6389e8183a834fedb6ed317dd26f94_icgraph">
<area shape="rect" id="node2" href="devnode_8c.html#a81c81014b2dfa89e326dd61769842953" title="_mkdevpath" alt="" coords="136,5,229,32"/><area shape="rect" id="node4" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="413,56,496,83"/><area shape="rect" id="node3" href="devnode_8h.html#a0c3d1e3cd90f43a9b5ee0793f4a75041" title="Create a dev path for the keyboard at index. Returns 0 on success. " alt="" coords="278,5,365,32"/><area shape="rect" id="node10" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1203,31,1253,57"/><area shape="rect" id="node5" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="544,56,619,83"/><area shape="rect" id="node6" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="667,56,731,83"/><area shape="rect" id="node7" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="779,56,895,83"/><area shape="rect" id="node8" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="945,56,1034,83"/><area shape="rect" id="node9" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="1083,56,1154,83"/><area shape="rect" id="node11" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1301,31,1360,57"/><area shape="rect" id="node12" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1408,31,1499,57"/></map>
</div>
</p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="a234c8042548e4208f82fc7f89472e14e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int features_mask = -1</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>features_mask Mask of features to exclude from all devices</p>
<p>That bit mask ist set to enable all (-1). When interpreting the input parameters, some of these bits can be cleared. <br/>
 At the moment binding, notifying and mouse-acceleration can be disabled via command line. <br/>
 Have a look at <em><a class="el" href="main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main()</a></em> in <a class="el" href="main_8c.html">main.c</a> for details. </p>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00035">35</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00214">_setupusb()</a>, and <a class="el" href="main_8c_source.html#l00088">main()</a>.</p>

</div>
</div>
<a class="anchor" id="a94d4a8df060c5f77d94f3656fefe6c32"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int hwload_mode</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>hwload_mode is defined in <a class="el" href="device_8c.html">device.c</a> </p>

<p>Definition at line <a class="el" href="device_8c_source.html#l00007">7</a> of file <a class="el" href="device_8c_source.html">device.c</a>.</p>

<p>Referenced by <a class="el" href="device_8c_source.html#l00025">_start_dev()</a>, <a class="el" href="usb_8c_source.html#l00601">_usbrecv()</a>, and <a class="el" href="usb_8c_source.html#l00532">_usbsend()</a>.</p>

</div>
</div>
<a class="anchor" id="acfc08dcd9203a7489c1c43362e2ff138"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile int reset_stop = 0</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>reset_stop is boolean: Reset stopper for when the program shuts down.</p>
<p>Is set only by <em><a class="el" href="main_8c.html#acd1527386a48875050e637e4bb872f11" title="quit Stop working the daemon. function is called if the daemon received a sigterm In this case...">quit()</a></em> to true (1) to inform several usb_* functions to end their loops and tries. </p>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00025">25</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00601">_usbrecv()</a>, <a class="el" href="usb_8c_source.html#l00532">_usbsend()</a>, <a class="el" href="main_8c_source.html#l00040">quitWithLock()</a>, and <a class="el" href="usb_8c_source.html#l00465">usb_tryreset()</a>.</p>

</div>
</div>
<a class="anchor" id="a0fa74a6fe0d2796e2d2dbf8447b9e5e4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">pthread_mutex_t usbmutex = PTHREAD_MUTEX_INITIALIZER</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>usbmutex is a never referenced mutex!</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000003">Todo:</a></b></dt><dd>We should have a look why this mutex is never used. </dd></dl>

<p>Definition at line <a class="el" href="usb_8c_source.html#l00017">17</a> of file <a class="el" href="usb_8c_source.html">usb.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_c663af95b3406af676444e819a47854e.html">ckb-daemon</a></li><li class="navelem"><a class="el" href="usb_8c.html">usb.c</a></li>
    <li class="footer">Generated on Sat Feb 3 2018 14:44:02 for ckb-next by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
