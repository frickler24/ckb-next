<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>ckb-next: src/ckb-daemon/usb_linux.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ckb-128.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">ckb-next
   &#160;<span id="projectnumber">v0.2.8 at branch all-mine</span>
   </div>
   <div id="projectbrief">ckb-next driver for corsair devices</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('usb__linux_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">usb_linux.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="device_8h_source.html">device.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="devnode_8h_source.html">devnode.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="input_8h_source.html">input.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="notify_8h_source.html">notify.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="usb_8h_source.html">usb.h</a>&quot;</code><br/>
</div><div class="textblock"><div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Include dependency graph for usb_linux.c:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c__incl.png" border="0" usemap="#src_2ckb-daemon_2usb__linux_8c" alt=""/></div>
<map name="src_2ckb-daemon_2usb__linux_8c" id="src_2ckb-daemon_2usb__linux_8c">
<area shape="rect" id="node2" href="device_8h.html" title="device.h" alt="" coords="644,171,714,197"/><area shape="rect" id="node28" href="devnode_8h.html" title="devnode.h" alt="" coords="808,96,889,123"/><area shape="rect" id="node29" href="usb_8h.html" title="Definitions for using USB interface. " alt="" coords="938,171,992,197"/><area shape="rect" id="node30" href="input_8h.html" title="input.h" alt="" coords="914,96,976,123"/><area shape="rect" id="node31" href="notify_8h.html" title="notify.h" alt="" coords="718,96,782,123"/><area shape="rect" id="node3" href="includes_8h.html" title="includes.h" alt="" coords="834,245,914,272"/><area shape="rect" id="node26" href="daemon_2keymap_8h.html" title="keymap.h" alt="" coords="1352,395,1430,421"/><area shape="rect" id="node4" href="os_8h.html" title="os.h" alt="" coords="1546,544,1592,571"/><area shape="rect" id="node25" href="structures_8h.html" title="structures.h" alt="" coords="1281,320,1372,347"/><area shape="rect" id="node27" href="keymap__mac_8h.html" title="keymap_mac.h" alt="" coords="1402,469,1512,496"/></map>
</div>
</div>
<p><a href="usb__linux_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:struct__model"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#struct__model">_model</a></td></tr>
<tr class="separator:struct__model"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ad72dbcf6d0153db1b8d8a58001feed83"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#ad72dbcf6d0153db1b8d8a58001feed83">DEBUG</a></td></tr>
<tr class="memdesc:ad72dbcf6d0153db1b8d8a58001feed83"><td class="mdescLeft">&#160;</td><td class="mdescRight">all open usb devices have their system path names here in this array.  <a href="#ad72dbcf6d0153db1b8d8a58001feed83">More...</a><br/></td></tr>
<tr class="separator:ad72dbcf6d0153db1b8d8a58001feed83"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a023dc730b8ef35b7918272df90d04c9b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a023dc730b8ef35b7918272df90d04c9b">TEST_RESET</a>(op)</td></tr>
<tr class="memdesc:a023dc730b8ef35b7918272df90d04c9b"><td class="mdescLeft">&#160;</td><td class="mdescRight">TEST_RESET doesa "try / catch" for resetting the usb interface.  <a href="#a023dc730b8ef35b7918272df90d04c9b">More...</a><br/></td></tr>
<tr class="separator:a023dc730b8ef35b7918272df90d04c9b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8d8cfcf715f178c0e85ce011e7a9bcbf"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a8d8cfcf715f178c0e85ce011e7a9bcbf">N_MODELS</a>&#160;&#160;&#160;(sizeof(<a class="el" href="usb__linux_8c.html#ac1888fdd0cb519fd7ff5768437629b8b">models</a>) / sizeof(<a class="el" href="usb__linux_8c.html#struct__model">_model</a>))</td></tr>
<tr class="separator:a8d8cfcf715f178c0e85ce011e7a9bcbf"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a9e813287cd0ee9c7b665002a929d2894"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a9e813287cd0ee9c7b665002a929d2894">os_usbsend</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb, const <a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *out_msg, int is_recv, const char *file, int line)</td></tr>
<tr class="memdesc:a9e813287cd0ee9c7b665002a929d2894"><td class="mdescLeft">&#160;</td><td class="mdescRight">os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long  <a href="#a9e813287cd0ee9c7b665002a929d2894">More...</a><br/></td></tr>
<tr class="separator:a9e813287cd0ee9c7b665002a929d2894"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5694446920cfae8c887163847312a8f8"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a5694446920cfae8c887163847312a8f8">os_usbrecv</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb, <a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *in_msg, const char *file, int line)</td></tr>
<tr class="memdesc:a5694446920cfae8c887163847312a8f8"><td class="mdescLeft">&#160;</td><td class="mdescRight">os_usbrecv receives a max MSGSIZE long buffer from usb device  <a href="#a5694446920cfae8c887163847312a8f8">More...</a><br/></td></tr>
<tr class="separator:a5694446920cfae8c887163847312a8f8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3da2cab9cd88ea517d39888fe2159734"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a3da2cab9cd88ea517d39888fe2159734">_nk95cmd</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb, <a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> bRequest, <a class="el" href="includes_8h.html#ab95f123a6c9bcfee6a343170ef8c5f69">ushort</a> wValue, const char *file, int line)</td></tr>
<tr class="memdesc:a3da2cab9cd88ea517d39888fe2159734"><td class="mdescLeft">&#160;</td><td class="mdescRight">_nk95cmd If we control a non RGB keyboard, set the keyboard via ioctl with usbdevfs_ctrltransfer  <a href="#a3da2cab9cd88ea517d39888fe2159734">More...</a><br/></td></tr>
<tr class="separator:a3da2cab9cd88ea517d39888fe2159734"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afa51c505c8f442f49ea2d712c61faea2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#afa51c505c8f442f49ea2d712c61faea2">os_sendindicators</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb)</td></tr>
<tr class="separator:afa51c505c8f442f49ea2d712c61faea2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9e5784bfca2e4612f498ce67c7dab275"><td class="memItemLeft" align="right" valign="top">void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a9e5784bfca2e4612f498ce67c7dab275">os_inputmain</a> (void *context)</td></tr>
<tr class="memdesc:a9e5784bfca2e4612f498ce67c7dab275"><td class="mdescLeft">&#160;</td><td class="mdescRight">os_inputmain This function is run in a separate thread and will be detached from the main thread, so it needs to clean up its own resources.  <a href="#a9e5784bfca2e4612f498ce67c7dab275">More...</a><br/></td></tr>
<tr class="separator:a9e5784bfca2e4612f498ce67c7dab275"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afe1111f494da4776633be32fecaba44b"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b">usbunclaim</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb, int resetting)</td></tr>
<tr class="separator:afe1111f494da4776633be32fecaba44b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6a62575e9073fae15efb58f24fbfe5b8"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a6a62575e9073fae15efb58f24fbfe5b8">os_closeusb</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb)</td></tr>
<tr class="separator:a6a62575e9073fae15efb58f24fbfe5b8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a309cab8bf65221b01dc320f247abf626"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626">usbclaim</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb)</td></tr>
<tr class="separator:a309cab8bf65221b01dc320f247abf626"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0fd9533617cdae390dc65aa4594e33d2"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a0fd9533617cdae390dc65aa4594e33d2">os_resetusb</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb, const char *file, int line)</td></tr>
<tr class="separator:a0fd9533617cdae390dc65aa4594e33d2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab694a2ac859b16b5af802b4484f5ba0b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#ab694a2ac859b16b5af802b4484f5ba0b">strtrim</a> (char *string)</td></tr>
<tr class="separator:ab694a2ac859b16b5af802b4484f5ba0b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a39442715182933b93172de60cdb66e8f"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a39442715182933b93172de60cdb66e8f">os_setupusb</a> (<a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *kb)</td></tr>
<tr class="separator:a39442715182933b93172de60cdb66e8f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3185d6da36c8b0f8b862a8479ae82034"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034">usbadd</a> (struct udev_device *dev, short vendor, short product)</td></tr>
<tr class="separator:a3185d6da36c8b0f8b862a8479ae82034"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a50efc8ee0ffcb6f201735d1a3bb08779"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779">usb_add_device</a> (struct udev_device *dev)</td></tr>
<tr class="memdesc:a50efc8ee0ffcb6f201735d1a3bb08779"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add a udev device. Returns 0 if device was recognized/added.  <a href="#a50efc8ee0ffcb6f201735d1a3bb08779">More...</a><br/></td></tr>
<tr class="separator:a50efc8ee0ffcb6f201735d1a3bb08779"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adeffaa2b04d01b15c8623255719420ef"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#adeffaa2b04d01b15c8623255719420ef">usb_rm_device</a> (struct udev_device *dev)</td></tr>
<tr class="memdesc:adeffaa2b04d01b15c8623255719420ef"><td class="mdescLeft">&#160;</td><td class="mdescRight">usb_rm_device find the usb port to remove and close it via <a class="el" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431">closeusb()</a>.  <a href="#adeffaa2b04d01b15c8623255719420ef">More...</a><br/></td></tr>
<tr class="separator:adeffaa2b04d01b15c8623255719420ef"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad56c1e4ec53bbd6b947cb535590328ea"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea">udev_enum</a> ()</td></tr>
<tr class="memdesc:ad56c1e4ec53bbd6b947cb535590328ea"><td class="mdescLeft">&#160;</td><td class="mdescRight">udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that.  <a href="#ad56c1e4ec53bbd6b947cb535590328ea">More...</a><br/></td></tr>
<tr class="separator:ad56c1e4ec53bbd6b947cb535590328ea"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0859efad3739abe2ec61af4f3bb983ff"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff">usbmain</a> ()</td></tr>
<tr class="separator:a0859efad3739abe2ec61af4f3bb983ff"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a41aa3e13beb593c91a5410200b4dd8d2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a41aa3e13beb593c91a5410200b4dd8d2">usbkill</a> ()</td></tr>
<tr class="memdesc:a41aa3e13beb593c91a5410200b4dd8d2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stop the USB system.  <a href="#a41aa3e13beb593c91a5410200b4dd8d2">More...</a><br/></td></tr>
<tr class="separator:a41aa3e13beb593c91a5410200b4dd8d2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a1b952c601049b156fe39d96473aaca3a"><td class="memItemLeft" align="right" valign="top">static char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#a1b952c601049b156fe39d96473aaca3a">kbsyspath</a> [9][FILENAME_MAX]</td></tr>
<tr class="separator:a1b952c601049b156fe39d96473aaca3a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad21f1896afa016837ab9b476f9e62450"><td class="memItemLeft" align="right" valign="top">static struct udev *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#ad21f1896afa016837ab9b476f9e62450">udev</a></td></tr>
<tr class="memdesc:ad21f1896afa016837ab9b476f9e62450"><td class="mdescLeft">&#160;</td><td class="mdescRight">struct udef is defined in /usr/include/libudev.h  <a href="#ad21f1896afa016837ab9b476f9e62450">More...</a><br/></td></tr>
<tr class="separator:ad21f1896afa016837ab9b476f9e62450"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa9fb3f307bd79608dfa48c4efee007b9"><td class="memItemLeft" align="right" valign="top">pthread_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#aa9fb3f307bd79608dfa48c4efee007b9">usbthread</a></td></tr>
<tr class="separator:aa9fb3f307bd79608dfa48c4efee007b9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac29239c44378f37b6130288cb67e5699"><td class="memItemLeft" align="right" valign="top">pthread_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#ac29239c44378f37b6130288cb67e5699">udevthread</a></td></tr>
<tr class="separator:ac29239c44378f37b6130288cb67e5699"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac1888fdd0cb519fd7ff5768437629b8b"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="usb__linux_8c.html#struct__model">_model</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__linux_8c.html#ac1888fdd0cb519fd7ff5768437629b8b">models</a> []</td></tr>
<tr class="separator:ac1888fdd0cb519fd7ff5768437629b8b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<hr/><h2 class="groupheader">Data Structure Documentation</h2>
<a name="struct__model" id="struct__model"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct _model</td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="textblock">
<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00644">644</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>
</div><div id="dynsection-1" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-1-trigger" src="closed.png" alt="+"/> Collaboration diagram for _model:</div>
<div id="dynsection-1-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-1-content" class="dyncontent" style="display:none;">
<div class="center"><img src="struct__model__coll__graph.png" border="0" usemap="#__model_coll__map" alt="Collaboration graph"/></div>
<map name="__model_coll__map" id="__model_coll__map">
</map>
</div>
<table class="fieldtable">
<tr><th colspan="3">Data Fields</th></tr>
<tr><td class="fieldtype">
<a class="anchor" id="acb9618ccc26a67ae69db081b7f091495"></a>const char *</td>
<td class="fieldname">
name</td>
<td class="fielddoc">
</td></tr>
<tr><td class="fieldtype">
<a class="anchor" id="a0675741fabf6b6b11e21bf1bf3564fd4"></a>short</td>
<td class="fieldname">
number</td>
<td class="fielddoc">
</td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="ad72dbcf6d0153db1b8d8a58001feed83"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBUG</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00011">11</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

</div>
</div>
<a class="anchor" id="a8d8cfcf715f178c0e85ce011e7a9bcbf"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define N_MODELS&#160;&#160;&#160;(sizeof(<a class="el" href="usb__linux_8c.html#ac1888fdd0cb519fd7ff5768437629b8b">models</a>) / sizeof(<a class="el" href="usb__linux_8c.html#struct__model">_model</a>))</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00681">681</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>Referenced by <a class="el" href="usb__linux_8c_source.html#l00694">usb_add_device()</a>.</p>

</div>
</div>
<a class="anchor" id="a023dc730b8ef35b7918272df90d04c9b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TEST_RESET</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">op</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line"><span class="keywordflow">if</span>(op){                                                                 <a class="code" href="includes_8h.html#a31d8dc974fcd529cb912ca80f05db462">\</a></div>
<div class="line"><a class="code" href="includes_8h.html#a31d8dc974fcd529cb912ca80f05db462">        ckb_err_fn</a>(<span class="stringliteral">&quot;resetusb failed: %s\n&quot;</span>, file, line, strerror(errno));   \</div>
<div class="line">        if(errno == EINTR || errno == EAGAIN)                               \</div>
<div class="line">            return -1;              <span class="comment">/* try again if status code says so */</span>  \</div>
<div class="line">        return -2;                  <span class="comment">/* else, remove device */</span>               \</div>
<div class="line">    }</div>
<div class="ttc" id="includes_8h_html_a31d8dc974fcd529cb912ca80f05db462"><div class="ttname"><a href="includes_8h.html#a31d8dc974fcd529cb912ca80f05db462">ckb_err_fn</a></div><div class="ttdeci">#define ckb_err_fn(fmt, file, line, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00049">includes.h:49</a></div></div>
</div><!-- fragment -->
<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00477">477</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>Referenced by <a class="el" href="usb__linux_8c_source.html#l00495">os_resetusb()</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a3da2cab9cd88ea517d39888fe2159734"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int _nk95cmd </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>&#160;</td>
          <td class="paramname"><em>bRequest</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="includes_8h.html#ab95f123a6c9bcfee6a343170ef8c5f69">ushort</a>&#160;</td>
          <td class="paramname"><em>wValue</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>line</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>To send control packets to a non RGB non color K95 Keyboard, use this function. Normally it is called via the <a class="el" href="usb_8h.html#aefc95e6120686dff0e06bba32ca21ad1" title="nk95cmd() macro is used to wrap _nk95cmd() with debugging information (file and lineno). the command structure is different:   Just the bits 23..16 are used as bits 7..0 for bRequest   Bits 15..0 are used as wValue ">nk95cmd()</a> macro.</p>
<p>If it is the wrong device for which the function is called, 0 is returned and nothing done. Otherwise a usbdevfs_ctrltransfer structure is filled and an USBDEVFS_CONTROL ioctl() called.</p>
<table class="doxtable">
<tr>
<th>bRequestType </th><th>bRequest </th><th>wValue </th><th>EP </th><th>size </th><th>Timeout </th><th>data  </th></tr>
<tr>
<td>0x40 </td><td>see table below to switch hardware-modus at Keyboard </td><td>wValue </td><td>device </td><td>MSG_SIZE </td><td>5ms </td><td>the message buffer pointer </td></tr>
<tr>
<td>Host to Device, Type=Vendor, Recipient=Device </td><td>bRequest parameter </td><td>given wValue Parameter </td><td>device 0 </td><td>0 data to write </td><td>5000 </td><td>null </td></tr>
</table>
<p>If a 0 or a negative error number is returned by the ioctl, an error message is shown depending on the errno or "No data written" if retval was 0. In either case 1 is returned to indicate the error. If the ioctl returned a value &gt; 0, 0 is returned to indicate no error.</p>
<p>Currently the following combinations for bRequest and wValue are used: </p>
<table class="doxtable">
<tr>
<th>Device </th><th>what it might to do </th><th>constant </th><th>bRequest </th><th>wValue  </th></tr>
<tr>
<td>non RGB Keyboard </td><td>set HW-modus on (leave the ckb driver) </td><td>HWON </td><td>0x0002 </td><td>0x0030 </td></tr>
<tr>
<td>non RGB Keyboard </td><td>set HW-modus off (initialize the ckb driver) </td><td>HWOFF </td><td>0x0002 </td><td>0x0001 </td></tr>
<tr>
<td>non RGB Keyboard </td><td>set light modus M1 in single-color keyboards </td><td>NK95_M1 </td><td>0x0014 </td><td>0x0001 </td></tr>
<tr>
<td>non RGB Keyboard </td><td>set light modus M2 in single-color keyboards </td><td>NK95_M2 </td><td>0x0014 </td><td>0x0002 </td></tr>
<tr>
<td>non RGB Keyboard </td><td>set light modus M3 in single-color keyboards </td><td>NK95_M3 </td><td>0x0014 </td><td>0x0003 </td></tr>
</table>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="usb_8h.html" title="Definitions for using USB interface. ">usb.h</a> </dd></dl>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00189">189</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00049">ckb_err_fn</a>, <a class="el" href="structures_8h_source.html#l00187">usbdevice::handle</a>, <a class="el" href="usb_8h_source.html#l00067">P_K95_NRGB</a>, and <a class="el" href="structures_8h_source.html#l00237">usbdevice::product</a>.</p>
<div class="fragment"><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                                                                                      {</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="keywordflow">if</span>(kb-&gt;<a class="code" href="structures_8h.html#a045b6c91e3f04e54f25d39da9bda105b">product</a> != <a class="code" href="usb_8h.html#ae8d1cf4b55023aae2b72ee607e214f84">P_K95_NRGB</a>)</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keyword">struct </span>usbdevfs_ctrltransfer transfer = { 0x40, bRequest, wValue, 0, 0, 5000, 0 };</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordtype">int</span> res = ioctl(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> - 1, USBDEVFS_CONTROL, &amp;transfer);</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordflow">if</span>(res &lt;= 0){</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <a class="code" href="includes_8h.html#a31d8dc974fcd529cb912ca80f05db462">ckb_err_fn</a>(<span class="stringliteral">&quot;%s\n&quot;</span>, file, line, res ? strerror(errno) : <span class="stringliteral">&quot;No data written&quot;</span>);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    }</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;}</div>
<div class="ttc" id="structures_8h_html_a045b6c91e3f04e54f25d39da9bda105b"><div class="ttname"><a href="structures_8h.html#a045b6c91e3f04e54f25d39da9bda105b">usbdevice::product</a></div><div class="ttdeci">short product</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00237">structures.h:237</a></div></div>
<div class="ttc" id="usb_8h_html_ae8d1cf4b55023aae2b72ee607e214f84"><div class="ttname"><a href="usb_8h.html#ae8d1cf4b55023aae2b72ee607e214f84">P_K95_NRGB</a></div><div class="ttdeci">#define P_K95_NRGB</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00067">usb.h:67</a></div></div>
<div class="ttc" id="structures_8h_html_a1e1d8c37298aa076d30ba95dd97465ef"><div class="ttname"><a href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">usbdevice::handle</a></div><div class="ttdeci">int handle</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00187">structures.h:187</a></div></div>
<div class="ttc" id="includes_8h_html_a31d8dc974fcd529cb912ca80f05db462"><div class="ttname"><a href="includes_8h.html#a31d8dc974fcd529cb912ca80f05db462">ckb_err_fn</a></div><div class="ttdeci">#define ckb_err_fn(fmt, file, line, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00049">includes.h:49</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a6a62575e9073fae15efb58f24fbfe5b8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void os_closeusb </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>os_closeusb unclaim it, destroy the udev device and clear data structures at kb</p>
<p>os_closeusb is the linux specific implementation for closing an active usb port. <br/>
 If a valid handle is given in the kb structure, the usb port is unclaimed (<a class="el" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b">usbunclaim()</a>). <br/>
 The device in unrefenced via library function udev_device_unref(). <br/>
 handle, udev and the first char of kbsyspath are cleared to 0 (empty string for kbsyspath). </p>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00433">433</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="structures_8h_source.html#l00187">usbdevice::handle</a>, <a class="el" href="includes_8h_source.html#l00028">INDEX_OF</a>, <a class="el" href="usb__linux_8c_source.html#l00013">kbsyspath</a>, <a class="el" href="device_8c_source.html#l00010">keyboard</a>, <a class="el" href="structures_8h_source.html#l00186">usbdevice::udev</a>, and <a class="el" href="usb__linux_8c_source.html#l00404">usbunclaim()</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00675">closeusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                               {</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="keywordflow">if</span>(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a>){</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <a class="code" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b">usbunclaim</a>(kb, 0);</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        close(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> - 1);</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    }</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    <span class="keywordflow">if</span>(kb-&gt;<a class="code" href="structures_8h.html#a050b6c1c162175c0e9abe16141770460">udev</a>)</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        udev_device_unref(kb-&gt;<a class="code" href="structures_8h.html#a050b6c1c162175c0e9abe16141770460">udev</a>);</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> = 0;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    kb-&gt;<a class="code" href="structures_8h.html#a050b6c1c162175c0e9abe16141770460">udev</a> = 0;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    <a class="code" href="usb__linux_8c.html#a1b952c601049b156fe39d96473aaca3a">kbsyspath</a>[<a class="code" href="includes_8h.html#ac114b913ed9d0b7cab3b83188f111530">INDEX_OF</a>(kb, <a class="code" href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a>)][0] = 0;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;}</div>
<div class="ttc" id="usb__linux_8c_html_a1b952c601049b156fe39d96473aaca3a"><div class="ttname"><a href="usb__linux_8c.html#a1b952c601049b156fe39d96473aaca3a">kbsyspath</a></div><div class="ttdeci">static char kbsyspath[9][FILENAME_MAX]</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00013">usb_linux.c:13</a></div></div>
<div class="ttc" id="device_8c_html_a5f2ad0f3998226c000c52c5c375c2661"><div class="ttname"><a href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a></div><div class="ttdeci">usbdevice keyboard[9]</div><div class="ttdoc">remember all usb devices. Needed for closeusb(). </div><div class="ttdef"><b>Definition:</b> <a href="device_8c_source.html#l00010">device.c:10</a></div></div>
<div class="ttc" id="usb__linux_8c_html_afe1111f494da4776633be32fecaba44b"><div class="ttname"><a href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b">usbunclaim</a></div><div class="ttdeci">static int usbunclaim(usbdevice *kb, int resetting)</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00404">usb_linux.c:404</a></div></div>
<div class="ttc" id="structures_8h_html_a050b6c1c162175c0e9abe16141770460"><div class="ttname"><a href="structures_8h.html#a050b6c1c162175c0e9abe16141770460">usbdevice::udev</a></div><div class="ttdeci">struct udev_device * udev</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00186">structures.h:186</a></div></div>
<div class="ttc" id="includes_8h_html_ac114b913ed9d0b7cab3b83188f111530"><div class="ttname"><a href="includes_8h.html#ac114b913ed9d0b7cab3b83188f111530">INDEX_OF</a></div><div class="ttdeci">#define INDEX_OF(entry, array)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00028">includes.h:28</a></div></div>
<div class="ttc" id="structures_8h_html_a1e1d8c37298aa076d30ba95dd97465ef"><div class="ttname"><a href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">usbdevice::handle</a></div><div class="ttdeci">int handle</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00187">structures.h:187</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-2" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-2-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-2-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-2-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a6a62575e9073fae15efb58f24fbfe5b8_cgraph.png" border="0" usemap="#usb__linux_8c_a6a62575e9073fae15efb58f24fbfe5b8_cgraph" alt=""/></div>
<map name="usb__linux_8c_a6a62575e9073fae15efb58f24fbfe5b8_cgraph" id="usb__linux_8c_a6a62575e9073fae15efb58f24fbfe5b8_cgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="149,5,237,32"/></map>
</div>
</p>

<p><div id="dynsection-3" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-3-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-3-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-3-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a6a62575e9073fae15efb58f24fbfe5b8_icgraph.png" border="0" usemap="#usb__linux_8c_a6a62575e9073fae15efb58f24fbfe5b8_icgraph" alt=""/></div>
<map name="usb__linux_8c_a6a62575e9073fae15efb58f24fbfe5b8_icgraph" id="usb__linux_8c_a6a62575e9073fae15efb58f24fbfe5b8_icgraph">
<area shape="rect" id="node2" href="usb_8h.html#a8732b3ade76da4ae362996232ef95431" title="closeusb Close a USB device and remove device entry. " alt="" coords="149,401,224,428"/><area shape="rect" id="node3" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="407,401,489,428"/><area shape="rect" id="node12" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . " alt="" coords="273,427,343,453"/><area shape="rect" id="node13" href="ckb-daemon_2main_8c.html#a24a012c29e291fef5fa13f4a07fffd33" title="quitWithLock " alt="" coords="796,325,895,352"/><area shape="rect" id="node32" href="usb__linux_8c.html#adeffaa2b04d01b15c8623255719420ef" title="usb_rm_device find the usb port to remove and close it via closeusb(). " alt="" coords="393,477,503,504"/><area shape="rect" id="node4" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="552,401,627,428"/><area shape="rect" id="node5" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="675,401,739,428"/><area shape="rect" id="node6" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="787,401,903,428"/><area shape="rect" id="node7" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="953,427,1042,453"/><area shape="rect" id="node8" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="1151,401,1222,428"/><area shape="rect" id="node9" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1407,275,1457,301"/><area shape="rect" id="node10" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1653,275,1712,301"/><area shape="rect" id="node11" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1891,275,1981,301"/><area shape="rect" id="node14" href="ckb-daemon_2main_8c.html#acd1527386a48875050e637e4bb872f11" title="quit Stop working the daemon. function is called if the daemon received a sigterm In this case..." alt="" coords="976,195,1019,221"/><area shape="rect" id="node15" href="classKbFirmware.html#ae5f3c91fcf3fe8fe55e2c1e3cea877eb" title="KbFirmware::_fileForBoard" alt="" coords="1098,43,1275,69"/><area shape="rect" id="node21" href="classKbFirmware.html#aa68b2e0aed9074c60eba72e9fa60a6b5" title="KbFirmware::_latestForBoard" alt="" coords="1091,107,1283,133"/><area shape="rect" id="node28" href="classFwUpgradeDialog.html#a72dac03aca9395d1d440f0edcd1bb1da" title="FwUpgradeDialog::fwUpdate\lFinished" alt="" coords="1091,158,1282,199"/><area shape="rect" id="node31" href="ckb-daemon_2main_8c.html#a05f9b9989842b986a26caf9e4c66a4c7" title="sighandler" alt="" coords="1146,224,1227,251"/><area shape="rect" id="node16" href="classKbFirmware.html#a1cc600d07217f327a1541a44d353004c" title="KbFirmware::dataForBoard" alt="" coords="1343,31,1521,57"/><area shape="rect" id="node17" href="classFwUpgradeDialog.html#a1fd1f6f1285ab4998a7c81e2ee118d54" title="FwUpgradeDialog::exec" alt="" coords="1601,5,1764,32"/><area shape="rect" id="node18" href="classKbWidget.html#a38c9f29a5d8f1edfcb5f8040de3dadb9" title="KbWidget::on_fwUpdButton\l_clicked" alt="" coords="1844,30,2028,71"/><area shape="rect" id="node19" href="classKbWidget.html#a428930086336c668e8a1055c21c938d9" title="KbWidget::showFwUpdate" alt="" coords="2088,37,2267,64"/><area shape="rect" id="node20" href="classMainWindow.html#ae50767c4ed6029f63ebacfffde4bc802" title="MainWindow::showFwUpdate\lNotification" alt="" coords="2315,30,2511,71"/><area shape="rect" id="node22" href="classKbFirmware.html#adf60ed5d7553a8c3f362ce5ae29ce965" title="KbFirmware::versionForBoard" alt="" coords="1335,107,1529,133"/><area shape="rect" id="node23" href="classKbWidget.html#adabed0db911bef8b3c0157372fb4e21a" title="KbWidget::updateFwButton" alt="" coords="1591,107,1774,133"/><area shape="rect" id="node25" href="classMainWindow.html#a7bd3f729676a76651d4852d03d1cfb8e" title="MainWindow::checkFwUpdates" alt="" coords="1833,161,2039,188"/><area shape="rect" id="node24" href="classKbWidget.html#a16381b1ae59f8e1649d7d06232dadc1d" title="KbWidget::on_tabWidget\l_currentChanged" alt="" coords="1853,95,2019,137"/><area shape="rect" id="node26" href="classMainWindow.html#a888ae1a192a5ca93d0d8bddd104ae953" title="MainWindow::timerTick" alt="" coords="2098,161,2257,188"/><area shape="rect" id="node27" href="classMainWindow.html#a8b244be8b7b7db1b08de2a2acb9409db" title="MainWindow::MainWindow" alt="" coords="2323,161,2503,188"/><area shape="rect" id="node29" href="classFwUpgradeDialog.html#ae785587a6678240a0a6f47ef79808ad7" title="FwUpgradeDialog::FwUpgrade\lDialog" alt="" coords="1582,209,1783,250"/><area shape="rect" id="node30" href="classFwUpgradeDialog.html#a8f4e424ecf62240c666836a8d5425f50" title="FwUpgradeDialog::removeDev" alt="" coords="1331,165,1533,192"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9e5784bfca2e4612f498ce67c7dab275"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* os_inputmain </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>context</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>os_inputmain is run in a separate thread and will be detached from the main thread, so it needs to clean up its own resources.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000017">Todo:</a></b></dt><dd>This function is a collection of many tasks. It should be divided into several sub-functions for the sake of greater convenience:</dd></dl>
<ol type="1">
<li>set up an URB (Userspace Ressource Buffer) to communicate with the USBDEVFS_* ioctl()s</li>
<li>perform the ioctl()</li>
<li>interpretate the information got into the URB buffer or handle error situations and retry operation or leave the endless loop</li>
<li>inform the os about the data</li>
<li>loop endless via 2.</li>
<li>if endless loop has gone, deinitalize the interface, free buffers etc.</li>
<li>return null </li>
</ol>
<p>Here the actions in detail:</p>
<p>Monitor input transfers on all endpoints for non-RGB devices For RGB, monitor all but the last, as it's used for input/output</p>
<p>Get an usbdevfs_urb data structure and clear it via memset()</p>
<p>Hopefully the buffer lengths are equal for all devices with congruent types. You can find out the correctness for your device with lsusb &ndash;v or similar on macOS. Currently the following combinations are known and implemented:</p>
<table class="doxtable">
<tr>
<th>device </th><th>detect with macro combination </th><th>endpoint # </th><th>buffer-length  </th></tr>
<tr>
<td>each </td><td>none </td><td>0 </td><td>8 </td></tr>
<tr>
<td>RGB Mouse </td><td>IS_RGB &amp;&amp; IS_MOUSE </td><td>1 </td><td>10 </td></tr>
<tr>
<td>RGB Keyboard </td><td>IS_RGB &amp;&amp; !IS_MOUSE </td><td>1 </td><td>21 </td></tr>
<tr>
<td>RGB Mouse or Keyboard </td><td>IS_RGB </td><td>2 </td><td>MSG_SIZE (64) </td></tr>
<tr>
<td>non RGB Mouse or Keyboard </td><td>!IS_RGB </td><td>1 </td><td>4 </td></tr>
<tr>
<td>non RGB Mouse or Keyboard </td><td>!IS_RGB </td><td>2 </td><td>15 </td></tr>
</table>
<p>Now submit all the URBs via ioctl(USBDEVFS_SUBMITURB) with type USBDEVFS_URB_TYPE_INTERRUPT (the endpoints are defined as type interrupt). Endpoint number is 0x80..0x82 or 0x83, depending on the model.</p>
<p>The userSpaceFS knows the URBs now, so start monitoring input</p>
<p>if the ioctl returns something != 0, let's have a deeper look what happened. Broken devices or shutting down the entire system leads to closing the device and finishing this thread.</p>
<p>If just an EPIPE ocurred, give the device a CLEAR_HALT and resubmit the URB.</p>
<p>A correct REAPURB returns a Pointer to the URB which we now have a closer look into. Lock all following actions with imutex.</p>
<p>Process the input depending on type of device. Interprete the actual size of the URB buffer</p>
<table class="doxtable">
<tr>
<th>device </th><th>detect with macro combination </th><th>seems to be endpoint # </th><th>actual buffer-length </th><th>function called  </th></tr>
<tr>
<td>mouse (RGB and non RGB) </td><td>IS_MOUSE </td><td>nA </td><td>8, 10 or 11 </td><td><a class="el" href="keymap_8c.html#a092f675ff366b5823c73b25f83d513f9">hid_mouse_translate()</a> </td></tr>
<tr>
<td>mouse (RGB and non RGB) </td><td>IS_MOUSE </td><td>nA </td><td>MSG_SIZE (64) </td><td><a class="el" href="keymap_8c.html#a0dc9a16564cc51b35a35d28af1a96fb0">corsair_mousecopy()</a> </td></tr>
<tr>
<td>RGB Keyboard </td><td>IS_RGB &amp;&amp; !IS_MOUSE </td><td>1 </td><td>8 (BIOS Mode) </td><td><a class="el" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889">hid_kb_translate()</a> </td></tr>
<tr>
<td>RGB Keyboard </td><td>IS_RGB &amp;&amp; !IS_MOUSE </td><td>2 </td><td>5 or 21, KB inactive! </td><td><a class="el" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889">hid_kb_translate()</a> </td></tr>
<tr>
<td>RGB Keyboard </td><td>IS_RGB &amp;&amp; !IS_MOUSE </td><td>3? </td><td>MSG_SIZE </td><td><a class="el" href="keymap_8c.html#ad39ede76abd657f5123fa331853db017">corsair_kbcopy()</a> </td></tr>
<tr>
<td>non RGB Keyboard </td><td>!IS_RGB &amp;&amp; !IS_MOUSE </td><td>nA </td><td>nA </td><td><a class="el" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889">hid_kb_translate()</a> </td></tr>
</table>
<p>The input data is transformed and copied to the kb structure. Now give it to the OS and unlock the imutex afterwards.</p>
<p>Re-submit the URB for the next run.</p>
<p>If the endless loop is terminated, clean up by discarding the URBs via ioctl(USBDEVFS_DISCARDURB), free the URB buffers and return a null pointer as thread exit code. </p>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00239">239</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="structures_8h_source.html#l00231">usbdevice::active</a>, <a class="el" href="includes_8h_source.html#l00050">ckb_err</a>, <a class="el" href="includes_8h_source.html#l00056">ckb_info</a>, <a class="el" href="keymap_8c_source.html#l00394">corsair_kbcopy()</a>, <a class="el" href="keymap_8c_source.html#l00403">corsair_mousecopy()</a>, <a class="el" href="kbmanager_8cpp_source.html#l00004">devpath</a>, <a class="el" href="structures_8h_source.html#l00215">usbdevice::epcount</a>, <a class="el" href="structures_8h_source.html#l00187">usbdevice::handle</a>, <a class="el" href="keymap_8c_source.html#l00223">hid_kb_translate()</a>, <a class="el" href="keymap_8c_source.html#l00366">hid_mouse_translate()</a>, <a class="el" href="device_8h_source.html#l00022">imutex</a>, <a class="el" href="includes_8h_source.html#l00028">INDEX_OF</a>, <a class="el" href="structures_8h_source.html#l00245">usbdevice::input</a>, <a class="el" href="input_8c_source.html#l00132">inputupdate()</a>, <a class="el" href="usb_8h_source.html#l00137">IS_MOUSE</a>, <a class="el" href="usb_8h_source.html#l00120">IS_RGB</a>, <a class="el" href="device_8c_source.html#l00010">keyboard</a>, <a class="el" href="structures_8h_source.html#l00130">usbinput::keys</a>, <a class="el" href="structures_8h_source.html#l00176">MSG_SIZE</a>, <a class="el" href="structures_8h_source.html#l00237">usbdevice::product</a>, <a class="el" href="structures_8h_source.html#l00132">usbinput::rel_x</a>, <a class="el" href="structures_8h_source.html#l00132">usbinput::rel_y</a>, and <a class="el" href="structures_8h_source.html#l00237">usbdevice::vendor</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00214">_setupusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                                 {</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <a class="code" href="structures_8h.html#structusbdevice">usbdevice</a>* kb = context;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="keywordtype">int</span> fd = kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> - 1;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    <span class="keywordtype">short</span> vendor = kb-&gt;<a class="code" href="structures_8h.html#a2fa713366249e2fdbb2539e5d65a1439">vendor</a>, product = kb-&gt;<a class="code" href="structures_8h.html#a045b6c91e3f04e54f25d39da9bda105b">product</a>;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <span class="keywordtype">int</span> index = <a class="code" href="includes_8h.html#ac114b913ed9d0b7cab3b83188f111530">INDEX_OF</a>(kb, <a class="code" href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a>);</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <a class="code" href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a>(<span class="stringliteral">&quot;Starting input thread for %s%d\n&quot;</span>, <a class="code" href="kbmanager_8cpp.html#a56df627164bf2c61b662d89d44b81372">devpath</a>, index);</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordtype">int</span> urbcount = <a class="code" href="usb_8h.html#ab8fdd4551fc9bedbcef101983ef0ef93">IS_RGB</a>(vendor, product) ? (kb-&gt;<a class="code" href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">epcount</a> - 1) : kb-&gt;<a class="code" href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">epcount</a>;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    if (urbcount == 0) {</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        <a class="code" href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a>(<span class="stringliteral">&quot;urbcount = 0, so there is nothing to claim in os_inputmain()\n&quot;</span>);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    }</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keyword">struct </span>usbdevfs_urb urbs[urbcount];</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    memset(urbs, 0, <span class="keyword">sizeof</span>(urbs));</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    urbs[0].buffer_length = 8;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keywordflow">if</span>(urbcount &gt; 1 &amp;&amp; <a class="code" href="usb_8h.html#ab8fdd4551fc9bedbcef101983ef0ef93">IS_RGB</a>(vendor, product)) {</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="usb_8h.html#a9aa1b86ddc13dc886bb403fda7c72ee7">IS_MOUSE</a>(vendor, product))</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;            urbs[1].buffer_length = 10;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;            urbs[1].buffer_length = 21;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        urbs[2].buffer_length = <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <span class="keywordflow">if</span>(urbcount != 3)</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;            urbs[urbcount - 1].buffer_length = <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        urbs[1].buffer_length = 4;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        urbs[2].buffer_length = 15;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    }</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; urbcount; i++){</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        urbs[i].type = USBDEVFS_URB_TYPE_INTERRUPT;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        urbs[i].endpoint = 0x80 | (i + 1);</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        urbs[i].buffer = malloc(urbs[i].buffer_length);</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        ioctl(fd, USBDEVFS_SUBMITURB, urbs + i);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    }</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="keywordflow">while</span> (1) {</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="keyword">struct </span>usbdevfs_urb* urb = 0;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        <span class="keywordflow">if</span> (ioctl(fd, USBDEVFS_REAPURB, &amp;urb)){</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;            <span class="keywordflow">if</span> (errno == ENODEV || errno == ENOENT || errno == ESHUTDOWN)</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                <span class="comment">// Stop the thread if the handle closes</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(errno == EPIPE &amp;&amp; urb){</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                ioctl(fd, USBDEVFS_CLEAR_HALT, &amp;urb-&gt;endpoint);</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                <span class="comment">// Re-submit the URB</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                <span class="keywordflow">if</span>(urb)</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                    ioctl(fd, USBDEVFS_SUBMITURB, urb);</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                urb = 0;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            }</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        }</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        <span class="keywordflow">if</span> (urb) {</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            pthread_mutex_lock(<a class="code" href="device_8h.html#aa87bd893f7d4bd0700cb699c88dd860b">imutex</a>(kb));</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="usb_8h.html#a9aa1b86ddc13dc886bb403fda7c72ee7">IS_MOUSE</a>(vendor, product)){</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                <span class="keywordflow">switch</span>(urb-&gt;actual_length){</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                <span class="keywordflow">case</span> 8:</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                <span class="keywordflow">case</span> 10:</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                <span class="keywordflow">case</span> 11:</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                    <span class="comment">// HID mouse input</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                    <a class="code" href="keymap_8c.html#a092f675ff366b5823c73b25f83d513f9">hid_mouse_translate</a>(kb-&gt;<a class="code" href="structures_8h.html#a3dfdb1f843ec3df0f2aeca70ee6f011a">input</a>.<a class="code" href="structures_8h.html#a09eb578ef851df58b6b124d9e6cf1dc0">keys</a>, &amp;kb-&gt;<a class="code" href="structures_8h.html#a3dfdb1f843ec3df0f2aeca70ee6f011a">input</a>.<a class="code" href="structures_8h.html#a67a69269768c4b55dd8fb7f09040c498">rel_x</a>, &amp;kb-&gt;<a class="code" href="structures_8h.html#a3dfdb1f843ec3df0f2aeca70ee6f011a">input</a>.<a class="code" href="structures_8h.html#aaf170cc287147501a64f3ec7131f1df0">rel_y</a>, -(urb-&gt;endpoint &amp; 0xF), urb-&gt;actual_length, urb-&gt;buffer);</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>:</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                    <span class="comment">// Corsair mouse input</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                    <a class="code" href="keymap_8c.html#a0dc9a16564cc51b35a35d28af1a96fb0">corsair_mousecopy</a>(kb-&gt;<a class="code" href="structures_8h.html#a3dfdb1f843ec3df0f2aeca70ee6f011a">input</a>.<a class="code" href="structures_8h.html#a09eb578ef851df58b6b124d9e6cf1dc0">keys</a>, -(urb-&gt;endpoint &amp; 0xF), urb-&gt;buffer);</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                }</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="usb_8h.html#ab8fdd4551fc9bedbcef101983ef0ef93">IS_RGB</a>(vendor, product)){</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                <span class="keywordflow">switch</span>(urb-&gt;actual_length){</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                <span class="keywordflow">case</span> 8:</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                    <span class="comment">// RGB EP 1: 6KRO (BIOS mode) input</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                    <a class="code" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889">hid_kb_translate</a>(kb-&gt;<a class="code" href="structures_8h.html#a3dfdb1f843ec3df0f2aeca70ee6f011a">input</a>.<a class="code" href="structures_8h.html#a09eb578ef851df58b6b124d9e6cf1dc0">keys</a>, -1, urb-&gt;actual_length, urb-&gt;buffer);</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                <span class="keywordflow">case</span> 21:</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                <span class="keywordflow">case</span> 5:</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                    <span class="comment">// RGB EP 2: NKRO (non-BIOS) input. Accept only if keyboard is inactive</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                    <span class="keywordflow">if</span>(!kb-&gt;<a class="code" href="structures_8h.html#a8889b6a5d3ce83427377e3a3de947f03">active</a>)</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                        <a class="code" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889">hid_kb_translate</a>(kb-&gt;<a class="code" href="structures_8h.html#a3dfdb1f843ec3df0f2aeca70ee6f011a">input</a>.<a class="code" href="structures_8h.html#a09eb578ef851df58b6b124d9e6cf1dc0">keys</a>, -2, urb-&gt;actual_length, urb-&gt;buffer);</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>:</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                    <span class="comment">// RGB EP 3: Corsair input</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                    <a class="code" href="keymap_8c.html#ad39ede76abd657f5123fa331853db017">corsair_kbcopy</a>(kb-&gt;<a class="code" href="structures_8h.html#a3dfdb1f843ec3df0f2aeca70ee6f011a">input</a>.<a class="code" href="structures_8h.html#a09eb578ef851df58b6b124d9e6cf1dc0">keys</a>, -(urb-&gt;endpoint &amp; 0xF), urb-&gt;buffer);</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                }</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                <span class="comment">// Non-RGB input</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                <a class="code" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889">hid_kb_translate</a>(kb-&gt;<a class="code" href="structures_8h.html#a3dfdb1f843ec3df0f2aeca70ee6f011a">input</a>.<a class="code" href="structures_8h.html#a09eb578ef851df58b6b124d9e6cf1dc0">keys</a>, urb-&gt;endpoint &amp; 0xF, urb-&gt;actual_length, urb-&gt;buffer);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;            }</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;            <a class="code" href="input_8c.html#ae360d0b9a764a1d38c5be5464be8b70a">inputupdate</a>(kb);</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            pthread_mutex_unlock(<a class="code" href="device_8h.html#aa87bd893f7d4bd0700cb699c88dd860b">imutex</a>(kb));</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            ioctl(fd, USBDEVFS_SUBMITURB, urb);</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            urb = 0;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        }</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    }</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <a class="code" href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a>(<span class="stringliteral">&quot;Stopping input thread for %s%d\n&quot;</span>, <a class="code" href="kbmanager_8cpp.html#a56df627164bf2c61b662d89d44b81372">devpath</a>, index);</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; urbcount; i++){</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        ioctl(fd, USBDEVFS_DISCARDURB, urbs + i);</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        free(urbs[i].buffer);</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    }</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;}</div>
<div class="ttc" id="structures_8h_html_ad4d025ecf1bdbf8b244ca688df8e478d"><div class="ttname"><a href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a></div><div class="ttdeci">#define MSG_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00176">structures.h:176</a></div></div>
<div class="ttc" id="structures_8h_html_a3dfdb1f843ec3df0f2aeca70ee6f011a"><div class="ttname"><a href="structures_8h.html#a3dfdb1f843ec3df0f2aeca70ee6f011a">usbdevice::input</a></div><div class="ttdeci">usbinput input</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00245">structures.h:245</a></div></div>
<div class="ttc" id="includes_8h_html_a8312a1a42e03986afb7c76557f4d3e25"><div class="ttname"><a href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a></div><div class="ttdeci">#define ckb_err(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00050">includes.h:50</a></div></div>
<div class="ttc" id="usb_8h_html_ab8fdd4551fc9bedbcef101983ef0ef93"><div class="ttname"><a href="usb_8h.html#ab8fdd4551fc9bedbcef101983ef0ef93">IS_RGB</a></div><div class="ttdeci">#define IS_RGB(vendor, product)</div><div class="ttdoc">RGB vs non-RGB test (note: non-RGB Strafe is still considered &quot;RGB&quot; in that it shares the same protoc...</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00120">usb.h:120</a></div></div>
<div class="ttc" id="device_8c_html_a5f2ad0f3998226c000c52c5c375c2661"><div class="ttname"><a href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a></div><div class="ttdeci">usbdevice keyboard[9]</div><div class="ttdoc">remember all usb devices. Needed for closeusb(). </div><div class="ttdef"><b>Definition:</b> <a href="device_8c_source.html#l00010">device.c:10</a></div></div>
<div class="ttc" id="structures_8h_html_a09eb578ef851df58b6b124d9e6cf1dc0"><div class="ttname"><a href="structures_8h.html#a09eb578ef851df58b6b124d9e6cf1dc0">usbinput::keys</a></div><div class="ttdeci">uchar keys[((((152+3+12)+25)+7)/8)]</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00130">structures.h:130</a></div></div>
<div class="ttc" id="structures_8h_html_a8889b6a5d3ce83427377e3a3de947f03"><div class="ttname"><a href="structures_8h.html#a8889b6a5d3ce83427377e3a3de947f03">usbdevice::active</a></div><div class="ttdeci">char active</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00231">structures.h:231</a></div></div>
<div class="ttc" id="structures_8h_html_a8d667681cbb0b3741476bf54c01e79b9"><div class="ttname"><a href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">usbdevice::epcount</a></div><div class="ttdeci">int epcount</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00215">structures.h:215</a></div></div>
<div class="ttc" id="input_8c_html_ae360d0b9a764a1d38c5be5464be8b70a"><div class="ttname"><a href="input_8c.html#ae360d0b9a764a1d38c5be5464be8b70a">inputupdate</a></div><div class="ttdeci">void inputupdate(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="input_8c_source.html#l00132">input.c:132</a></div></div>
<div class="ttc" id="usb_8h_html_a9aa1b86ddc13dc886bb403fda7c72ee7"><div class="ttname"><a href="usb_8h.html#a9aa1b86ddc13dc886bb403fda7c72ee7">IS_MOUSE</a></div><div class="ttdeci">#define IS_MOUSE(vendor, product)</div><div class="ttdoc">Mouse vs keyboard test. </div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00137">usb.h:137</a></div></div>
<div class="ttc" id="kbmanager_8cpp_html_a56df627164bf2c61b662d89d44b81372"><div class="ttname"><a href="kbmanager_8cpp.html#a56df627164bf2c61b662d89d44b81372">devpath</a></div><div class="ttdeci">QString devpath</div><div class="ttdef"><b>Definition:</b> <a href="kbmanager_8cpp_source.html#l00004">kbmanager.cpp:4</a></div></div>
<div class="ttc" id="structures_8h_html_a67a69269768c4b55dd8fb7f09040c498"><div class="ttname"><a href="structures_8h.html#a67a69269768c4b55dd8fb7f09040c498">usbinput::rel_x</a></div><div class="ttdeci">short rel_x</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00132">structures.h:132</a></div></div>
<div class="ttc" id="keymap_8c_html_a092f675ff366b5823c73b25f83d513f9"><div class="ttname"><a href="keymap_8c.html#a092f675ff366b5823c73b25f83d513f9">hid_mouse_translate</a></div><div class="ttdeci">void hid_mouse_translate(unsigned char *kbinput, short *xaxis, short *yaxis, int endpoint, int length, const unsigned char *urbinput)</div><div class="ttdef"><b>Definition:</b> <a href="keymap_8c_source.html#l00366">keymap.c:366</a></div></div>
<div class="ttc" id="keymap_8c_html_a0dc9a16564cc51b35a35d28af1a96fb0"><div class="ttname"><a href="keymap_8c.html#a0dc9a16564cc51b35a35d28af1a96fb0">corsair_mousecopy</a></div><div class="ttdeci">void corsair_mousecopy(unsigned char *kbinput, int endpoint, const unsigned char *urbinput)</div><div class="ttdef"><b>Definition:</b> <a href="keymap_8c_source.html#l00403">keymap.c:403</a></div></div>
<div class="ttc" id="includes_8h_html_af3b6c3fbbe2da20e4058fd83084329a6"><div class="ttname"><a href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a></div><div class="ttdeci">#define ckb_info(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00056">includes.h:56</a></div></div>
<div class="ttc" id="structures_8h_html_a045b6c91e3f04e54f25d39da9bda105b"><div class="ttname"><a href="structures_8h.html#a045b6c91e3f04e54f25d39da9bda105b">usbdevice::product</a></div><div class="ttdeci">short product</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00237">structures.h:237</a></div></div>
<div class="ttc" id="includes_8h_html_ac114b913ed9d0b7cab3b83188f111530"><div class="ttname"><a href="includes_8h.html#ac114b913ed9d0b7cab3b83188f111530">INDEX_OF</a></div><div class="ttdeci">#define INDEX_OF(entry, array)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00028">includes.h:28</a></div></div>
<div class="ttc" id="structures_8h_html_aaf170cc287147501a64f3ec7131f1df0"><div class="ttname"><a href="structures_8h.html#aaf170cc287147501a64f3ec7131f1df0">usbinput::rel_y</a></div><div class="ttdeci">short rel_y</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00132">structures.h:132</a></div></div>
<div class="ttc" id="structures_8h_html_structusbdevice"><div class="ttname"><a href="structures_8h.html#structusbdevice">usbdevice</a></div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00178">structures.h:178</a></div></div>
<div class="ttc" id="device_8h_html_aa87bd893f7d4bd0700cb699c88dd860b"><div class="ttname"><a href="device_8h.html#aa87bd893f7d4bd0700cb699c88dd860b">imutex</a></div><div class="ttdeci">#define imutex(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00022">device.h:22</a></div></div>
<div class="ttc" id="keymap_8c_html_a6f4afd134546237416b271d9cefd2889"><div class="ttname"><a href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889">hid_kb_translate</a></div><div class="ttdeci">void hid_kb_translate(unsigned char *kbinput, int endpoint, int length, const unsigned char *urbinput)</div><div class="ttdef"><b>Definition:</b> <a href="keymap_8c_source.html#l00223">keymap.c:223</a></div></div>
<div class="ttc" id="structures_8h_html_a1e1d8c37298aa076d30ba95dd97465ef"><div class="ttname"><a href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">usbdevice::handle</a></div><div class="ttdeci">int handle</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00187">structures.h:187</a></div></div>
<div class="ttc" id="keymap_8c_html_ad39ede76abd657f5123fa331853db017"><div class="ttname"><a href="keymap_8c.html#ad39ede76abd657f5123fa331853db017">corsair_kbcopy</a></div><div class="ttdeci">void corsair_kbcopy(unsigned char *kbinput, int endpoint, const unsigned char *urbinput)</div><div class="ttdef"><b>Definition:</b> <a href="keymap_8c_source.html#l00394">keymap.c:394</a></div></div>
<div class="ttc" id="structures_8h_html_a2fa713366249e2fdbb2539e5d65a1439"><div class="ttname"><a href="structures_8h.html#a2fa713366249e2fdbb2539e5d65a1439">usbdevice::vendor</a></div><div class="ttdeci">short vendor</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00237">structures.h:237</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-4" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-4-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-4-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-4-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a9e5784bfca2e4612f498ce67c7dab275_cgraph.png" border="0" usemap="#usb__linux_8c_a9e5784bfca2e4612f498ce67c7dab275_cgraph" alt=""/></div>
<map name="usb__linux_8c_a9e5784bfca2e4612f498ce67c7dab275_cgraph" id="usb__linux_8c_a9e5784bfca2e4612f498ce67c7dab275_cgraph">
<area shape="rect" id="node2" href="keymap_8c.html#ad39ede76abd657f5123fa331853db017" title="corsair_kbcopy" alt="" coords="169,5,279,32"/><area shape="rect" id="node3" href="keymap_8c.html#a0dc9a16564cc51b35a35d28af1a96fb0" title="corsair_mousecopy" alt="" coords="157,56,291,83"/><area shape="rect" id="node4" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889" title="hid_kb_translate" alt="" coords="165,107,283,133"/><area shape="rect" id="node5" href="keymap_8c.html#a092f675ff366b5823c73b25f83d513f9" title="hid_mouse_translate" alt="" coords="153,157,295,184"/><area shape="rect" id="node6" href="input_8c.html#ae360d0b9a764a1d38c5be5464be8b70a" title="inputupdate" alt="" coords="179,208,269,235"/><area shape="rect" id="node7" href="input_8c.html#aed8e9842ed5750c1d328c5dc4c1ba2bd" title="inputupdate_keys" alt="" coords="345,183,469,209"/><area shape="rect" id="node13" href="input_8h.html#a9f2cfb2d883ae4a3732047fe3f3da683" title="os_mousemove" alt="" coords="517,233,632,260"/><area shape="rect" id="node8" href="input_8c.html#abd38419ce56379559481f51d9491adeb" title="macromask" alt="" coords="529,81,620,108"/><area shape="rect" id="node9" href="notify_8c.html#ac2411c0997dfdbefdebd45f2584a5d04" title="nprintkey" alt="" coords="537,132,612,159"/><area shape="rect" id="node11" href="input_8h.html#af0d3401f317f3214dadad7d1a3378c58" title="os_keypress" alt="" coords="527,183,623,209"/><area shape="rect" id="node10" href="notify_8c.html#a7ac88f15243030290e4d57c3c9ac7c98" title="nprintf" alt="" coords="680,132,739,159"/><area shape="rect" id="node12" href="input__linux_8c.html#a14ff0fdf147e3702197db2cadb878460" title="isync" alt="" coords="683,208,736,235"/></map>
</div>
</p>

<p><div id="dynsection-5" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-5-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-5-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-5-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a9e5784bfca2e4612f498ce67c7dab275_icgraph.png" border="0" usemap="#usb__linux_8c_a9e5784bfca2e4612f498ce67c7dab275_icgraph" alt=""/></div>
<map name="usb__linux_8c_a9e5784bfca2e4612f498ce67c7dab275_icgraph" id="usb__linux_8c_a9e5784bfca2e4612f498ce67c7dab275_icgraph">
<area shape="rect" id="node2" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="152,31,235,57"/><area shape="rect" id="node3" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="283,31,357,57"/><area shape="rect" id="node4" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="405,31,469,57"/><area shape="rect" id="node5" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="518,31,634,57"/><area shape="rect" id="node6" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="683,5,773,32"/><area shape="rect" id="node7" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="822,31,893,57"/><area shape="rect" id="node8" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="941,31,992,57"/><area shape="rect" id="node9" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1040,31,1099,57"/><area shape="rect" id="node10" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1147,31,1237,57"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0fd9533617cdae390dc65aa4594e33d2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int os_resetusb </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>line</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>os_resetusb is the os specific implementation for resetting usb</p>
<p>Try to reset an usb device in a linux user space driver.</p>
<ol type="1">
<li>unclaim the device, but do not reconnect the system driver (second param resetting = true)</li>
<li>reset the device via USBDEVFS_RESET command</li>
<li>claim the device again. Returns 0 on success, -2 if device should be removed and -1 if reset should by tried again</li>
</ol>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000018">Todo:</a></b></dt><dd>it seems that no one wants to try the reset again. But I'v seen it somewhere... </dd></dl>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00495">495</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="structures_8h_source.html#l00187">usbdevice::handle</a>, <a class="el" href="usb__linux_8c_source.html#l00477">TEST_RESET</a>, <a class="el" href="usb__linux_8c_source.html#l00457">usbclaim()</a>, and <a class="el" href="usb__linux_8c_source.html#l00404">usbunclaim()</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00426">_resetusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                                                           {</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <a class="code" href="usb__linux_8c.html#a023dc730b8ef35b7918272df90d04c9b">TEST_RESET</a>(<a class="code" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b">usbunclaim</a>(kb, 1));</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <a class="code" href="usb__linux_8c.html#a023dc730b8ef35b7918272df90d04c9b">TEST_RESET</a>(ioctl(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> - 1, USBDEVFS_RESET));</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <a class="code" href="usb__linux_8c.html#a023dc730b8ef35b7918272df90d04c9b">TEST_RESET</a>(<a class="code" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626">usbclaim</a>(kb));</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment">// Success!</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;}</div>
<div class="ttc" id="usb__linux_8c_html_a023dc730b8ef35b7918272df90d04c9b"><div class="ttname"><a href="usb__linux_8c.html#a023dc730b8ef35b7918272df90d04c9b">TEST_RESET</a></div><div class="ttdeci">#define TEST_RESET(op)</div><div class="ttdoc">TEST_RESET doesa &quot;try / catch&quot; for resetting the usb interface. </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00477">usb_linux.c:477</a></div></div>
<div class="ttc" id="usb__linux_8c_html_afe1111f494da4776633be32fecaba44b"><div class="ttname"><a href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b">usbunclaim</a></div><div class="ttdeci">static int usbunclaim(usbdevice *kb, int resetting)</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00404">usb_linux.c:404</a></div></div>
<div class="ttc" id="usb__linux_8c_html_a309cab8bf65221b01dc320f247abf626"><div class="ttname"><a href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626">usbclaim</a></div><div class="ttdeci">static int usbclaim(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00457">usb_linux.c:457</a></div></div>
<div class="ttc" id="structures_8h_html_a1e1d8c37298aa076d30ba95dd97465ef"><div class="ttname"><a href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">usbdevice::handle</a></div><div class="ttdeci">int handle</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00187">structures.h:187</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-6" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-6-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-6-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-6-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a0fd9533617cdae390dc65aa4594e33d2_cgraph.png" border="0" usemap="#usb__linux_8c_a0fd9533617cdae390dc65aa4594e33d2_cgraph" alt=""/></div>
<map name="usb__linux_8c_a0fd9533617cdae390dc65aa4594e33d2_cgraph" id="usb__linux_8c_a0fd9533617cdae390dc65aa4594e33d2_cgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626" title="usbclaim" alt="" coords="153,5,228,32"/><area shape="rect" id="node3" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="147,56,235,83"/></map>
</div>
</p>

<p><div id="dynsection-7" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-7-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-7-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-7-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a0fd9533617cdae390dc65aa4594e33d2_icgraph.png" border="0" usemap="#usb__linux_8c_a0fd9533617cdae390dc65aa4594e33d2_icgraph" alt=""/></div>
<map name="usb__linux_8c_a0fd9533617cdae390dc65aa4594e33d2_icgraph" id="usb__linux_8c_a0fd9533617cdae390dc65aa4594e33d2_icgraph">
<area shape="rect" id="node2" href="usb_8h.html#a9ea008b77417f82b177117dce9a50b48" title="_resetusb Reset a USB device. " alt="" coords="147,5,226,32"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="afa51c505c8f442f49ea2d712c61faea2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void os_sendindicators </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>os_sendindicators update the indicators for the special keys (Numlock, Capslock and what else?)</p>
<p>os_sendindicators update the indicators for the special keys (Numlock, Capslock and what else?)</p>
<p>Read the data from kb-&gt;ileds ans send them via ioctl() to the keyboard.</p>
<table class="doxtable">
<tr>
<th>bRequestType </th><th>bRequest </th><th>wValue </th><th>EP </th><th>size </th><th>Timeout </th><th>data  </th></tr>
<tr>
<td>0x21 </td><td>0x09 </td><td>0x0200 </td><td>Interface 0 </td><td>MSG_SIZE 1 Byte </td><td>timeout 0,5ms </td><td>the message buffer pointer </td></tr>
<tr>
<td>Host to Device, Type=Class, Recipient=Interface (why not endpoint?) </td><td>9 = SEND? </td><td>specific </td><td>0 </td><td>1 </td><td>500 </td><td>struct* kb-&gt;ileds </td></tr>
</table>
<p><br/>
 The ioctl command is USBDEVFS_CONTROL. </p>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00214">214</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00050">ckb_err</a>, <a class="el" href="structures_8h_source.html#l00187">usbdevice::handle</a>, <a class="el" href="structures_8h_source.html#l00247">usbdevice::ileds</a>, and <a class="el" href="usb_8c_source.html#l00465">usb_tryreset()</a>.</p>

<p>Referenced by <a class="el" href="input_8c_source.html#l00152">updateindicators_kb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                                      {</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span> countForReset = 0;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keyword">struct </span>usbdevfs_ctrltransfer transfer = { 0x21, 0x09, 0x0200, 0x00, 1, 500, &amp;kb-&gt;<a class="code" href="structures_8h.html#ab972e12c3a761c070ec6e15cf45908f6">ileds</a> };</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="keywordtype">int</span> res = ioctl(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> - 1, USBDEVFS_CONTROL, &amp;transfer);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordflow">if</span>(res &lt;= 0) {</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <a class="code" href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a>(<span class="stringliteral">&quot;%s\n&quot;</span>, res ? strerror(errno) : <span class="stringliteral">&quot;No data written&quot;</span>);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926">usb_tryreset</a>(kb) == 0 &amp;&amp; countForReset++ &lt; 3) {</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;            <a class="code" href="usb__linux_8c.html#afa51c505c8f442f49ea2d712c61faea2">os_sendindicators</a>(kb);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        }</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    }</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;}</div>
<div class="ttc" id="usb_8c_html_a8a1c88df5e127732cb63f1a8be180926"><div class="ttname"><a href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926">usb_tryreset</a></div><div class="ttdeci">int usb_tryreset(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00465">usb.c:465</a></div></div>
<div class="ttc" id="includes_8h_html_a8312a1a42e03986afb7c76557f4d3e25"><div class="ttname"><a href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a></div><div class="ttdeci">#define ckb_err(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00050">includes.h:50</a></div></div>
<div class="ttc" id="usb__linux_8c_html_afa51c505c8f442f49ea2d712c61faea2"><div class="ttname"><a href="usb__linux_8c.html#afa51c505c8f442f49ea2d712c61faea2">os_sendindicators</a></div><div class="ttdeci">void os_sendindicators(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00214">usb_linux.c:214</a></div></div>
<div class="ttc" id="structures_8h_html_ab972e12c3a761c070ec6e15cf45908f6"><div class="ttname"><a href="structures_8h.html#ab972e12c3a761c070ec6e15cf45908f6">usbdevice::ileds</a></div><div class="ttdeci">uchar ileds</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00247">structures.h:247</a></div></div>
<div class="ttc" id="structures_8h_html_a1e1d8c37298aa076d30ba95dd97465ef"><div class="ttname"><a href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">usbdevice::handle</a></div><div class="ttdeci">int handle</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00187">structures.h:187</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-8" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-8-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-8-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-8-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_afa51c505c8f442f49ea2d712c61faea2_cgraph.png" border="0" usemap="#usb__linux_8c_afa51c505c8f442f49ea2d712c61faea2_cgraph" alt=""/></div>
<map name="usb__linux_8c_afa51c505c8f442f49ea2d712c61faea2_cgraph" id="usb__linux_8c_afa51c505c8f442f49ea2d712c61faea2_cgraph">
<area shape="rect" id="node2" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset" alt="" coords="182,5,277,32"/></map>
</div>
</p>

<p><div id="dynsection-9" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-9-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-9-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-9-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_afa51c505c8f442f49ea2d712c61faea2_icgraph.png" border="0" usemap="#usb__linux_8c_afa51c505c8f442f49ea2d712c61faea2_icgraph" alt=""/></div>
<map name="usb__linux_8c_afa51c505c8f442f49ea2d712c61faea2_icgraph" id="usb__linux_8c_afa51c505c8f442f49ea2d712c61faea2_icgraph">
<area shape="rect" id="node2" href="input_8h.html#a1126a054e3319ba8cbd74bfbd39099eb" title="updateindicators_kb" alt="" coords="181,5,320,32"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a39442715182933b93172de60cdb66e8f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int os_setupusb </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>os_setupusb OS-specific setup for a specific usb device.</p>
<p>Perform the operating system-specific opening of the interface in <a class="el" href="usb_8h.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb OS-specific setup for a specific usb device. ">os_setupusb()</a>. As a result, some parameters should be set in kb (name, serial, fwversion, epcount = number of usb endpoints), and all endpoints should be claimed with <a class="el" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626">usbclaim()</a>. Claiming is the only point where <a class="el" href="usb_8h.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb OS-specific setup for a specific usb device. ">os_setupusb()</a> can produce an error (-1). </p>
<ul>
<li>Copy device description and serial</li>
<li>Copy firmware version (needed to determine USB protocol)</li>
<li>Do some output abaout connecting interfaces</li>
<li>Claim the USB interfaces</li>
</ul>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000019">Todo:</a></b></dt><dd>in these modules a pullrequest is outstanding </dd></dl>
<p>&lt; Try to reset the device and recall the function</p>
<p>&lt; Don't do this endless in recursion</p>
<p>&lt; <a class="el" href="usb__linux_8c.html#a39442715182933b93172de60cdb66e8f">os_setupusb()</a> has a return value (used as boolean) </p>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00533">533</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00050">ckb_err</a>, <a class="el" href="includes_8h_source.html#l00056">ckb_info</a>, <a class="el" href="kbmanager_8cpp_source.html#l00004">devpath</a>, <a class="el" href="structures_8h_source.html#l00215">usbdevice::epcount</a>, <a class="el" href="structures_8h_source.html#l00239">usbdevice::fwversion</a>, <a class="el" href="includes_8h_source.html#l00028">INDEX_OF</a>, <a class="el" href="structures_8h_source.html#l00174">KB_NAME_LEN</a>, <a class="el" href="device_8c_source.html#l00010">keyboard</a>, <a class="el" href="structures_8h_source.html#l00233">usbdevice::name</a>, <a class="el" href="structures_8h_source.html#l00235">usbdevice::serial</a>, <a class="el" href="structures_8h_source.html#l00175">SERIAL_LEN</a>, <a class="el" href="usb__linux_8c_source.html#l00508">strtrim()</a>, <a class="el" href="structures_8h_source.html#l00186">usbdevice::udev</a>, <a class="el" href="usb_8c_source.html#l00465">usb_tryreset()</a>, and <a class="el" href="usb__linux_8c_source.html#l00457">usbclaim()</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00214">_setupusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                               {</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="keyword">struct </span>udev_device* dev = kb-&gt;<a class="code" href="structures_8h.html#a050b6c1c162175c0e9abe16141770460">udev</a>;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>* name = udev_device_get_sysattr_value(dev, <span class="stringliteral">&quot;product&quot;</span>);</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <span class="keywordflow">if</span>(name)</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        strncpy(kb-&gt;<a class="code" href="structures_8h.html#afe60cc96ef4f77b69f3d15bc9bfb7f58">name</a>, name, <a class="code" href="structures_8h.html#a32d661966379fef9590d62fcb70a384f">KB_NAME_LEN</a>);</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <a class="code" href="usb__linux_8c.html#ab694a2ac859b16b5af802b4484f5ba0b">strtrim</a>(kb-&gt;<a class="code" href="structures_8h.html#afe60cc96ef4f77b69f3d15bc9bfb7f58">name</a>);</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>* serial = udev_device_get_sysattr_value(dev, <span class="stringliteral">&quot;serial&quot;</span>);</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="keywordflow">if</span>(serial)</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        strncpy(kb-&gt;<a class="code" href="structures_8h.html#a7f4ea697639b052e632ccc590f3c6ba6">serial</a>, serial, <a class="code" href="structures_8h.html#a1633179052fb1ef8df0dd803037b890e">SERIAL_LEN</a>);</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <a class="code" href="usb__linux_8c.html#ab694a2ac859b16b5af802b4484f5ba0b">strtrim</a>(kb-&gt;<a class="code" href="structures_8h.html#a7f4ea697639b052e632ccc590f3c6ba6">serial</a>);</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>* firmware = udev_device_get_sysattr_value(dev, <span class="stringliteral">&quot;bcdDevice&quot;</span>);</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    <span class="keywordflow">if</span>(firmware)</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        sscanf(firmware, <span class="stringliteral">&quot;%hx&quot;</span>, &amp;kb-&gt;<a class="code" href="structures_8h.html#a47e0bd130899bcf5acdef059f2970ac7">fwversion</a>);</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        kb-&gt;<a class="code" href="structures_8h.html#a47e0bd130899bcf5acdef059f2970ac7">fwversion</a> = 0;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    <span class="keywordtype">int</span> index = <a class="code" href="includes_8h.html#ac114b913ed9d0b7cab3b83188f111530">INDEX_OF</a>(kb, <a class="code" href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a>);</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <a class="code" href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a>(<span class="stringliteral">&quot;Connecting %s at %s%d\n&quot;</span>, kb-&gt;<a class="code" href="structures_8h.html#afe60cc96ef4f77b69f3d15bc9bfb7f58">name</a>, <a class="code" href="kbmanager_8cpp.html#a56df627164bf2c61b662d89d44b81372">devpath</a>, index);</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>* ep_str = udev_device_get_sysattr_value(dev, <span class="stringliteral">&quot;bNumInterfaces&quot;</span>);</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="preprocessor"></span>    <a class="code" href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a>(<span class="stringliteral">&quot;Connecting %s at %s%d\n&quot;</span>, kb-&gt;<a class="code" href="structures_8h.html#afe60cc96ef4f77b69f3d15bc9bfb7f58">name</a>, <a class="code" href="kbmanager_8cpp.html#a56df627164bf2c61b662d89d44b81372">devpath</a>, index);</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    <a class="code" href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a>(<span class="stringliteral">&quot;claiming interfaces. name=%s, serial=%s, firmware=%s; Got &gt;&gt;%s&lt;&lt; as ep_str\n&quot;</span>, name, serial, firmware, ep_str);</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="preprocessor">#endif //DEBUG</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="preprocessor"></span>    kb-&gt;<a class="code" href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">epcount</a> = 0;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <span class="keywordflow">if</span>(ep_str)</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        sscanf(ep_str, <span class="stringliteral">&quot;%d&quot;</span>, &amp;kb-&gt;<a class="code" href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">epcount</a>);</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    <span class="keywordflow">if</span>(kb-&gt;<a class="code" href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">epcount</a> &lt; 2){</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        <span class="comment">// IF we have an RGB KB with 0 or 1 endpoints, it will be in BIOS mode.</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        <a class="code" href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a>(<span class="stringliteral">&quot;Unable to read endpoint count from udev, assuming %d and reading &gt;&gt;%s&lt;&lt; or device is in BIOS mode\n&quot;</span>, kb-&gt;<a class="code" href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">epcount</a>, ep_str);</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926">usb_tryreset</a>(kb) == 0) { </div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;            <span class="keyword">static</span> <span class="keywordtype">int</span> retryCount = 0; </div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;            <span class="keywordflow">if</span> (retryCount++ &lt; 5) {</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="usb__linux_8c.html#a39442715182933b93172de60cdb66e8f">os_setupusb</a>(kb); </div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;            }</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        }</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;        <span class="comment">// ToDo are there special versions we have to detect? If there are, that was the old code to handle it:</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        <span class="comment">// This shouldn&#39;t happen, but if it does, assume EP count based onckb_warn what the device is supposed to have</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        <span class="comment">// kb-&gt;epcount = (HAS_FEATURES(kb, FEAT_RGB) ? 4 : 3);</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        <span class="comment">// ckb_warn(&quot;Unable to read endpoint count from udev, assuming %d and reading &gt;&gt;%s&lt;&lt;...\n&quot;, kb-&gt;epcount, ep_str);</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    }</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626">usbclaim</a>(kb)){</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        <a class="code" href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a>(<span class="stringliteral">&quot;Failed to claim interfaces: %s\n&quot;</span>, strerror(errno));</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    }</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;}</div>
<div class="ttc" id="structures_8h_html_a32d661966379fef9590d62fcb70a384f"><div class="ttname"><a href="structures_8h.html#a32d661966379fef9590d62fcb70a384f">KB_NAME_LEN</a></div><div class="ttdeci">#define KB_NAME_LEN</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00174">structures.h:174</a></div></div>
<div class="ttc" id="usb_8c_html_a8a1c88df5e127732cb63f1a8be180926"><div class="ttname"><a href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926">usb_tryreset</a></div><div class="ttdeci">int usb_tryreset(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00465">usb.c:465</a></div></div>
<div class="ttc" id="structures_8h_html_afe60cc96ef4f77b69f3d15bc9bfb7f58"><div class="ttname"><a href="structures_8h.html#afe60cc96ef4f77b69f3d15bc9bfb7f58">usbdevice::name</a></div><div class="ttdeci">char name[40+1]</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00233">structures.h:233</a></div></div>
<div class="ttc" id="includes_8h_html_a8312a1a42e03986afb7c76557f4d3e25"><div class="ttname"><a href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a></div><div class="ttdeci">#define ckb_err(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00050">includes.h:50</a></div></div>
<div class="ttc" id="structures_8h_html_a47e0bd130899bcf5acdef059f2970ac7"><div class="ttname"><a href="structures_8h.html#a47e0bd130899bcf5acdef059f2970ac7">usbdevice::fwversion</a></div><div class="ttdeci">ushort fwversion</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00239">structures.h:239</a></div></div>
<div class="ttc" id="device_8c_html_a5f2ad0f3998226c000c52c5c375c2661"><div class="ttname"><a href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a></div><div class="ttdeci">usbdevice keyboard[9]</div><div class="ttdoc">remember all usb devices. Needed for closeusb(). </div><div class="ttdef"><b>Definition:</b> <a href="device_8c_source.html#l00010">device.c:10</a></div></div>
<div class="ttc" id="structures_8h_html_a050b6c1c162175c0e9abe16141770460"><div class="ttname"><a href="structures_8h.html#a050b6c1c162175c0e9abe16141770460">usbdevice::udev</a></div><div class="ttdeci">struct udev_device * udev</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00186">structures.h:186</a></div></div>
<div class="ttc" id="usb__linux_8c_html_a309cab8bf65221b01dc320f247abf626"><div class="ttname"><a href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626">usbclaim</a></div><div class="ttdeci">static int usbclaim(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00457">usb_linux.c:457</a></div></div>
<div class="ttc" id="structures_8h_html_a8d667681cbb0b3741476bf54c01e79b9"><div class="ttname"><a href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">usbdevice::epcount</a></div><div class="ttdeci">int epcount</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00215">structures.h:215</a></div></div>
<div class="ttc" id="kbmanager_8cpp_html_a56df627164bf2c61b662d89d44b81372"><div class="ttname"><a href="kbmanager_8cpp.html#a56df627164bf2c61b662d89d44b81372">devpath</a></div><div class="ttdeci">QString devpath</div><div class="ttdef"><b>Definition:</b> <a href="kbmanager_8cpp_source.html#l00004">kbmanager.cpp:4</a></div></div>
<div class="ttc" id="includes_8h_html_af3b6c3fbbe2da20e4058fd83084329a6"><div class="ttname"><a href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a></div><div class="ttdeci">#define ckb_info(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00056">includes.h:56</a></div></div>
<div class="ttc" id="includes_8h_html_ac114b913ed9d0b7cab3b83188f111530"><div class="ttname"><a href="includes_8h.html#ac114b913ed9d0b7cab3b83188f111530">INDEX_OF</a></div><div class="ttdeci">#define INDEX_OF(entry, array)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00028">includes.h:28</a></div></div>
<div class="ttc" id="usb__linux_8c_html_ab694a2ac859b16b5af802b4484f5ba0b"><div class="ttname"><a href="usb__linux_8c.html#ab694a2ac859b16b5af802b4484f5ba0b">strtrim</a></div><div class="ttdeci">void strtrim(char *string)</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00508">usb_linux.c:508</a></div></div>
<div class="ttc" id="structures_8h_html_a7f4ea697639b052e632ccc590f3c6ba6"><div class="ttname"><a href="structures_8h.html#a7f4ea697639b052e632ccc590f3c6ba6">usbdevice::serial</a></div><div class="ttdeci">char serial[34]</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00235">structures.h:235</a></div></div>
<div class="ttc" id="usb__linux_8c_html_a39442715182933b93172de60cdb66e8f"><div class="ttname"><a href="usb__linux_8c.html#a39442715182933b93172de60cdb66e8f">os_setupusb</a></div><div class="ttdeci">int os_setupusb(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00533">usb_linux.c:533</a></div></div>
<div class="ttc" id="structures_8h_html_a1633179052fb1ef8df0dd803037b890e"><div class="ttname"><a href="structures_8h.html#a1633179052fb1ef8df0dd803037b890e">SERIAL_LEN</a></div><div class="ttdeci">#define SERIAL_LEN</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00175">structures.h:175</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-10" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-10-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-10-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-10-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a39442715182933b93172de60cdb66e8f_cgraph.png" border="0" usemap="#usb__linux_8c_a39442715182933b93172de60cdb66e8f_cgraph" alt=""/></div>
<map name="usb__linux_8c_a39442715182933b93172de60cdb66e8f_cgraph" id="usb__linux_8c_a39442715182933b93172de60cdb66e8f_cgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#ab694a2ac859b16b5af802b4484f5ba0b" title="strtrim" alt="" coords="168,5,227,32"/><area shape="rect" id="node3" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset" alt="" coords="150,56,245,83"/><area shape="rect" id="node4" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626" title="usbclaim" alt="" coords="160,107,235,133"/></map>
</div>
</p>

<p><div id="dynsection-11" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-11-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-11-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-11-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a39442715182933b93172de60cdb66e8f_icgraph.png" border="0" usemap="#usb__linux_8c_a39442715182933b93172de60cdb66e8f_icgraph" alt=""/></div>
<map name="usb__linux_8c_a39442715182933b93172de60cdb66e8f_icgraph" id="usb__linux_8c_a39442715182933b93172de60cdb66e8f_icgraph">
<area shape="rect" id="node2" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="149,31,232,57"/><area shape="rect" id="node3" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="280,31,355,57"/><area shape="rect" id="node4" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="403,31,467,57"/><area shape="rect" id="node5" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="515,31,631,57"/><area shape="rect" id="node6" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="681,5,770,32"/><area shape="rect" id="node7" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="819,31,890,57"/><area shape="rect" id="node8" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="939,31,989,57"/><area shape="rect" id="node9" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1037,31,1096,57"/><area shape="rect" id="node10" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1144,31,1235,57"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a5694446920cfae8c887163847312a8f8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int os_usbrecv </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *&#160;</td>
          <td class="paramname"><em>in_msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>line</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>os_usbrecv does what its name says:</p>
<p>The comment at the beginning of the procedure causes the suspicion that the firmware versionspecific distinction is missing for receiving from usb endpoint 3 or 4. The commented code contains only the reception from EP4, but this may be wrong for a software version 2.0 or higher (see the code for os-usbsend ()).</p>
<p><br/>
 So all the receiving is done via an ioctl() like in os_usbsend. The ioctl() is given a struct usbdevfs_ctrltransfer, in which the relevant parameters are entered:</p>
<table class="doxtable">
<tr>
<th>bRequestType </th><th>bRequest </th><th>wValue </th><th>EP </th><th>size </th><th>Timeout </th><th>data  </th></tr>
<tr>
<td>0xA1 </td><td>0x01 </td><td>0x0200 </td><td>endpoint to be addressed from epcount - 1 </td><td>MSG_SIZE </td><td>5ms </td><td>the message buffer pointer </td></tr>
<tr>
<td>Device to Host, Type=Class, Recipient=Interface </td><td>1 = RECEIVE? </td><td>specific </td><td>Interface # </td><td>64 </td><td>5000 </td><td>in_msg </td></tr>
</table>
<p>The ioctl() returns the number of bytes received. Here is the usual check again:</p>
<ul>
<li>If the return value is -1 AND the error is a timeout (ETIMEOUT), <a class="el" href="usb__linux_8c.html#a5694446920cfae8c887163847312a8f8" title="os_usbrecv receives a max MSGSIZE long buffer from usb device ">os_usbrecv()</a> will return -1 to indicate that it is probably a recoverable problem and a retry is recommended.</li>
<li>For another negative value or other error identifier OR 0 bytes are received, 0 is returned as an identifier for a heavy error.</li>
<li>In all other cases, the function returns the number of bytes received.</li>
</ul>
<p>If this is not the entire blocksize (MSG_SIZE bytes), an error message is issued on the standard error channel [warning "Read YY bytes (expected 64)"]. </p>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00129">129</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00049">ckb_err_fn</a>, <a class="el" href="includes_8h_source.html#l00052">ckb_warn_fn</a>, <a class="el" href="structures_8h_source.html#l00215">usbdevice::epcount</a>, <a class="el" href="structures_8h_source.html#l00187">usbdevice::handle</a>, and <a class="el" href="structures_8h_source.html#l00176">MSG_SIZE</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00601">_usbrecv()</a>.</p>
<div class="fragment"><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                                                                        {</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="keywordtype">int</span> res;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="comment">// This is what CUE does, but it doesn&#39;t seem to work on linux.</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <span class="comment">/*if(kb-&gt;fwversion &gt;= 0x130){</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">        struct usbdevfs_bulktransfer transfer;</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">        memset(&amp;transfer, 0, sizeof(transfer));</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">        transfer.ep = 0x84;</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">        transfer.len = MSG_SIZE;</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">        transfer.timeout = 5000;</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">        transfer.data = in_msg;</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">        res = ioctl(kb-&gt;handle - 1, USBDEVFS_BULK, &amp;transfer);</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">    } else {*/</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <span class="keyword">struct </span>usbdevfs_ctrltransfer transfer = { 0xa1, 0x01, 0x0300, kb-&gt;<a class="code" href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">epcount</a> - 1, <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>, 5000, in_msg };</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        res = ioctl(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> - 1, USBDEVFS_CONTROL, &amp;transfer);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="comment">//}</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordflow">if</span>(res &lt;= 0){</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <a class="code" href="includes_8h.html#a31d8dc974fcd529cb912ca80f05db462">ckb_err_fn</a>(<span class="stringliteral">&quot;%s\n&quot;</span>, file, line, res ? strerror(errno) : <span class="stringliteral">&quot;No data read&quot;</span>);</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="keywordflow">if</span>(res == -1 &amp;&amp; errno == ETIMEDOUT)</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;            <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(res != <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>)</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <a class="code" href="includes_8h.html#a1e1f9c51b62903b645e69191280cfbab">ckb_warn_fn</a>(<span class="stringliteral">&quot;Read %d bytes (expected %d)\n&quot;</span>, file, line, res, <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="preprocessor">#ifdef DEBUG_USB_RECV</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="preprocessor"></span>    <span class="keywordtype">char</span> converted[<a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>*3 + 1];</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;<a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>;i++)</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        sprintf(&amp;converted[i*3], <span class="stringliteral">&quot;%02x &quot;</span>, in_msg[i]);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <a class="code" href="includes_8h.html#a1e1f9c51b62903b645e69191280cfbab">ckb_warn_fn</a>(<span class="stringliteral">&quot;Recv %s\n&quot;</span>, file, line, converted);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">return</span> res;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;}</div>
<div class="ttc" id="structures_8h_html_ad4d025ecf1bdbf8b244ca688df8e478d"><div class="ttname"><a href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a></div><div class="ttdeci">#define MSG_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00176">structures.h:176</a></div></div>
<div class="ttc" id="structures_8h_html_a8d667681cbb0b3741476bf54c01e79b9"><div class="ttname"><a href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">usbdevice::epcount</a></div><div class="ttdeci">int epcount</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00215">structures.h:215</a></div></div>
<div class="ttc" id="includes_8h_html_a1e1f9c51b62903b645e69191280cfbab"><div class="ttname"><a href="includes_8h.html#a1e1f9c51b62903b645e69191280cfbab">ckb_warn_fn</a></div><div class="ttdeci">#define ckb_warn_fn(fmt, file, line, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00052">includes.h:52</a></div></div>
<div class="ttc" id="structures_8h_html_a1e1d8c37298aa076d30ba95dd97465ef"><div class="ttname"><a href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">usbdevice::handle</a></div><div class="ttdeci">int handle</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00187">structures.h:187</a></div></div>
<div class="ttc" id="includes_8h_html_a31d8dc974fcd529cb912ca80f05db462"><div class="ttname"><a href="includes_8h.html#a31d8dc974fcd529cb912ca80f05db462">ckb_err_fn</a></div><div class="ttdeci">#define ckb_err_fn(fmt, file, line, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00049">includes.h:49</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-12" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-12-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-12-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-12-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a5694446920cfae8c887163847312a8f8_icgraph.png" border="0" usemap="#usb__linux_8c_a5694446920cfae8c887163847312a8f8_icgraph" alt=""/></div>
<map name="usb__linux_8c_a5694446920cfae8c887163847312a8f8_icgraph" id="usb__linux_8c_a5694446920cfae8c887163847312a8f8_icgraph">
<area shape="rect" id="node2" href="usb_8h.html#a5a548f93d4c1c56910b840cebe88d0c2" title="_usbrecv Request data from a USB device by first sending an output packet and then reading the respon..." alt="" coords="144,5,219,32"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9e813287cd0ee9c7b665002a929d2894"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int os_usbsend </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="includes_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a> *&#160;</td>
          <td class="paramname"><em>out_msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>is_recv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>line</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>os_usbsend has two functions:</p>
<ul>
<li>if is_recv == false, it tries to send a given MSG_SIZE buffer via the usb interface given with kb.</li>
<li>otherwise a request is sent via the usb device to initiate the receiving of a message from the remote device.</li>
</ul>
<p>The functionality for sending distinguishes two cases, depending on the version number of the firmware of the connected device: <br/>
 If the firmware is less or equal 1.2, the transmission is done via an ioctl(). The ioctl() is given a struct usbdevfs_ctrltransfer, in which the relevant parameters are entered:</p>
<table class="doxtable">
<tr>
<th>bRequestType </th><th>bRequest </th><th>wValue </th><th>EP </th><th>size </th><th>Timeout </th><th>data  </th></tr>
<tr>
<td>0x21 </td><td>0x09 </td><td>0x0200 </td><td>endpoint / IF to be addressed from epcount-1 </td><td>MSG_SIZE </td><td>5000 (=5ms) </td><td>the message buffer pointer </td></tr>
<tr>
<td>Host to Device, Type=Class, Recipient=Interface </td><td>9 = Send data? </td><td>specific </td><td>last or pre-last device # </td><td>64 </td><td>5000 </td><td>out_msg </td></tr>
</table>
<p><br/>
 The ioctl command is USBDEVFS_CONTROL.</p>
<p>The same constellation is used if the device is requested to send its data (is_recv = true).</p>
<p>For a more recent firmware and is_recv = false, the ioctl command USBDEVFS_CONTROL is not used (this tells the bus to enter the control mode), but the bulk method is used: USBDEVFS_BULK. This is astonishing, because all of the endpoints are type Interrupt, not bulk.</p>
<p>Anyhow, forthis purpose a different structure is used for the ioctl() (struct <b>usbdevfs_bulktransfer</b>) and this is also initialized differently: <br/>
 The length and timeout parameters are given the same values as above. The formal parameter out_msg is also passed as a buffer pointer. For the endpoints, the firmware version is differentiated again: <br/>
 For a firmware version between 1.3 and &lt;2.0 endpoint 4 is used, otherwise (it can only be &gt;=2.0) endpoint 3 is used.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000016">Todo:</a></b></dt><dd>Since the handling of endpoints has already led to problems elsewhere, this implementation is extremely hardware-dependent and critical! <br/>
 Eg. the new keyboard K95PLATINUMRGB has a version number significantly less than 2.0 - will it run with this implementation?</dd></dl>
<p>The ioctl() - no matter what type - returns the number of bytes sent. Now comes the usual check:</p>
<ul>
<li>If the return value is -1 AND the error is a timeout (ETIMEOUT), <a class="el" href="usb__linux_8c.html#a9e813287cd0ee9c7b665002a929d2894" title="os_usbsend sends a data packet (MSG_SIZE = 64) Bytes long ">os_usbsend()</a> will return -1 to indicate that it is probably a recoverable problem and a retry is recommended.</li>
<li>For another negative value or other error identifier OR 0 bytes sent, 0 is returned as a heavy error identifier.</li>
<li>In all other cases, the function returns the number of bytes sent.</li>
</ul>
<p>If this is not the entire blocksize (MSG_SIZE bytes), an error message is issued on the standard error channel [warning "Wrote YY bytes (expected 64)"].</p>
<p>If DEBUG_USB is set during compilation, the number of bytes sent and their representation are logged to the error channel. </p>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00068">68</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00049">ckb_err_fn</a>, <a class="el" href="includes_8h_source.html#l00052">ckb_warn_fn</a>, <a class="el" href="structures_8h_source.html#l00215">usbdevice::epcount</a>, <a class="el" href="structures_8h_source.html#l00239">usbdevice::fwversion</a>, <a class="el" href="structures_8h_source.html#l00187">usbdevice::handle</a>, and <a class="el" href="structures_8h_source.html#l00176">MSG_SIZE</a>.</p>

<p>Referenced by <a class="el" href="usb_8c_source.html#l00601">_usbrecv()</a>, and <a class="el" href="usb_8c_source.html#l00532">_usbsend()</a>.</p>
<div class="fragment"><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;                                                                                            {</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="keywordtype">int</span> res;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="keywordflow">if</span>(kb-&gt;<a class="code" href="structures_8h.html#a47e0bd130899bcf5acdef059f2970ac7">fwversion</a> &gt;= 0x120 &amp;&amp; !is_recv){</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        <span class="keyword">struct </span>usbdevfs_bulktransfer transfer;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        memset(&amp;transfer, 0, <span class="keyword">sizeof</span>(transfer));</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        transfer.ep = (kb-&gt;<a class="code" href="structures_8h.html#a47e0bd130899bcf5acdef059f2970ac7">fwversion</a> &gt;= 0x130 &amp;&amp; kb-&gt;<a class="code" href="structures_8h.html#a47e0bd130899bcf5acdef059f2970ac7">fwversion</a> &lt; 0x200) ? 4 : 3;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        transfer.len = <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        transfer.timeout = 5000;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        transfer.data = (<span class="keywordtype">void</span>*)out_msg;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        res = ioctl(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> - 1, USBDEVFS_BULK, &amp;transfer);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        <span class="keyword">struct </span>usbdevfs_ctrltransfer transfer = { 0x21, 0x09, 0x0200, kb-&gt;<a class="code" href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">epcount</a> - 1, <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>, 5000, (<span class="keywordtype">void</span>*)out_msg };</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        res = ioctl(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> - 1, USBDEVFS_CONTROL, &amp;transfer);</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    }</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keywordflow">if</span>(res &lt;= 0){</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        <a class="code" href="includes_8h.html#a31d8dc974fcd529cb912ca80f05db462">ckb_err_fn</a>(<span class="stringliteral">&quot;%s\n&quot;</span>, file, line, res ? strerror(errno) : <span class="stringliteral">&quot;No data written&quot;</span>);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="keywordflow">if</span>(res == -1 &amp;&amp; errno == ETIMEDOUT)</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;            <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(res != <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>)</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <a class="code" href="includes_8h.html#a1e1f9c51b62903b645e69191280cfbab">ckb_warn_fn</a>(<span class="stringliteral">&quot;Wrote %d bytes (expected %d)\n&quot;</span>, file, line, res, <a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>);</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="preprocessor">#ifdef DEBUG_USB</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="preprocessor"></span>    <span class="keywordtype">char</span> converted[<a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>*3 + 1];</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;<a class="code" href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a>;i++)</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        sprintf(&amp;converted[i*3], <span class="stringliteral">&quot;%02x &quot;</span>, out_msg[i]);</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <a class="code" href="includes_8h.html#a1e1f9c51b62903b645e69191280cfbab">ckb_warn_fn</a>(<span class="stringliteral">&quot;Sent %s\n&quot;</span>, file, line, converted);</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">return</span> res;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;}</div>
<div class="ttc" id="structures_8h_html_ad4d025ecf1bdbf8b244ca688df8e478d"><div class="ttname"><a href="structures_8h.html#ad4d025ecf1bdbf8b244ca688df8e478d">MSG_SIZE</a></div><div class="ttdeci">#define MSG_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00176">structures.h:176</a></div></div>
<div class="ttc" id="structures_8h_html_a47e0bd130899bcf5acdef059f2970ac7"><div class="ttname"><a href="structures_8h.html#a47e0bd130899bcf5acdef059f2970ac7">usbdevice::fwversion</a></div><div class="ttdeci">ushort fwversion</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00239">structures.h:239</a></div></div>
<div class="ttc" id="structures_8h_html_a8d667681cbb0b3741476bf54c01e79b9"><div class="ttname"><a href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">usbdevice::epcount</a></div><div class="ttdeci">int epcount</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00215">structures.h:215</a></div></div>
<div class="ttc" id="includes_8h_html_a1e1f9c51b62903b645e69191280cfbab"><div class="ttname"><a href="includes_8h.html#a1e1f9c51b62903b645e69191280cfbab">ckb_warn_fn</a></div><div class="ttdeci">#define ckb_warn_fn(fmt, file, line, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00052">includes.h:52</a></div></div>
<div class="ttc" id="structures_8h_html_a1e1d8c37298aa076d30ba95dd97465ef"><div class="ttname"><a href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">usbdevice::handle</a></div><div class="ttdeci">int handle</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00187">structures.h:187</a></div></div>
<div class="ttc" id="includes_8h_html_a31d8dc974fcd529cb912ca80f05db462"><div class="ttname"><a href="includes_8h.html#a31d8dc974fcd529cb912ca80f05db462">ckb_err_fn</a></div><div class="ttdeci">#define ckb_err_fn(fmt, file, line, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00049">includes.h:49</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-13" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-13-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-13-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-13-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a9e813287cd0ee9c7b665002a929d2894_icgraph.png" border="0" usemap="#usb__linux_8c_a9e813287cd0ee9c7b665002a929d2894_icgraph" alt=""/></div>
<map name="usb__linux_8c_a9e813287cd0ee9c7b665002a929d2894_icgraph" id="usb__linux_8c_a9e813287cd0ee9c7b665002a929d2894_icgraph">
<area shape="rect" id="node2" href="usb_8h.html#a5a548f93d4c1c56910b840cebe88d0c2" title="_usbrecv Request data from a USB device by first sending an output packet and then reading the respon..." alt="" coords="149,5,224,32"/><area shape="rect" id="node3" href="usb_8h.html#a992cce1d173047466101113bfff5d7a1" title="_usbsend send a logical message completely to the given device " alt="" coords="147,56,226,83"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab694a2ac859b16b5af802b4484f5ba0b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void strtrim </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>string</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>strtrim trims a string by removing leading and trailing spaces. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">string</td><td></td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00508">508</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>Referenced by <a class="el" href="usb__linux_8c_source.html#l00533">os_setupusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                          {</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <span class="comment">// Find last non-space</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <span class="keywordtype">char</span>* last = string;</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">char</span>* c = <span class="keywordtype">string</span>; *c != 0; c++){</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        <span class="keywordflow">if</span>(!isspace(*c))</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;            last = c;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    }</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    last[1] = 0;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <span class="comment">// Find first non-space</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    <span class="keywordtype">char</span>* first = string;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="keywordflow">for</span>(; *first != 0; first++){</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        <span class="keywordflow">if</span>(!isspace(*first))</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    }</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <span class="keywordflow">if</span>(first != <span class="keywordtype">string</span>)</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        memmove(<span class="keywordtype">string</span>, first, last - first);</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;}</div>
</div><!-- fragment -->
<p><div id="dynsection-14" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-14-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-14-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-14-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_ab694a2ac859b16b5af802b4484f5ba0b_icgraph.png" border="0" usemap="#usb__linux_8c_ab694a2ac859b16b5af802b4484f5ba0b_icgraph" alt=""/></div>
<map name="usb__linux_8c_ab694a2ac859b16b5af802b4484f5ba0b_icgraph" id="usb__linux_8c_ab694a2ac859b16b5af802b4484f5ba0b_icgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb" alt="" coords="112,31,208,57"/><area shape="rect" id="node3" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="256,31,339,57"/><area shape="rect" id="node4" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="387,31,461,57"/><area shape="rect" id="node5" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="509,31,573,57"/><area shape="rect" id="node6" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="622,31,738,57"/><area shape="rect" id="node7" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="787,5,877,32"/><area shape="rect" id="node8" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="926,31,997,57"/><area shape="rect" id="node9" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1045,31,1096,57"/><area shape="rect" id="node10" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1144,31,1203,57"/><area shape="rect" id="node11" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1251,31,1341,57"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad56c1e4ec53bbd6b947cb535590328ea"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void udev_enum </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Reduce the hits of the enumeration by limiting to usb as technology and corsair as idVendor. Then filter with udev_enumerate_scan_devices () all hits.</p>
<p>The following call to udev_enumerate_get_list_entry() fetches the entire hitlist as udev_list_entry *. <br/>
 Use udev_list_entry_foreach() to iterate through the hit set. <br/>
 If both the device name exists (udev_list_entry_get_name) and the subsequent creation of a new udev_device (udev_device_new_from_syspath) is ok, the new device is added to the list with <a class="el" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. ">usb_add_device()</a>.</p>
<p>If the latter does not work, the new device is released again (udev_device_unref ()). <br/>
 After the last iteration, the enumerator is released with udev_enumerate_unref (). </p>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00746">746</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="usb__linux_8c_source.html#l00694">usb_add_device()</a>, and <a class="el" href="usb_8h_source.html#l00039">V_CORSAIR_STR</a>.</p>

<p>Referenced by <a class="el" href="usb__linux_8c_source.html#l00774">usbmain()</a>.</p>
<div class="fragment"><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                       {</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    <span class="keyword">struct </span>udev_enumerate* enumerator = udev_enumerate_new(<a class="code" href="usb__linux_8c.html#ad21f1896afa016837ab9b476f9e62450">udev</a>);</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    udev_enumerate_add_match_subsystem(enumerator, <span class="stringliteral">&quot;usb&quot;</span>);</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    udev_enumerate_add_match_sysattr(enumerator, <span class="stringliteral">&quot;idVendor&quot;</span>, <a class="code" href="usb_8h.html#a0a9288dd24752f04930cbf9e673e536c">V_CORSAIR_STR</a>);</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    udev_enumerate_scan_devices(enumerator);</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <span class="keyword">struct </span>udev_list_entry* devices, *dev_list_entry;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    devices = udev_enumerate_get_list_entry(enumerator);</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    udev_list_entry_foreach(dev_list_entry, devices){</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span>* path = udev_list_entry_get_name(dev_list_entry);</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        <span class="keywordflow">if</span>(!path)</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        <span class="keyword">struct </span>udev_device* dev = udev_device_new_from_syspath(<a class="code" href="usb__linux_8c.html#ad21f1896afa016837ab9b476f9e62450">udev</a>, path);</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        <span class="keywordflow">if</span>(!dev)</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        <span class="comment">// If the device matches a recognized device ID, open it</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779">usb_add_device</a>(dev))</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;            <span class="comment">// Release device if not</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;            udev_device_unref(dev);</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    }</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    udev_enumerate_unref(enumerator);</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;}</div>
<div class="ttc" id="usb_8h_html_a0a9288dd24752f04930cbf9e673e536c"><div class="ttname"><a href="usb_8h.html#a0a9288dd24752f04930cbf9e673e536c">V_CORSAIR_STR</a></div><div class="ttdeci">#define V_CORSAIR_STR</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00039">usb.h:39</a></div></div>
<div class="ttc" id="usb__linux_8c_html_a50efc8ee0ffcb6f201735d1a3bb08779"><div class="ttname"><a href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779">usb_add_device</a></div><div class="ttdeci">static int usb_add_device(struct udev_device *dev)</div><div class="ttdoc">Add a udev device. Returns 0 if device was recognized/added. </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00694">usb_linux.c:694</a></div></div>
<div class="ttc" id="usb__linux_8c_html_ad21f1896afa016837ab9b476f9e62450"><div class="ttname"><a href="usb__linux_8c.html#ad21f1896afa016837ab9b476f9e62450">udev</a></div><div class="ttdeci">static struct udev * udev</div><div class="ttdoc">struct udef is defined in /usr/include/libudev.h </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00638">usb_linux.c:638</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-15" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-15-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-15-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-15-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_ad56c1e4ec53bbd6b947cb535590328ea_cgraph.png" border="0" usemap="#usb__linux_8c_ad56c1e4ec53bbd6b947cb535590328ea_cgraph" alt=""/></div>
<map name="usb__linux_8c_ad56c1e4ec53bbd6b947cb535590328ea_cgraph" id="usb__linux_8c_ad56c1e4ec53bbd6b947cb535590328ea_cgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="145,537,261,564"/><area shape="rect" id="node3" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="309,537,373,564"/><area shape="rect" id="node4" href="usb_8c.html#a1ab9d61dd894466125283465201161cd" title="setupusb" alt="" coords="421,537,496,564"/><area shape="rect" id="node5" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="544,537,627,564"/><area shape="rect" id="node6" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431" title="closeusb" alt="" coords="888,56,963,83"/><area shape="rect" id="node13" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. " alt="" coords="1047,157,1169,184"/><area shape="rect" id="node15" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . " alt="" coords="705,183,775,209"/><area shape="rect" id="node24" href="usb_8c.html#a25ded61622ec9349905b5aa2ed2cb48b" title="brief . " alt="" coords="699,411,781,437"/><area shape="rect" id="node25" href="devnode_8c.html#a0c3d1e3cd90f43a9b5ee0793f4a75041" title="Create a dev path for the keyboard at index. Returns 0 on success. " alt="" coords="697,461,783,488"/><area shape="rect" id="node28" href="usb_8c.html#af87f830e031d8f63d2d1c3fc14fdad20" title="brief . " alt="" coords="1065,563,1151,589"/><area shape="rect" id="node29" href="usb_8c.html#a8e6389e8183a834fedb6ed317dd26f94" title="brief . " alt="" coords="1067,613,1149,640"/><area shape="rect" id="node30" href="usb_8h.html#a9e5784bfca2e4612f498ce67c7dab275" title="os_inputmain is run in a separate thread and will be detached from the main thread, so it needs to clean up its own resources. " alt="" coords="691,683,789,709"/><area shape="rect" id="node43" href="input_8h.html#ac73b3c2c38b916b901b4cca6b350a863" title="os_inputopen " alt="" coords="691,771,789,797"/><area shape="rect" id="node45" href="input_8h.html#a081bbacaa312d4a1a63bc1cab5d3520f" title="os_setupindicators" alt="" coords="675,897,805,924"/><area shape="rect" id="node47" href="usb_8h.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb OS&#45;specific setup for a specific usb device. " alt="" coords="692,980,788,1007"/><area shape="rect" id="node49" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset" alt="" coords="878,1069,973,1096"/><area shape="rect" id="node7" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb unclaim it, destroy the udev device and clear data structures at kb " alt="" coords="1061,5,1155,32"/><area shape="rect" id="node9" href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a" title="os_inputclose" alt="" coords="1057,56,1159,83"/><area shape="rect" id="node10" href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f" title="Remove the dev path for the keyboard at index. Returns 0 on success. " alt="" coords="1067,107,1149,133"/><area shape="rect" id="node8" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="1239,5,1327,32"/><area shape="rect" id="node11" href="devnode_8c.html#a9d97ede033e4f6c6bdd1c66fc82aa15e" title="_rmnotifynode" alt="" coords="1231,157,1335,184"/><area shape="rect" id="node12" href="devnode_8c.html#aac8f6f936a0ff6c16adc677622b226c4" title="rm_recursive" alt="" coords="1234,259,1331,285"/><area shape="rect" id="node14" href="devnode_8c.html#acc36eaba5eb854461ab3c0a4d146e9c9" title="_updateconnected Update the list of connected devices. " alt="" coords="1219,360,1347,387"/><area shape="rect" id="node16" href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9" title="readcmd" alt="" coords="889,309,961,336"/><area shape="rect" id="node21" href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7" title="readlines" alt="" coords="888,208,963,235"/><area shape="rect" id="node22" href="devnode_8c.html#a588ab2c69fcb283a5beb90c49a165979" title="readlines_ctx_free" alt="" coords="861,107,989,133"/><area shape="rect" id="node23" href="devnode_8c.html#ac118005c75badc2028b4921be8d9bdd0" title="readlines_ctx_init" alt="" coords="864,157,987,184"/><area shape="rect" id="node17" href="devnode_8c.html#a981305884de053a41d337efac23900ec" title="Creates a notification node for the specified keyboard. " alt="" coords="1058,309,1158,336"/><area shape="rect" id="node19" href="settingswidget_8cpp.html#a184e8402a94481ba2f47ba063272525b" title="right" alt="" coords="1085,259,1131,285"/><area shape="rect" id="node20" href="devnode_8c.html#a40e40a8ea3edccbfd8fdfefc44a76206" title="Removes a notification node for the specified keyboard. " alt="" coords="1059,208,1157,235"/><area shape="rect" id="node18" href="devnode_8c.html#a38fcf6ff044f9249ae04234340ee8e7b" title="_mknotifynode" alt="" coords="1229,461,1336,488"/><area shape="rect" id="node26" href="devnode_8c.html#a81c81014b2dfa89e326dd61769842953" title="_mkdevpath" alt="" coords="879,461,972,488"/><area shape="rect" id="node27" href="devnode_8c.html#ad130425a617cf973b28603a72607a057" title="Writes a keyboard&#39;s firmware version and poll rate to its device node. " alt="" coords="1067,461,1149,488"/><area shape="rect" id="node31" href="keymap_8c.html#ad39ede76abd657f5123fa331853db017" title="corsair_kbcopy" alt="" coords="870,715,981,741"/><area shape="rect" id="node32" href="keymap_8c.html#a0dc9a16564cc51b35a35d28af1a96fb0" title="corsair_mousecopy" alt="" coords="858,765,993,792"/><area shape="rect" id="node33" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889" title="hid_kb_translate" alt="" coords="867,816,984,843"/><area shape="rect" id="node34" href="keymap_8c.html#a092f675ff366b5823c73b25f83d513f9" title="hid_mouse_translate" alt="" coords="854,613,997,640"/><area shape="rect" id="node35" href="input_8c.html#ae360d0b9a764a1d38c5be5464be8b70a" title="inputupdate" alt="" coords="881,664,970,691"/><area shape="rect" id="node36" href="input_8c.html#aed8e9842ed5750c1d328c5dc4c1ba2bd" title="inputupdate_keys" alt="" coords="1046,664,1170,691"/><area shape="rect" id="node42" href="input_8h.html#a9f2cfb2d883ae4a3732047fe3f3da683" title="os_mousemove" alt="" coords="1225,715,1340,741"/><area shape="rect" id="node37" href="input_8c.html#abd38419ce56379559481f51d9491adeb" title="macromask" alt="" coords="1237,613,1328,640"/><area shape="rect" id="node38" href="notify_8c.html#ac2411c0997dfdbefdebd45f2584a5d04" title="nprintkey" alt="" coords="1245,563,1320,589"/><area shape="rect" id="node40" href="input_8h.html#af0d3401f317f3214dadad7d1a3378c58" title="os_keypress" alt="" coords="1235,664,1331,691"/><area shape="rect" id="node39" href="notify_8c.html#a7ac88f15243030290e4d57c3c9ac7c98" title="nprintf" alt="" coords="1395,563,1453,589"/><area shape="rect" id="node41" href="input__linux_8c.html#a14ff0fdf147e3702197db2cadb878460" title="isync" alt="" coords="1397,689,1451,716"/><area shape="rect" id="node44" href="input__linux_8c.html#a5f050529d49f8cb5e8dda4617c5984b7" title="uinputopen" alt="" coords="883,867,968,893"/><area shape="rect" id="node46" href="input__linux_8c.html#a5d40cc9137eaefbc2d860fac76020460" title="_ledthread" alt="" coords="884,917,967,944"/><area shape="rect" id="node48" href="usb__linux_8c.html#ab694a2ac859b16b5af802b4484f5ba0b" title="strtrim" alt="" coords="896,1019,955,1045"/><area shape="rect" id="node50" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626" title="usbclaim" alt="" coords="888,968,963,995"/></map>
</div>
</p>

<p><div id="dynsection-16" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-16-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-16-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-16-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_ad56c1e4ec53bbd6b947cb535590328ea_icgraph.png" border="0" usemap="#usb__linux_8c_ad56c1e4ec53bbd6b947cb535590328ea_icgraph" alt=""/></div>
<map name="usb__linux_8c_ad56c1e4ec53bbd6b947cb535590328ea_icgraph" id="usb__linux_8c_ad56c1e4ec53bbd6b947cb535590328ea_icgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="145,5,215,32"/><area shape="rect" id="node3" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="264,5,315,32"/><area shape="rect" id="node4" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="363,5,421,32"/><area shape="rect" id="node5" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="469,5,560,32"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a50efc8ee0ffcb6f201735d1a3bb08779"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int usb_add_device </td>
          <td>(</td>
          <td class="paramtype">struct udev_device *&#160;</td>
          <td class="paramname"><em>dev</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>If the device id can be found, call <a class="el" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034">usbadd()</a> with the appropriate parameters. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dev</td><td>the functions usb_*_device get a struct udev* with the neccessary hardware-related information. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the retval of <a class="el" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034">usbadd()</a> or 1 if either vendor is not corsair or product is not mentioned in model[].</dd></dl>
<p>First get the idVendor via udev_device_get_sysattr_value(). If this is equal to the ID-string of corsair ("1b1c"), get the idProduct on the same way. <br/>
 If we can find the model name in the model array, call <a class="el" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034">usbadd()</a> with the model number. </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000021">Todo:</a></b></dt><dd>So why the hell not a transformation between the string and the short presentation? Lets check if the string representation is used elsewhere. </dd></dl>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00694">694</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="usb__linux_8c_source.html#l00681">N_MODELS</a>, <a class="el" href="usb__linux_8c_source.html#l00592">usbadd()</a>, <a class="el" href="usb_8h_source.html#l00038">V_CORSAIR</a>, and <a class="el" href="usb_8h_source.html#l00039">V_CORSAIR_STR</a>.</p>

<p>Referenced by <a class="el" href="usb__linux_8c_source.html#l00746">udev_enum()</a>, and <a class="el" href="usb__linux_8c_source.html#l00774">usbmain()</a>.</p>
<div class="fragment"><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;                                                  {</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>* vendor = udev_device_get_sysattr_value(dev, <span class="stringliteral">&quot;idVendor&quot;</span>);</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    <span class="keywordflow">if</span>(vendor &amp;&amp; !strcmp(vendor, <a class="code" href="usb_8h.html#a0a9288dd24752f04930cbf9e673e536c">V_CORSAIR_STR</a>)){</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span>* product = udev_device_get_sysattr_value(dev, <span class="stringliteral">&quot;idProduct&quot;</span>);</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        <span class="keywordflow">if</span>(product){</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;            <span class="keywordflow">for</span>(<a class="code" href="usb__linux_8c.html#struct__model">_model</a>* model = <a class="code" href="usb__linux_8c.html#ac1888fdd0cb519fd7ff5768437629b8b">models</a>; model &lt; <a class="code" href="usb__linux_8c.html#ac1888fdd0cb519fd7ff5768437629b8b">models</a> + <a class="code" href="usb__linux_8c.html#a8d8cfcf715f178c0e85ce011e7a9bcbf">N_MODELS</a>; model++){</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;                <span class="keywordflow">if</span>(!strcmp(product, model-&gt;name)){</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034">usbadd</a>(dev, <a class="code" href="usb_8h.html#a2aa27325e30aac7dcec6203d4f11e996">V_CORSAIR</a>, model-&gt;number);</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                }</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;            }</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        }</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    }</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;}</div>
<div class="ttc" id="usb__linux_8c_html_struct__model"><div class="ttname"><a href="usb__linux_8c.html#struct__model">_model</a></div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00644">usb_linux.c:644</a></div></div>
<div class="ttc" id="usb__linux_8c_html_a3185d6da36c8b0f8b862a8479ae82034"><div class="ttname"><a href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034">usbadd</a></div><div class="ttdeci">int usbadd(struct udev_device *dev, short vendor, short product)</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00592">usb_linux.c:592</a></div></div>
<div class="ttc" id="usb__linux_8c_html_a8d8cfcf715f178c0e85ce011e7a9bcbf"><div class="ttname"><a href="usb__linux_8c.html#a8d8cfcf715f178c0e85ce011e7a9bcbf">N_MODELS</a></div><div class="ttdeci">#define N_MODELS</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00681">usb_linux.c:681</a></div></div>
<div class="ttc" id="usb__linux_8c_html_ac1888fdd0cb519fd7ff5768437629b8b"><div class="ttname"><a href="usb__linux_8c.html#ac1888fdd0cb519fd7ff5768437629b8b">models</a></div><div class="ttdeci">static _model models[]</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00654">usb_linux.c:654</a></div></div>
<div class="ttc" id="usb_8h_html_a0a9288dd24752f04930cbf9e673e536c"><div class="ttname"><a href="usb_8h.html#a0a9288dd24752f04930cbf9e673e536c">V_CORSAIR_STR</a></div><div class="ttdeci">#define V_CORSAIR_STR</div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00039">usb.h:39</a></div></div>
<div class="ttc" id="usb_8h_html_a2aa27325e30aac7dcec6203d4f11e996"><div class="ttname"><a href="usb_8h.html#a2aa27325e30aac7dcec6203d4f11e996">V_CORSAIR</a></div><div class="ttdeci">#define V_CORSAIR</div><div class="ttdoc">For the following Defines please see &quot;Detailed Description&quot;. </div><div class="ttdef"><b>Definition:</b> <a href="usb_8h_source.html#l00038">usb.h:38</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-17" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-17-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-17-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-17-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a50efc8ee0ffcb6f201735d1a3bb08779_cgraph.png" border="0" usemap="#usb__linux_8c_a50efc8ee0ffcb6f201735d1a3bb08779_cgraph" alt=""/></div>
<map name="usb__linux_8c_a50efc8ee0ffcb6f201735d1a3bb08779_cgraph" id="usb__linux_8c_a50efc8ee0ffcb6f201735d1a3bb08779_cgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="171,537,235,564"/><area shape="rect" id="node3" href="usb_8c.html#a1ab9d61dd894466125283465201161cd" title="setupusb" alt="" coords="283,537,357,564"/><area shape="rect" id="node4" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="405,537,488,564"/><area shape="rect" id="node5" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431" title="closeusb" alt="" coords="749,56,824,83"/><area shape="rect" id="node12" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. " alt="" coords="909,157,1030,184"/><area shape="rect" id="node14" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . " alt="" coords="566,183,637,209"/><area shape="rect" id="node23" href="usb_8c.html#a25ded61622ec9349905b5aa2ed2cb48b" title="brief . " alt="" coords="560,411,643,437"/><area shape="rect" id="node24" href="devnode_8c.html#a0c3d1e3cd90f43a9b5ee0793f4a75041" title="Create a dev path for the keyboard at index. Returns 0 on success. " alt="" coords="558,461,645,488"/><area shape="rect" id="node27" href="usb_8c.html#af87f830e031d8f63d2d1c3fc14fdad20" title="brief . " alt="" coords="926,563,1013,589"/><area shape="rect" id="node28" href="usb_8c.html#a8e6389e8183a834fedb6ed317dd26f94" title="brief . " alt="" coords="928,613,1011,640"/><area shape="rect" id="node29" href="usb_8h.html#a9e5784bfca2e4612f498ce67c7dab275" title="os_inputmain is run in a separate thread and will be detached from the main thread, so it needs to clean up its own resources. " alt="" coords="552,683,651,709"/><area shape="rect" id="node42" href="input_8h.html#ac73b3c2c38b916b901b4cca6b350a863" title="os_inputopen " alt="" coords="552,771,651,797"/><area shape="rect" id="node44" href="input_8h.html#a081bbacaa312d4a1a63bc1cab5d3520f" title="os_setupindicators" alt="" coords="536,897,667,924"/><area shape="rect" id="node46" href="usb_8h.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb OS&#45;specific setup for a specific usb device. " alt="" coords="553,980,649,1007"/><area shape="rect" id="node48" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset" alt="" coords="739,1069,834,1096"/><area shape="rect" id="node6" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb unclaim it, destroy the udev device and clear data structures at kb " alt="" coords="922,5,1017,32"/><area shape="rect" id="node8" href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a" title="os_inputclose" alt="" coords="918,56,1021,83"/><area shape="rect" id="node9" href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f" title="Remove the dev path for the keyboard at index. Returns 0 on success. " alt="" coords="928,107,1011,133"/><area shape="rect" id="node7" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="1100,5,1188,32"/><area shape="rect" id="node10" href="devnode_8c.html#a9d97ede033e4f6c6bdd1c66fc82aa15e" title="_rmnotifynode" alt="" coords="1092,157,1196,184"/><area shape="rect" id="node11" href="devnode_8c.html#aac8f6f936a0ff6c16adc677622b226c4" title="rm_recursive" alt="" coords="1095,259,1193,285"/><area shape="rect" id="node13" href="devnode_8c.html#acc36eaba5eb854461ab3c0a4d146e9c9" title="_updateconnected Update the list of connected devices. " alt="" coords="1080,360,1208,387"/><area shape="rect" id="node15" href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9" title="readcmd" alt="" coords="751,309,823,336"/><area shape="rect" id="node20" href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7" title="readlines" alt="" coords="749,208,824,235"/><area shape="rect" id="node21" href="devnode_8c.html#a588ab2c69fcb283a5beb90c49a165979" title="readlines_ctx_free" alt="" coords="723,107,851,133"/><area shape="rect" id="node22" href="devnode_8c.html#ac118005c75badc2028b4921be8d9bdd0" title="readlines_ctx_init" alt="" coords="725,157,848,184"/><area shape="rect" id="node16" href="devnode_8c.html#a981305884de053a41d337efac23900ec" title="Creates a notification node for the specified keyboard. " alt="" coords="919,309,1019,336"/><area shape="rect" id="node18" href="settingswidget_8cpp.html#a184e8402a94481ba2f47ba063272525b" title="right" alt="" coords="946,259,993,285"/><area shape="rect" id="node19" href="devnode_8c.html#a40e40a8ea3edccbfd8fdfefc44a76206" title="Removes a notification node for the specified keyboard. " alt="" coords="921,208,1018,235"/><area shape="rect" id="node17" href="devnode_8c.html#a38fcf6ff044f9249ae04234340ee8e7b" title="_mknotifynode" alt="" coords="1091,461,1197,488"/><area shape="rect" id="node25" href="devnode_8c.html#a81c81014b2dfa89e326dd61769842953" title="_mkdevpath" alt="" coords="740,461,833,488"/><area shape="rect" id="node26" href="devnode_8c.html#ad130425a617cf973b28603a72607a057" title="Writes a keyboard&#39;s firmware version and poll rate to its device node. " alt="" coords="928,461,1011,488"/><area shape="rect" id="node30" href="keymap_8c.html#ad39ede76abd657f5123fa331853db017" title="corsair_kbcopy" alt="" coords="731,715,842,741"/><area shape="rect" id="node31" href="keymap_8c.html#a0dc9a16564cc51b35a35d28af1a96fb0" title="corsair_mousecopy" alt="" coords="719,765,854,792"/><area shape="rect" id="node32" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889" title="hid_kb_translate" alt="" coords="728,816,845,843"/><area shape="rect" id="node33" href="keymap_8c.html#a092f675ff366b5823c73b25f83d513f9" title="hid_mouse_translate" alt="" coords="715,613,858,640"/><area shape="rect" id="node34" href="input_8c.html#ae360d0b9a764a1d38c5be5464be8b70a" title="inputupdate" alt="" coords="742,664,831,691"/><area shape="rect" id="node35" href="input_8c.html#aed8e9842ed5750c1d328c5dc4c1ba2bd" title="inputupdate_keys" alt="" coords="907,664,1031,691"/><area shape="rect" id="node41" href="input_8h.html#a9f2cfb2d883ae4a3732047fe3f3da683" title="os_mousemove" alt="" coords="1087,715,1201,741"/><area shape="rect" id="node36" href="input_8c.html#abd38419ce56379559481f51d9491adeb" title="macromask" alt="" coords="1099,613,1189,640"/><area shape="rect" id="node37" href="notify_8c.html#ac2411c0997dfdbefdebd45f2584a5d04" title="nprintkey" alt="" coords="1107,563,1181,589"/><area shape="rect" id="node39" href="input_8h.html#af0d3401f317f3214dadad7d1a3378c58" title="os_keypress" alt="" coords="1096,664,1192,691"/><area shape="rect" id="node38" href="notify_8c.html#a7ac88f15243030290e4d57c3c9ac7c98" title="nprintf" alt="" coords="1256,563,1315,589"/><area shape="rect" id="node40" href="input__linux_8c.html#a14ff0fdf147e3702197db2cadb878460" title="isync" alt="" coords="1259,689,1312,716"/><area shape="rect" id="node43" href="input__linux_8c.html#a5f050529d49f8cb5e8dda4617c5984b7" title="uinputopen" alt="" coords="744,867,829,893"/><area shape="rect" id="node45" href="input__linux_8c.html#a5d40cc9137eaefbc2d860fac76020460" title="_ledthread" alt="" coords="745,917,828,944"/><area shape="rect" id="node47" href="usb__linux_8c.html#ab694a2ac859b16b5af802b4484f5ba0b" title="strtrim" alt="" coords="757,1019,816,1045"/><area shape="rect" id="node49" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626" title="usbclaim" alt="" coords="749,968,824,995"/></map>
</div>
</p>

<p><div id="dynsection-18" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-18-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-18-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-18-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a50efc8ee0ffcb6f201735d1a3bb08779_icgraph.png" border="0" usemap="#usb__linux_8c_a50efc8ee0ffcb6f201735d1a3bb08779_icgraph" alt=""/></div>
<map name="usb__linux_8c_a50efc8ee0ffcb6f201735d1a3bb08779_icgraph" id="usb__linux_8c_a50efc8ee0ffcb6f201735d1a3bb08779_icgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="171,5,261,32"/><area shape="rect" id="node3" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="310,31,381,57"/><area shape="rect" id="node4" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="429,31,480,57"/><area shape="rect" id="node5" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="528,31,587,57"/><area shape="rect" id="node6" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="635,31,725,57"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="adeffaa2b04d01b15c8623255719420ef"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void usb_rm_device </td>
          <td>(</td>
          <td class="paramtype">struct udev_device *&#160;</td>
          <td class="paramname"><em>dev</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dev</td><td>the functions usb_*_device get a struct udev* with the neccessary hardware-related information.</td></tr>
  </table>
  </dd>
</dl>
<p>First try to find the system path of the device given in parameter dev. The index where the name is found is the same index we need to address the global keyboard array. That array holds all usbdevices. <br/>
 Searching for the correct name in kbsyspath-array and closing the usb via <a class="el" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431">closeusb()</a> are protected by lock..unlock of the corresponding devmutex arraymember. </p>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00719">719</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="usb_8c_source.html#l00675">closeusb()</a>, <a class="el" href="device_8h_source.html#l00008">DEV_MAX</a>, <a class="el" href="device_8c_source.html#l00012">devmutex</a>, <a class="el" href="usb__linux_8c_source.html#l00013">kbsyspath</a>, and <a class="el" href="device_8c_source.html#l00010">keyboard</a>.</p>

<p>Referenced by <a class="el" href="usb__linux_8c_source.html#l00774">usbmain()</a>.</p>
<div class="fragment"><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                                                  {</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <span class="comment">// Device removed. Look for it in our list of keyboards</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>* syspath = udev_device_get_syspath(dev);</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <span class="keywordflow">if</span>(!syspath || syspath[0] == 0)</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 1; i &lt; <a class="code" href="device_8h.html#a6f24fd113f93f8ad65c27467a83f118c">DEV_MAX</a>; i++){</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        pthread_mutex_lock(<a class="code" href="device_8c.html#aca7076170e3f264e2960ebd508fff190">devmutex</a> + i);</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        <span class="keywordflow">if</span>(!strcmp(syspath, <a class="code" href="usb__linux_8c.html#a1b952c601049b156fe39d96473aaca3a">kbsyspath</a>[i]))</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;            <a class="code" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431">closeusb</a>(<a class="code" href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a> + i);</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        pthread_mutex_unlock(<a class="code" href="device_8c.html#aca7076170e3f264e2960ebd508fff190">devmutex</a> + i);</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    }</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;}</div>
<div class="ttc" id="usb__linux_8c_html_a1b952c601049b156fe39d96473aaca3a"><div class="ttname"><a href="usb__linux_8c.html#a1b952c601049b156fe39d96473aaca3a">kbsyspath</a></div><div class="ttdeci">static char kbsyspath[9][FILENAME_MAX]</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00013">usb_linux.c:13</a></div></div>
<div class="ttc" id="device_8c_html_a5f2ad0f3998226c000c52c5c375c2661"><div class="ttname"><a href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a></div><div class="ttdeci">usbdevice keyboard[9]</div><div class="ttdoc">remember all usb devices. Needed for closeusb(). </div><div class="ttdef"><b>Definition:</b> <a href="device_8c_source.html#l00010">device.c:10</a></div></div>
<div class="ttc" id="device_8c_html_aca7076170e3f264e2960ebd508fff190"><div class="ttname"><a href="device_8c.html#aca7076170e3f264e2960ebd508fff190">devmutex</a></div><div class="ttdeci">pthread_mutex_t devmutex[9]</div><div class="ttdef"><b>Definition:</b> <a href="device_8c_source.html#l00012">device.c:12</a></div></div>
<div class="ttc" id="usb_8c_html_a8732b3ade76da4ae362996232ef95431"><div class="ttname"><a href="usb_8c.html#a8732b3ade76da4ae362996232ef95431">closeusb</a></div><div class="ttdeci">int closeusb(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00675">usb.c:675</a></div></div>
<div class="ttc" id="device_8h_html_a6f24fd113f93f8ad65c27467a83f118c"><div class="ttname"><a href="device_8h.html#a6f24fd113f93f8ad65c27467a83f118c">DEV_MAX</a></div><div class="ttdeci">#define DEV_MAX</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00008">device.h:8</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-19" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-19-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-19-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-19-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_adeffaa2b04d01b15c8623255719420ef_cgraph.png" border="0" usemap="#usb__linux_8c_adeffaa2b04d01b15c8623255719420ef_cgraph" alt=""/></div>
<map name="usb__linux_8c_adeffaa2b04d01b15c8623255719420ef_cgraph" id="usb__linux_8c_adeffaa2b04d01b15c8623255719420ef_cgraph">
<area shape="rect" id="node2" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431" title="closeusb" alt="" coords="165,81,240,108"/><area shape="rect" id="node3" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb unclaim it, destroy the udev device and clear data structures at kb " alt="" coords="302,5,397,32"/><area shape="rect" id="node5" href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a" title="os_inputclose" alt="" coords="298,56,401,83"/><area shape="rect" id="node6" href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f" title="Remove the dev path for the keyboard at index. Returns 0 on success. " alt="" coords="308,107,391,133"/><area shape="rect" id="node9" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. " alt="" coords="289,157,410,184"/><area shape="rect" id="node4" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="479,5,567,32"/><area shape="rect" id="node7" href="devnode_8c.html#a9d97ede033e4f6c6bdd1c66fc82aa15e" title="_rmnotifynode" alt="" coords="471,56,575,83"/><area shape="rect" id="node8" href="devnode_8c.html#aac8f6f936a0ff6c16adc677622b226c4" title="rm_recursive" alt="" coords="474,107,571,133"/><area shape="rect" id="node10" href="devnode_8c.html#acc36eaba5eb854461ab3c0a4d146e9c9" title="_updateconnected Update the list of connected devices. " alt="" coords="459,157,587,184"/></map>
</div>
</p>

<p><div id="dynsection-20" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-20-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-20-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-20-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_adeffaa2b04d01b15c8623255719420ef_icgraph.png" border="0" usemap="#usb__linux_8c_adeffaa2b04d01b15c8623255719420ef_icgraph" alt=""/></div>
<map name="usb__linux_8c_adeffaa2b04d01b15c8623255719420ef_icgraph" id="usb__linux_8c_adeffaa2b04d01b15c8623255719420ef_icgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="166,5,237,32"/><area shape="rect" id="node3" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="285,5,336,32"/><area shape="rect" id="node4" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="384,5,443,32"/><area shape="rect" id="node5" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="491,5,581,32"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a3185d6da36c8b0f8b862a8479ae82034"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int usbadd </td>
          <td>(</td>
          <td class="paramtype">struct udev_device *&#160;</td>
          <td class="paramname"><em>dev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short&#160;</td>
          <td class="paramname"><em>vendor</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short&#160;</td>
          <td class="paramname"><em>product</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00592">592</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00050">ckb_err</a>, <a class="el" href="includes_8h_source.html#l00056">ckb_info</a>, <a class="el" href="device_8h_source.html#l00008">DEV_MAX</a>, <a class="el" href="device_8h_source.html#l00018">dmutex</a>, <a class="el" href="structures_8h_source.html#l00187">usbdevice::handle</a>, <a class="el" href="device_8h_source.html#l00012">IS_CONNECTED</a>, <a class="el" href="usb__linux_8c_source.html#l00013">kbsyspath</a>, <a class="el" href="device_8c_source.html#l00010">keyboard</a>, <a class="el" href="structures_8h_source.html#l00237">usbdevice::product</a>, <a class="el" href="usb_8c_source.html#l00386">setupusb()</a>, <a class="el" href="structures_8h_source.html#l00186">usbdevice::udev</a>, and <a class="el" href="structures_8h_source.html#l00237">usbdevice::vendor</a>.</p>

<p>Referenced by <a class="el" href="usb__linux_8c_source.html#l00694">usb_add_device()</a>.</p>
<div class="fragment"><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                                                                 {</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>* path = udev_device_get_devnode(dev);</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>* syspath = udev_device_get_syspath(dev);</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <span class="keywordflow">if</span>(!path || !syspath || path[0] == 0 || syspath[0] == 0){</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        <a class="code" href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a>(<span class="stringliteral">&quot;Failed to get device path\n&quot;</span>);</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    }</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="preprocessor"></span>    <a class="code" href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a>(<span class="stringliteral">&quot;&gt;&gt;&gt;vendor = 0x%x, product = 0x%x, path = %s, syspath = %s\n&quot;</span>, vendor, product, path, syspath);</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="preprocessor">#endif // DEDBUG</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;<span class="preprocessor"></span>    <span class="comment">// Find a free USB slot</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> index = 1; index &lt; <a class="code" href="device_8h.html#a6f24fd113f93f8ad65c27467a83f118c">DEV_MAX</a>; index++){</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <a class="code" href="structures_8h.html#structusbdevice">usbdevice</a>* kb = <a class="code" href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a> + index;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        <span class="keywordflow">if</span>(pthread_mutex_trylock(<a class="code" href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a>(kb))){</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;            <span class="comment">// If the mutex is locked then the device is obviously in use, so keep going</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;            <span class="keywordflow">if</span>(!strcmp(syspath, <a class="code" href="usb__linux_8c.html#a1b952c601049b156fe39d96473aaca3a">kbsyspath</a>[index])){</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                <span class="comment">// Make sure this existing keyboard doesn&#39;t have the same syspath (this shouldn&#39;t happen)</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;            }</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        }</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        <span class="keywordflow">if</span>(!<a class="code" href="device_8h.html#abc841468973d04a23aad362c4387bc93">IS_CONNECTED</a>(kb)){</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            <span class="comment">// Open the sysfs device</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;            kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> = open(path, O_RDWR) + 1;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            <span class="keywordflow">if</span>(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> &lt;= 0){</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                <a class="code" href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a>(<span class="stringliteral">&quot;Failed to open USB device: %s\n&quot;</span>, strerror(errno));</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> = 0;</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                pthread_mutex_unlock(<a class="code" href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a>(kb));</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                <span class="comment">// Set up device</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                kb-&gt;<a class="code" href="structures_8h.html#a050b6c1c162175c0e9abe16141770460">udev</a> = dev;</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                kb-&gt;<a class="code" href="structures_8h.html#a2fa713366249e2fdbb2539e5d65a1439">vendor</a> = vendor;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                kb-&gt;<a class="code" href="structures_8h.html#a045b6c91e3f04e54f25d39da9bda105b">product</a> = product;</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                strncpy(<a class="code" href="usb__linux_8c.html#a1b952c601049b156fe39d96473aaca3a">kbsyspath</a>[index], syspath, FILENAME_MAX);</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                <span class="comment">// Mutex remains locked</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                <a class="code" href="usb_8c.html#a1ab9d61dd894466125283465201161cd">setupusb</a>(kb);</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;            }</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        }</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        pthread_mutex_unlock(<a class="code" href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a>(kb));</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    }</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    <a class="code" href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a>(<span class="stringliteral">&quot;No free devices\n&quot;</span>);</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;}</div>
<div class="ttc" id="usb__linux_8c_html_a1b952c601049b156fe39d96473aaca3a"><div class="ttname"><a href="usb__linux_8c.html#a1b952c601049b156fe39d96473aaca3a">kbsyspath</a></div><div class="ttdeci">static char kbsyspath[9][FILENAME_MAX]</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00013">usb_linux.c:13</a></div></div>
<div class="ttc" id="usb_8c_html_a1ab9d61dd894466125283465201161cd"><div class="ttname"><a href="usb_8c.html#a1ab9d61dd894466125283465201161cd">setupusb</a></div><div class="ttdeci">void setupusb(usbdevice *kb)</div><div class="ttdef"><b>Definition:</b> <a href="usb_8c_source.html#l00386">usb.c:386</a></div></div>
<div class="ttc" id="device_8h_html_abc841468973d04a23aad362c4387bc93"><div class="ttname"><a href="device_8h.html#abc841468973d04a23aad362c4387bc93">IS_CONNECTED</a></div><div class="ttdeci">#define IS_CONNECTED(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00012">device.h:12</a></div></div>
<div class="ttc" id="includes_8h_html_a8312a1a42e03986afb7c76557f4d3e25"><div class="ttname"><a href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a></div><div class="ttdeci">#define ckb_err(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00050">includes.h:50</a></div></div>
<div class="ttc" id="device_8c_html_a5f2ad0f3998226c000c52c5c375c2661"><div class="ttname"><a href="device_8c.html#a5f2ad0f3998226c000c52c5c375c2661">keyboard</a></div><div class="ttdeci">usbdevice keyboard[9]</div><div class="ttdoc">remember all usb devices. Needed for closeusb(). </div><div class="ttdef"><b>Definition:</b> <a href="device_8c_source.html#l00010">device.c:10</a></div></div>
<div class="ttc" id="structures_8h_html_a050b6c1c162175c0e9abe16141770460"><div class="ttname"><a href="structures_8h.html#a050b6c1c162175c0e9abe16141770460">usbdevice::udev</a></div><div class="ttdeci">struct udev_device * udev</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00186">structures.h:186</a></div></div>
<div class="ttc" id="includes_8h_html_af3b6c3fbbe2da20e4058fd83084329a6"><div class="ttname"><a href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a></div><div class="ttdeci">#define ckb_info(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00056">includes.h:56</a></div></div>
<div class="ttc" id="structures_8h_html_a045b6c91e3f04e54f25d39da9bda105b"><div class="ttname"><a href="structures_8h.html#a045b6c91e3f04e54f25d39da9bda105b">usbdevice::product</a></div><div class="ttdeci">short product</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00237">structures.h:237</a></div></div>
<div class="ttc" id="structures_8h_html_structusbdevice"><div class="ttname"><a href="structures_8h.html#structusbdevice">usbdevice</a></div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00178">structures.h:178</a></div></div>
<div class="ttc" id="structures_8h_html_a1e1d8c37298aa076d30ba95dd97465ef"><div class="ttname"><a href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">usbdevice::handle</a></div><div class="ttdeci">int handle</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00187">structures.h:187</a></div></div>
<div class="ttc" id="device_8h_html_a6f24fd113f93f8ad65c27467a83f118c"><div class="ttname"><a href="device_8h.html#a6f24fd113f93f8ad65c27467a83f118c">DEV_MAX</a></div><div class="ttdeci">#define DEV_MAX</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00008">device.h:8</a></div></div>
<div class="ttc" id="device_8h_html_a96bbdd939f65eebc392e07d74e6e6605"><div class="ttname"><a href="device_8h.html#a96bbdd939f65eebc392e07d74e6e6605">dmutex</a></div><div class="ttdeci">#define dmutex(kb)</div><div class="ttdef"><b>Definition:</b> <a href="device_8h_source.html#l00018">device.h:18</a></div></div>
<div class="ttc" id="structures_8h_html_a2fa713366249e2fdbb2539e5d65a1439"><div class="ttname"><a href="structures_8h.html#a2fa713366249e2fdbb2539e5d65a1439">usbdevice::vendor</a></div><div class="ttdeci">short vendor</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00237">structures.h:237</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-21" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-21-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-21-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-21-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a3185d6da36c8b0f8b862a8479ae82034_cgraph.png" border="0" usemap="#usb__linux_8c_a3185d6da36c8b0f8b862a8479ae82034_cgraph" alt=""/></div>
<map name="usb__linux_8c_a3185d6da36c8b0f8b862a8479ae82034_cgraph" id="usb__linux_8c_a3185d6da36c8b0f8b862a8479ae82034_cgraph">
<area shape="rect" id="node2" href="usb_8c.html#a1ab9d61dd894466125283465201161cd" title="setupusb" alt="" coords="117,537,192,564"/><area shape="rect" id="node3" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="240,537,323,564"/><area shape="rect" id="node4" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431" title="closeusb" alt="" coords="584,56,659,83"/><area shape="rect" id="node11" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. " alt="" coords="743,157,865,184"/><area shape="rect" id="node13" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . " alt="" coords="401,183,471,209"/><area shape="rect" id="node22" href="usb_8c.html#a25ded61622ec9349905b5aa2ed2cb48b" title="brief . " alt="" coords="395,411,477,437"/><area shape="rect" id="node23" href="devnode_8c.html#a0c3d1e3cd90f43a9b5ee0793f4a75041" title="Create a dev path for the keyboard at index. Returns 0 on success. " alt="" coords="393,461,479,488"/><area shape="rect" id="node26" href="usb_8c.html#af87f830e031d8f63d2d1c3fc14fdad20" title="brief . " alt="" coords="761,563,847,589"/><area shape="rect" id="node27" href="usb_8c.html#a8e6389e8183a834fedb6ed317dd26f94" title="brief . " alt="" coords="763,613,845,640"/><area shape="rect" id="node28" href="usb_8h.html#a9e5784bfca2e4612f498ce67c7dab275" title="os_inputmain is run in a separate thread and will be detached from the main thread, so it needs to clean up its own resources. " alt="" coords="387,683,485,709"/><area shape="rect" id="node41" href="input_8h.html#ac73b3c2c38b916b901b4cca6b350a863" title="os_inputopen " alt="" coords="387,771,485,797"/><area shape="rect" id="node43" href="input_8h.html#a081bbacaa312d4a1a63bc1cab5d3520f" title="os_setupindicators" alt="" coords="371,897,501,924"/><area shape="rect" id="node45" href="usb_8h.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb OS&#45;specific setup for a specific usb device. " alt="" coords="388,980,484,1007"/><area shape="rect" id="node47" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset" alt="" coords="574,1069,669,1096"/><area shape="rect" id="node5" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb unclaim it, destroy the udev device and clear data structures at kb " alt="" coords="757,5,851,32"/><area shape="rect" id="node7" href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a" title="os_inputclose" alt="" coords="753,56,855,83"/><area shape="rect" id="node8" href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f" title="Remove the dev path for the keyboard at index. Returns 0 on success. " alt="" coords="763,107,845,133"/><area shape="rect" id="node6" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="935,5,1023,32"/><area shape="rect" id="node9" href="devnode_8c.html#a9d97ede033e4f6c6bdd1c66fc82aa15e" title="_rmnotifynode" alt="" coords="927,157,1031,184"/><area shape="rect" id="node10" href="devnode_8c.html#aac8f6f936a0ff6c16adc677622b226c4" title="rm_recursive" alt="" coords="930,259,1027,285"/><area shape="rect" id="node12" href="devnode_8c.html#acc36eaba5eb854461ab3c0a4d146e9c9" title="_updateconnected Update the list of connected devices. " alt="" coords="915,360,1043,387"/><area shape="rect" id="node14" href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9" title="readcmd" alt="" coords="585,309,657,336"/><area shape="rect" id="node19" href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7" title="readlines" alt="" coords="584,208,659,235"/><area shape="rect" id="node20" href="devnode_8c.html#a588ab2c69fcb283a5beb90c49a165979" title="readlines_ctx_free" alt="" coords="557,107,685,133"/><area shape="rect" id="node21" href="devnode_8c.html#ac118005c75badc2028b4921be8d9bdd0" title="readlines_ctx_init" alt="" coords="560,157,683,184"/><area shape="rect" id="node15" href="devnode_8c.html#a981305884de053a41d337efac23900ec" title="Creates a notification node for the specified keyboard. " alt="" coords="754,309,854,336"/><area shape="rect" id="node17" href="settingswidget_8cpp.html#a184e8402a94481ba2f47ba063272525b" title="right" alt="" coords="781,259,827,285"/><area shape="rect" id="node18" href="devnode_8c.html#a40e40a8ea3edccbfd8fdfefc44a76206" title="Removes a notification node for the specified keyboard. " alt="" coords="755,208,853,235"/><area shape="rect" id="node16" href="devnode_8c.html#a38fcf6ff044f9249ae04234340ee8e7b" title="_mknotifynode" alt="" coords="925,461,1032,488"/><area shape="rect" id="node24" href="devnode_8c.html#a81c81014b2dfa89e326dd61769842953" title="_mkdevpath" alt="" coords="575,461,668,488"/><area shape="rect" id="node25" href="devnode_8c.html#ad130425a617cf973b28603a72607a057" title="Writes a keyboard&#39;s firmware version and poll rate to its device node. " alt="" coords="763,461,845,488"/><area shape="rect" id="node29" href="keymap_8c.html#ad39ede76abd657f5123fa331853db017" title="corsair_kbcopy" alt="" coords="566,715,677,741"/><area shape="rect" id="node30" href="keymap_8c.html#a0dc9a16564cc51b35a35d28af1a96fb0" title="corsair_mousecopy" alt="" coords="554,765,689,792"/><area shape="rect" id="node31" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889" title="hid_kb_translate" alt="" coords="563,816,680,843"/><area shape="rect" id="node32" href="keymap_8c.html#a092f675ff366b5823c73b25f83d513f9" title="hid_mouse_translate" alt="" coords="550,613,693,640"/><area shape="rect" id="node33" href="input_8c.html#ae360d0b9a764a1d38c5be5464be8b70a" title="inputupdate" alt="" coords="577,664,666,691"/><area shape="rect" id="node34" href="input_8c.html#aed8e9842ed5750c1d328c5dc4c1ba2bd" title="inputupdate_keys" alt="" coords="742,664,866,691"/><area shape="rect" id="node40" href="input_8h.html#a9f2cfb2d883ae4a3732047fe3f3da683" title="os_mousemove" alt="" coords="921,715,1036,741"/><area shape="rect" id="node35" href="input_8c.html#abd38419ce56379559481f51d9491adeb" title="macromask" alt="" coords="933,613,1024,640"/><area shape="rect" id="node36" href="notify_8c.html#ac2411c0997dfdbefdebd45f2584a5d04" title="nprintkey" alt="" coords="941,563,1016,589"/><area shape="rect" id="node38" href="input_8h.html#af0d3401f317f3214dadad7d1a3378c58" title="os_keypress" alt="" coords="931,664,1027,691"/><area shape="rect" id="node37" href="notify_8c.html#a7ac88f15243030290e4d57c3c9ac7c98" title="nprintf" alt="" coords="1091,563,1149,589"/><area shape="rect" id="node39" href="input__linux_8c.html#a14ff0fdf147e3702197db2cadb878460" title="isync" alt="" coords="1093,689,1147,716"/><area shape="rect" id="node42" href="input__linux_8c.html#a5f050529d49f8cb5e8dda4617c5984b7" title="uinputopen" alt="" coords="579,867,664,893"/><area shape="rect" id="node44" href="input__linux_8c.html#a5d40cc9137eaefbc2d860fac76020460" title="_ledthread" alt="" coords="580,917,663,944"/><area shape="rect" id="node46" href="usb__linux_8c.html#ab694a2ac859b16b5af802b4484f5ba0b" title="strtrim" alt="" coords="592,1019,651,1045"/><area shape="rect" id="node48" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626" title="usbclaim" alt="" coords="584,968,659,995"/></map>
</div>
</p>

<p><div id="dynsection-22" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-22-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-22-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-22-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a3185d6da36c8b0f8b862a8479ae82034_icgraph.png" border="0" usemap="#usb__linux_8c_a3185d6da36c8b0f8b862a8479ae82034_icgraph" alt=""/></div>
<map name="usb__linux_8c_a3185d6da36c8b0f8b862a8479ae82034_icgraph" id="usb__linux_8c_a3185d6da36c8b0f8b862a8479ae82034_icgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="118,31,234,57"/><area shape="rect" id="node3" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="283,5,373,32"/><area shape="rect" id="node4" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="422,31,493,57"/><area shape="rect" id="node5" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="541,31,592,57"/><area shape="rect" id="node6" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="640,31,699,57"/><area shape="rect" id="node7" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="747,31,837,57"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a309cab8bf65221b01dc320f247abf626"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int usbclaim </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>usbclaim does claiming all EPs for the usb device gicen by kb. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">kb</td><td>THE usbdevice* </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, -1 otherwise.</dd></dl>
<p>Claim all endpoints for a given device (remeber the decrementing of the file descriptor) via ioctl(USBDEVFS_DISCONNECT) and ioctl(USBDEVFS_CLAIMINTERFACE).</p>
<p>Error handling is done for the ioctl(USBDEVFS_CLAIMINTERFACE) only. If this fails, now an error message is thrown and -1 is returned. Function is called in <a class="el" href="usb__linux_8c.html">usb_linux.c</a> only, so it is declared as static now. </p>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00457">457</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00050">ckb_err</a>, <a class="el" href="includes_8h_source.html#l00056">ckb_info</a>, <a class="el" href="structures_8h_source.html#l00215">usbdevice::epcount</a>, and <a class="el" href="structures_8h_source.html#l00187">usbdevice::handle</a>.</p>

<p>Referenced by <a class="el" href="usb__linux_8c_source.html#l00495">os_resetusb()</a>, and <a class="el" href="usb__linux_8c_source.html#l00533">os_setupusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                                  {</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    <span class="keywordtype">int</span> count = kb-&gt;<a class="code" href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">epcount</a>;</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="preprocessor"></span>    <a class="code" href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a>(<span class="stringliteral">&quot;claiming %d endpoints\n&quot;</span>, count);</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="preprocessor">#endif // DEBUG</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; count; i++){</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        <span class="keyword">struct </span>usbdevfs_ioctl ctl = { i, USBDEVFS_DISCONNECT, 0 };</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;        ioctl(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> - 1, USBDEVFS_IOCTL, &amp;ctl);</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        <span class="keywordflow">if</span>(ioctl(kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> - 1, USBDEVFS_CLAIMINTERFACE, &amp;i)) {</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;            <a class="code" href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a>(<span class="stringliteral">&quot;Failed to claim interface %d: %s\n&quot;</span>, i, strerror(errno));</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;            <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        }</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    }</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;}</div>
<div class="ttc" id="includes_8h_html_a8312a1a42e03986afb7c76557f4d3e25"><div class="ttname"><a href="includes_8h.html#a8312a1a42e03986afb7c76557f4d3e25">ckb_err</a></div><div class="ttdeci">#define ckb_err(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00050">includes.h:50</a></div></div>
<div class="ttc" id="structures_8h_html_a8d667681cbb0b3741476bf54c01e79b9"><div class="ttname"><a href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">usbdevice::epcount</a></div><div class="ttdeci">int epcount</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00215">structures.h:215</a></div></div>
<div class="ttc" id="includes_8h_html_af3b6c3fbbe2da20e4058fd83084329a6"><div class="ttname"><a href="includes_8h.html#af3b6c3fbbe2da20e4058fd83084329a6">ckb_info</a></div><div class="ttdeci">#define ckb_info(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00056">includes.h:56</a></div></div>
<div class="ttc" id="structures_8h_html_a1e1d8c37298aa076d30ba95dd97465ef"><div class="ttname"><a href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">usbdevice::handle</a></div><div class="ttdeci">int handle</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00187">structures.h:187</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-23" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-23-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-23-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-23-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a309cab8bf65221b01dc320f247abf626_icgraph.png" border="0" usemap="#usb__linux_8c_a309cab8bf65221b01dc320f247abf626_icgraph" alt=""/></div>
<map name="usb__linux_8c_a309cab8bf65221b01dc320f247abf626_icgraph" id="usb__linux_8c_a309cab8bf65221b01dc320f247abf626_icgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#a0fd9533617cdae390dc65aa4594e33d2" title="os_resetusb" alt="" coords="129,5,223,32"/><area shape="rect" id="node4" href="usb__linux_8c.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb" alt="" coords="128,56,224,83"/><area shape="rect" id="node3" href="usb_8h.html#a9ea008b77417f82b177117dce9a50b48" title="_resetusb Reset a USB device. " alt="" coords="274,5,353,32"/><area shape="rect" id="node5" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="272,56,355,83"/><area shape="rect" id="node6" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="403,56,477,83"/><area shape="rect" id="node7" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="525,56,589,83"/><area shape="rect" id="node8" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="638,56,754,83"/><area shape="rect" id="node9" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="803,31,893,57"/><area shape="rect" id="node10" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="942,56,1013,83"/><area shape="rect" id="node11" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1061,56,1112,83"/><area shape="rect" id="node12" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1160,56,1219,83"/><area shape="rect" id="node13" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1267,56,1357,83"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a41aa3e13beb593c91a5410200b4dd8d2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void usbkill </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00834">834</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>Referenced by <a class="el" href="ckb-daemon_2main_8c_source.html#l00040">quitWithLock()</a>.</p>
<div class="fragment"><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;              {</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    udev_unref(<a class="code" href="usb__linux_8c.html#ad21f1896afa016837ab9b476f9e62450">udev</a>);</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <a class="code" href="usb__linux_8c.html#ad21f1896afa016837ab9b476f9e62450">udev</a> = 0;</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;}</div>
<div class="ttc" id="usb__linux_8c_html_ad21f1896afa016837ab9b476f9e62450"><div class="ttname"><a href="usb__linux_8c.html#ad21f1896afa016837ab9b476f9e62450">udev</a></div><div class="ttdeci">static struct udev * udev</div><div class="ttdoc">struct udef is defined in /usr/include/libudev.h </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00638">usb_linux.c:638</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-24" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-24-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-24-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-24-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a41aa3e13beb593c91a5410200b4dd8d2_icgraph.png" border="0" usemap="#usb__linux_8c_a41aa3e13beb593c91a5410200b4dd8d2_icgraph" alt=""/></div>
<map name="usb__linux_8c_a41aa3e13beb593c91a5410200b4dd8d2_icgraph" id="usb__linux_8c_a41aa3e13beb593c91a5410200b4dd8d2_icgraph">
<area shape="rect" id="node2" href="ckb-daemon_2main_8c.html#a24a012c29e291fef5fa13f4a07fffd33" title="quitWithLock " alt="" coords="112,260,211,287"/><area shape="rect" id="node3" href="ckb-daemon_2main_8c.html#acd1527386a48875050e637e4bb872f11" title="quit Stop working the daemon. function is called if the daemon received a sigterm In this case..." alt="" coords="259,195,301,221"/><area shape="rect" id="node21" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="912,275,971,301"/><area shape="rect" id="node4" href="classKbFirmware.html#ae5f3c91fcf3fe8fe55e2c1e3cea877eb" title="KbFirmware::_fileForBoard" alt="" coords="357,43,534,69"/><area shape="rect" id="node10" href="classKbFirmware.html#aa68b2e0aed9074c60eba72e9fa60a6b5" title="KbFirmware::_latestForBoard" alt="" coords="349,107,541,133"/><area shape="rect" id="node17" href="classFwUpgradeDialog.html#a72dac03aca9395d1d440f0edcd1bb1da" title="FwUpgradeDialog::fwUpdate\lFinished" alt="" coords="350,158,541,199"/><area shape="rect" id="node20" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="665,275,716,301"/><area shape="rect" id="node23" href="ckb-daemon_2main_8c.html#a05f9b9989842b986a26caf9e4c66a4c7" title="sighandler" alt="" coords="405,275,486,301"/><area shape="rect" id="node5" href="classKbFirmware.html#a1cc600d07217f327a1541a44d353004c" title="KbFirmware::dataForBoard" alt="" coords="601,31,780,57"/><area shape="rect" id="node6" href="classFwUpgradeDialog.html#a1fd1f6f1285ab4998a7c81e2ee118d54" title="FwUpgradeDialog::exec" alt="" coords="860,5,1023,32"/><area shape="rect" id="node7" href="classKbWidget.html#a38c9f29a5d8f1edfcb5f8040de3dadb9" title="KbWidget::on_fwUpdButton\l_clicked" alt="" coords="1103,30,1287,71"/><area shape="rect" id="node8" href="classKbWidget.html#a428930086336c668e8a1055c21c938d9" title="KbWidget::showFwUpdate" alt="" coords="1347,37,1525,64"/><area shape="rect" id="node9" href="classMainWindow.html#ae50767c4ed6029f63ebacfffde4bc802" title="MainWindow::showFwUpdate\lNotification" alt="" coords="1574,30,1770,71"/><area shape="rect" id="node11" href="classKbFirmware.html#adf60ed5d7553a8c3f362ce5ae29ce965" title="KbFirmware::versionForBoard" alt="" coords="593,107,788,133"/><area shape="rect" id="node12" href="classKbWidget.html#adabed0db911bef8b3c0157372fb4e21a" title="KbWidget::updateFwButton" alt="" coords="850,107,1033,133"/><area shape="rect" id="node14" href="classMainWindow.html#a7bd3f729676a76651d4852d03d1cfb8e" title="MainWindow::checkFwUpdates" alt="" coords="1091,161,1298,188"/><area shape="rect" id="node13" href="classKbWidget.html#a16381b1ae59f8e1649d7d06232dadc1d" title="KbWidget::on_tabWidget\l_currentChanged" alt="" coords="1111,95,1278,137"/><area shape="rect" id="node15" href="classMainWindow.html#a888ae1a192a5ca93d0d8bddd104ae953" title="MainWindow::timerTick" alt="" coords="1357,161,1515,188"/><area shape="rect" id="node16" href="classMainWindow.html#a8b244be8b7b7db1b08de2a2acb9409db" title="MainWindow::MainWindow" alt="" coords="1582,161,1762,188"/><area shape="rect" id="node18" href="classFwUpgradeDialog.html#ae785587a6678240a0a6f47ef79808ad7" title="FwUpgradeDialog::FwUpgrade\lDialog" alt="" coords="841,209,1042,250"/><area shape="rect" id="node19" href="classFwUpgradeDialog.html#a8f4e424ecf62240c666836a8d5425f50" title="FwUpgradeDialog::removeDev" alt="" coords="590,216,791,243"/><area shape="rect" id="node22" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="1149,275,1240,301"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0859efad3739abe2ec61af4f3bb983ff"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int usbmain </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Start the USB main loop. Returns program exit code when finished.</p>
<p>usbmain is called by <a class="el" href="ckb-anim_8h.html#a0ddf1224851353fc92bfbff6f499fa97">main()</a> after setting up all other stuff. </p>
<dl class="section return"><dt>Returns</dt><dd>0 normally or -1 if fatal error occurs (up to now only if no new devices are available) </dd></dl>
<p>First check whether the uinput module is loaded by the kernel. </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000022">Todo:</a></b></dt><dd>Why isn't missing of uinput a fatal error? </dd></dl>
<p>Create the udev object with udev_new() (is a function from libudev.h) terminate -1 if error</p>
<p>Enumerate all currently connected devices</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000023">Todo:</a></b></dt><dd>lae. here the work has to go on... </dd></dl>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00774">774</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="includes_8h_source.html#l00047">ckb_fatal</a>, <a class="el" href="includes_8h_source.html#l00053">ckb_warn</a>, <a class="el" href="usb__linux_8c_source.html#l00746">udev_enum()</a>, <a class="el" href="usb__linux_8c_source.html#l00694">usb_add_device()</a>, and <a class="el" href="usb__linux_8c_source.html#l00719">usb_rm_device()</a>.</p>

<p>Referenced by <a class="el" href="ckb-daemon_2main_8c_source.html#l00088">main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;             {</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="comment">// Load the uinput module (if it&#39;s not loaded already)</span></div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    <span class="keywordflow">if</span>(system(<span class="stringliteral">&quot;modprobe uinput&quot;</span>) != 0)</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        <a class="code" href="includes_8h.html#a8e1e1ac7870420e38a04f30554ff2bbb">ckb_warn</a>(<span class="stringliteral">&quot;Failed to load uinput module\n&quot;</span>);</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    <span class="keywordflow">if</span>(!(<a class="code" href="usb__linux_8c.html#ad21f1896afa016837ab9b476f9e62450">udev</a> = udev_new())) {</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        <a class="code" href="includes_8h.html#a52234aaaaba66b4a5f9a97724e8d84d7">ckb_fatal</a>(<span class="stringliteral">&quot;Failed to initialize udev in usbmain(), usb_linux.c\n&quot;</span>);</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    }</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    <a class="code" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea">udev_enum</a>();</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="comment">// Done scanning. Enter a loop to poll for device updates</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    <span class="keyword">struct </span>udev_monitor* monitor = udev_monitor_new_from_netlink(<a class="code" href="usb__linux_8c.html#ad21f1896afa016837ab9b476f9e62450">udev</a>, <span class="stringliteral">&quot;udev&quot;</span>);</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    udev_monitor_filter_add_match_subsystem_devtype(monitor, <span class="stringliteral">&quot;usb&quot;</span>, 0);</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    udev_monitor_enable_receiving(monitor);</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <span class="comment">// Get an fd for the monitor</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordtype">int</span> fd = udev_monitor_get_fd(monitor);</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    fd_set fds;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    <span class="keywordflow">while</span>(<a class="code" href="usb__linux_8c.html#ad21f1896afa016837ab9b476f9e62450">udev</a>){</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        FD_ZERO(&amp;fds);</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        FD_SET(fd, &amp;fds);</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        <span class="comment">// Block until an event is read</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        <span class="keywordflow">if</span>(select(fd + 1, &amp;fds, 0, 0, 0) &gt; 0 &amp;&amp; FD_ISSET(fd, &amp;fds)){</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;            <span class="keyword">struct </span>udev_device* dev = udev_monitor_receive_device(monitor);</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;            <span class="keywordflow">if</span>(!dev)</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">char</span>* action = udev_device_get_action(dev);</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;            <span class="keywordflow">if</span>(!action){</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                udev_device_unref(dev);</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;            }</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;            <span class="comment">// Add/remove device</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;            <span class="keywordflow">if</span>(!strcmp(action, <span class="stringliteral">&quot;add&quot;</span>)){</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;                <span class="keywordtype">int</span> res = <a class="code" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779">usb_add_device</a>(dev);</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                <span class="keywordflow">if</span>(res == 0)</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;                <span class="comment">// If the device matched but the handle wasn&#39;t opened correctly, re-enumerate (this sometimes solves the problem)</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;                <span class="keywordflow">if</span>(res == -1)</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                    <a class="code" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea">udev_enum</a>();</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcmp(action, <span class="stringliteral">&quot;remove&quot;</span>))</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                <a class="code" href="usb__linux_8c.html#adeffaa2b04d01b15c8623255719420ef">usb_rm_device</a>(dev);</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;            udev_device_unref(dev);</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        }</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    }</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    udev_monitor_unref(monitor);</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;}</div>
<div class="ttc" id="includes_8h_html_a52234aaaaba66b4a5f9a97724e8d84d7"><div class="ttname"><a href="includes_8h.html#a52234aaaaba66b4a5f9a97724e8d84d7">ckb_fatal</a></div><div class="ttdeci">#define ckb_fatal(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00047">includes.h:47</a></div></div>
<div class="ttc" id="usb__linux_8c_html_adeffaa2b04d01b15c8623255719420ef"><div class="ttname"><a href="usb__linux_8c.html#adeffaa2b04d01b15c8623255719420ef">usb_rm_device</a></div><div class="ttdeci">static void usb_rm_device(struct udev_device *dev)</div><div class="ttdoc">usb_rm_device find the usb port to remove and close it via closeusb(). </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00719">usb_linux.c:719</a></div></div>
<div class="ttc" id="includes_8h_html_a8e1e1ac7870420e38a04f30554ff2bbb"><div class="ttname"><a href="includes_8h.html#a8e1e1ac7870420e38a04f30554ff2bbb">ckb_warn</a></div><div class="ttdeci">#define ckb_warn(fmt, args...)</div><div class="ttdef"><b>Definition:</b> <a href="includes_8h_source.html#l00053">includes.h:53</a></div></div>
<div class="ttc" id="usb__linux_8c_html_ad56c1e4ec53bbd6b947cb535590328ea"><div class="ttname"><a href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea">udev_enum</a></div><div class="ttdeci">static void udev_enum()</div><div class="ttdoc">udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that...</div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00746">usb_linux.c:746</a></div></div>
<div class="ttc" id="usb__linux_8c_html_a50efc8ee0ffcb6f201735d1a3bb08779"><div class="ttname"><a href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779">usb_add_device</a></div><div class="ttdeci">static int usb_add_device(struct udev_device *dev)</div><div class="ttdoc">Add a udev device. Returns 0 if device was recognized/added. </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00694">usb_linux.c:694</a></div></div>
<div class="ttc" id="usb__linux_8c_html_ad21f1896afa016837ab9b476f9e62450"><div class="ttname"><a href="usb__linux_8c.html#ad21f1896afa016837ab9b476f9e62450">udev</a></div><div class="ttdeci">static struct udev * udev</div><div class="ttdoc">struct udef is defined in /usr/include/libudev.h </div><div class="ttdef"><b>Definition:</b> <a href="usb__linux_8c_source.html#l00638">usb_linux.c:638</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-25" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-25-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-25-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-25-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a0859efad3739abe2ec61af4f3bb983ff_cgraph.png" border="0" usemap="#usb__linux_8c_a0859efad3739abe2ec61af4f3bb983ff_cgraph" alt=""/></div>
<map name="usb__linux_8c_a0859efad3739abe2ec61af4f3bb983ff_cgraph" id="usb__linux_8c_a0859efad3739abe2ec61af4f3bb983ff_cgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="126,364,215,391"/><area shape="rect" id="node3" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="265,364,381,391"/><area shape="rect" id="node50" href="usb__linux_8c.html#adeffaa2b04d01b15c8623255719420ef" title="usb_rm_device find the usb port to remove and close it via closeusb(). " alt="" coords="267,201,378,228"/><area shape="rect" id="node4" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="429,385,493,412"/><area shape="rect" id="node5" href="usb_8c.html#a1ab9d61dd894466125283465201161cd" title="setupusb" alt="" coords="541,461,616,488"/><area shape="rect" id="node6" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="664,499,747,525"/><area shape="rect" id="node7" href="usb_8c.html#a8732b3ade76da4ae362996232ef95431" title="closeusb" alt="" coords="1008,43,1083,69"/><area shape="rect" id="node14" href="devnode_8c.html#a4f2642e0c38280a1516fbe153c9fa18f" title="Update the list of connected devices. " alt="" coords="1167,347,1289,373"/><area shape="rect" id="node16" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . " alt="" coords="825,188,895,215"/><area shape="rect" id="node25" href="usb_8c.html#a25ded61622ec9349905b5aa2ed2cb48b" title="brief . " alt="" coords="819,651,901,677"/><area shape="rect" id="node26" href="devnode_8c.html#a0c3d1e3cd90f43a9b5ee0793f4a75041" title="Create a dev path for the keyboard at index. Returns 0 on success. " alt="" coords="817,549,903,576"/><area shape="rect" id="node29" href="usb_8c.html#af87f830e031d8f63d2d1c3fc14fdad20" title="brief . " alt="" coords="1185,600,1271,627"/><area shape="rect" id="node30" href="usb_8c.html#a8e6389e8183a834fedb6ed317dd26f94" title="brief . " alt="" coords="1187,676,1269,703"/><area shape="rect" id="node31" href="usb_8h.html#a9e5784bfca2e4612f498ce67c7dab275" title="os_inputmain is run in a separate thread and will be detached from the main thread, so it needs to clean up its own resources. " alt="" coords="811,828,909,855"/><area shape="rect" id="node42" href="input_8h.html#ac73b3c2c38b916b901b4cca6b350a863" title="os_inputopen " alt="" coords="811,955,909,981"/><area shape="rect" id="node44" href="input_8h.html#a081bbacaa312d4a1a63bc1cab5d3520f" title="os_setupindicators" alt="" coords="795,321,925,348"/><area shape="rect" id="node46" href="usb_8h.html#a39442715182933b93172de60cdb66e8f" title="os_setupusb OS&#45;specific setup for a specific usb device. " alt="" coords="812,397,908,424"/><area shape="rect" id="node48" href="usb_8c.html#a8a1c88df5e127732cb63f1a8be180926" title="usb_tryreset" alt="" coords="998,448,1093,475"/><area shape="rect" id="node8" href="usb_8h.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb unclaim it, destroy the udev device and clear data structures at kb " alt="" coords="1181,56,1275,83"/><area shape="rect" id="node10" href="input_8h.html#a44df5105a6a3f2eda5bc39a88201bd1a" title="os_inputclose" alt="" coords="1177,5,1279,32"/><area shape="rect" id="node11" href="devnode_8c.html#a8d0aeeebb364608943b78573adb85c7f" title="Remove the dev path for the keyboard at index. Returns 0 on success. " alt="" coords="1187,169,1269,196"/><area shape="rect" id="node9" href="usb__linux_8c.html#afe1111f494da4776633be32fecaba44b" title="usbunclaim" alt="" coords="1359,56,1447,83"/><area shape="rect" id="node12" href="devnode_8c.html#a9d97ede033e4f6c6bdd1c66fc82aa15e" title="_rmnotifynode" alt="" coords="1351,144,1455,171"/><area shape="rect" id="node13" href="devnode_8c.html#aac8f6f936a0ff6c16adc677622b226c4" title="rm_recursive" alt="" coords="1354,283,1451,309"/><area shape="rect" id="node15" href="devnode_8c.html#acc36eaba5eb854461ab3c0a4d146e9c9" title="_updateconnected Update the list of connected devices. " alt="" coords="1339,496,1467,523"/><area shape="rect" id="node17" href="command_8c.html#ad7239680e0942b0b85a6cd3e9fff25a9" title="readcmd" alt="" coords="1009,195,1081,221"/><area shape="rect" id="node22" href="devnode_8c.html#a1062ed70d4ea0310fbf5eeee928b58b7" title="readlines" alt="" coords="1008,245,1083,272"/><area shape="rect" id="node23" href="devnode_8c.html#a588ab2c69fcb283a5beb90c49a165979" title="readlines_ctx_free" alt="" coords="981,93,1109,120"/><area shape="rect" id="node24" href="devnode_8c.html#ac118005c75badc2028b4921be8d9bdd0" title="readlines_ctx_init" alt="" coords="984,144,1107,171"/><area shape="rect" id="node18" href="devnode_8c.html#a981305884de053a41d337efac23900ec" title="Creates a notification node for the specified keyboard. " alt="" coords="1178,220,1278,247"/><area shape="rect" id="node20" href="settingswidget_8cpp.html#a184e8402a94481ba2f47ba063272525b" title="right" alt="" coords="1205,271,1251,297"/><area shape="rect" id="node21" href="devnode_8c.html#a40e40a8ea3edccbfd8fdfefc44a76206" title="Removes a notification node for the specified keyboard. " alt="" coords="1179,119,1277,145"/><area shape="rect" id="node19" href="devnode_8c.html#a38fcf6ff044f9249ae04234340ee8e7b" title="_mknotifynode" alt="" coords="1349,391,1456,417"/><area shape="rect" id="node27" href="devnode_8c.html#a81c81014b2dfa89e326dd61769842953" title="_mkdevpath" alt="" coords="999,549,1092,576"/><area shape="rect" id="node28" href="devnode_8c.html#ad130425a617cf973b28603a72607a057" title="Writes a keyboard&#39;s firmware version and poll rate to its device node. " alt="" coords="1187,499,1269,525"/><area shape="rect" id="node32" href="keymap_8c.html#ad39ede76abd657f5123fa331853db017" title="corsair_kbcopy" alt="" coords="990,853,1101,880"/><area shape="rect" id="node33" href="keymap_8c.html#a0dc9a16564cc51b35a35d28af1a96fb0" title="corsair_mousecopy" alt="" coords="978,904,1113,931"/><area shape="rect" id="node34" href="keymap_8c.html#a6f4afd134546237416b271d9cefd2889" title="hid_kb_translate" alt="" coords="987,955,1104,981"/><area shape="rect" id="node35" href="keymap_8c.html#a092f675ff366b5823c73b25f83d513f9" title="hid_mouse_translate" alt="" coords="974,752,1117,779"/><area shape="rect" id="node36" href="input_8c.html#ae360d0b9a764a1d38c5be5464be8b70a" title="inputupdate" alt="" coords="1001,803,1090,829"/><area shape="rect" id="node37" href="input_8c.html#aed8e9842ed5750c1d328c5dc4c1ba2bd" title="inputupdate_keys" alt="" coords="1166,828,1290,855"/><area shape="rect" id="node41" href="input_8h.html#a9f2cfb2d883ae4a3732047fe3f3da683" title="os_mousemove" alt="" coords="1345,777,1460,804"/><area shape="rect" id="node38" href="input_8c.html#abd38419ce56379559481f51d9491adeb" title="macromask" alt="" coords="1357,879,1448,905"/><area shape="rect" id="node39" href="notify_8c.html#ac2411c0997dfdbefdebd45f2584a5d04" title="nprintkey" alt="" coords="1365,929,1440,956"/><area shape="rect" id="node40" href="input_8h.html#af0d3401f317f3214dadad7d1a3378c58" title="os_keypress" alt="" coords="1355,828,1451,855"/><area shape="rect" id="node43" href="input__linux_8c.html#a5f050529d49f8cb5e8dda4617c5984b7" title="uinputopen" alt="" coords="1003,1005,1088,1032"/><area shape="rect" id="node45" href="input__linux_8c.html#a5d40cc9137eaefbc2d860fac76020460" title="_ledthread" alt="" coords="1004,296,1087,323"/><area shape="rect" id="node47" href="usb__linux_8c.html#ab694a2ac859b16b5af802b4484f5ba0b" title="strtrim" alt="" coords="1016,397,1075,424"/><area shape="rect" id="node49" href="usb__linux_8c.html#a309cab8bf65221b01dc320f247abf626" title="usbclaim" alt="" coords="1008,347,1083,373"/></map>
</div>
</p>

<p><div id="dynsection-26" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-26-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-26-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-26-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_a0859efad3739abe2ec61af4f3bb983ff_icgraph.png" border="0" usemap="#usb__linux_8c_a0859efad3739abe2ec61af4f3bb983ff_icgraph" alt=""/></div>
<map name="usb__linux_8c_a0859efad3739abe2ec61af4f3bb983ff_icgraph" id="usb__linux_8c_a0859efad3739abe2ec61af4f3bb983ff_icgraph">
<area shape="rect" id="node2" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="125,5,176,32"/><area shape="rect" id="node3" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="224,5,283,32"/><area shape="rect" id="node4" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="331,5,421,32"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="afe1111f494da4776633be32fecaba44b"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int usbunclaim </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structures_8h.html#structusbdevice">usbdevice</a> *&#160;</td>
          <td class="paramname"><em>kb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>resetting</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>usbunclaim do an unclaiming of the usb device gicen by kb. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">kb</td><td>THE usbdevice* </td></tr>
    <tr><td class="paramname">resetting</td><td>boolean flag: If resseting is true, the caller will perform a bus reset command after unclaiming the device. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>always 0.</dd></dl>
<p>Unclaim all endpoints for a given device (remeber the decrementing of the file descriptor) via ioctl(USBDEVFS_DISCARDURB).</p>
<p>Afterwards - if ressetting is false - do a USBDEVFS_CONNECT for EP 0 and 1. If it is a non RGB device, connect EP 2 also. The comment mentions RGB keyboards only, but as I understand the code, this is valid also for RGB mice.</p>
<p>There is no error handling yet. Function is called in <a class="el" href="usb__linux_8c.html">usb_linux.c</a> only, so it is declared as static now. </p>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00404">404</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>References <a class="el" href="structures_8h_source.html#l00215">usbdevice::epcount</a>, <a class="el" href="structures_8h_source.html#l00136">FEAT_RGB</a>, <a class="el" href="structures_8h_source.html#l00187">usbdevice::handle</a>, and <a class="el" href="structures_8h_source.html#l00157">HAS_FEATURES</a>.</p>

<p>Referenced by <a class="el" href="usb__linux_8c_source.html#l00433">os_closeusb()</a>, and <a class="el" href="usb__linux_8c_source.html#l00495">os_resetusb()</a>.</p>
<div class="fragment"><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;                                                    {</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keywordtype">int</span> handle = kb-&gt;<a class="code" href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">handle</a> - 1;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keywordtype">int</span> count = kb-&gt;<a class="code" href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">epcount</a>;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; count; i++) {</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        ioctl(handle, USBDEVFS_RELEASEINTERFACE, &amp;i);</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    }</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="comment">// For RGB keyboards, the kernel driver should only be reconnected to interfaces 0 and 1 (HID), and only if we&#39;re not about to do a USB reset.</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="comment">// Reconnecting any of the others causes trouble.</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="keywordflow">if</span> (!resetting) {</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        <span class="keyword">struct </span>usbdevfs_ioctl ctl = { 0, USBDEVFS_CONNECT, 0 };</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        ioctl(handle, USBDEVFS_IOCTL, &amp;ctl);</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        ctl.ifno = 1;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        ioctl(handle, USBDEVFS_IOCTL, &amp;ctl);</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        <span class="comment">// Also reconnect iface #2 (HID) for non-RGB keyboards</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="keywordflow">if</span>(!<a class="code" href="structures_8h.html#ac5ce9f3f886e327076d6fa5393e7aa69">HAS_FEATURES</a>(kb, <a class="code" href="structures_8h.html#ae84210929bc758f0da372e723d002f8e">FEAT_RGB</a>)){</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;            ctl.ifno = 2;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            ioctl(handle, USBDEVFS_IOCTL, &amp;ctl);</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        }</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    }</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;}</div>
<div class="ttc" id="structures_8h_html_ae84210929bc758f0da372e723d002f8e"><div class="ttname"><a href="structures_8h.html#ae84210929bc758f0da372e723d002f8e">FEAT_RGB</a></div><div class="ttdeci">#define FEAT_RGB</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00136">structures.h:136</a></div></div>
<div class="ttc" id="structures_8h_html_a8d667681cbb0b3741476bf54c01e79b9"><div class="ttname"><a href="structures_8h.html#a8d667681cbb0b3741476bf54c01e79b9">usbdevice::epcount</a></div><div class="ttdeci">int epcount</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00215">structures.h:215</a></div></div>
<div class="ttc" id="structures_8h_html_a1e1d8c37298aa076d30ba95dd97465ef"><div class="ttname"><a href="structures_8h.html#a1e1d8c37298aa076d30ba95dd97465ef">usbdevice::handle</a></div><div class="ttdeci">int handle</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00187">structures.h:187</a></div></div>
<div class="ttc" id="structures_8h_html_ac5ce9f3f886e327076d6fa5393e7aa69"><div class="ttname"><a href="structures_8h.html#ac5ce9f3f886e327076d6fa5393e7aa69">HAS_FEATURES</a></div><div class="ttdeci">#define HAS_FEATURES(kb, feat)</div><div class="ttdef"><b>Definition:</b> <a href="structures_8h_source.html#l00157">structures.h:157</a></div></div>
</div><!-- fragment -->
<p><div id="dynsection-27" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-27-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-27-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-27-content" class="dyncontent" style="display:none;">
<div class="center"><img src="usb__linux_8c_afe1111f494da4776633be32fecaba44b_icgraph.png" border="0" usemap="#usb__linux_8c_afe1111f494da4776633be32fecaba44b_icgraph" alt=""/></div>
<map name="usb__linux_8c_afe1111f494da4776633be32fecaba44b_icgraph" id="usb__linux_8c_afe1111f494da4776633be32fecaba44b_icgraph">
<area shape="rect" id="node2" href="usb__linux_8c.html#a6a62575e9073fae15efb58f24fbfe5b8" title="os_closeusb" alt="" coords="142,401,237,428"/><area shape="rect" id="node34" href="usb__linux_8c.html#a0fd9533617cdae390dc65aa4594e33d2" title="os_resetusb" alt="" coords="143,452,236,479"/><area shape="rect" id="node3" href="usb_8h.html#a8732b3ade76da4ae362996232ef95431" title="closeusb Close a USB device and remove device entry. " alt="" coords="288,401,363,428"/><area shape="rect" id="node4" href="usb_8c.html#a10ad381abfe51e67e341c882c92bb9ac" title="brief . " alt="" coords="548,427,631,453"/><area shape="rect" id="node13" href="usb_8c.html#ab8c22b4f7012c6d9fe1a0d5e2a93df65" title="brief . " alt="" coords="414,427,485,453"/><area shape="rect" id="node14" href="ckb-daemon_2main_8c.html#a24a012c29e291fef5fa13f4a07fffd33" title="quitWithLock " alt="" coords="937,325,1036,352"/><area shape="rect" id="node33" href="usb__linux_8c.html#adeffaa2b04d01b15c8623255719420ef" title="usb_rm_device find the usb port to remove and close it via closeusb(). " alt="" coords="534,477,645,504"/><area shape="rect" id="node5" href="usb_8h.html#a1ab9d61dd894466125283465201161cd" title="setupusb starts a thread with kb as parameter and _setupusb() as entrypoint. " alt="" coords="693,427,768,453"/><area shape="rect" id="node6" href="usb__linux_8c.html#a3185d6da36c8b0f8b862a8479ae82034" title="usbadd" alt="" coords="816,427,880,453"/><area shape="rect" id="node7" href="usb__linux_8c.html#a50efc8ee0ffcb6f201735d1a3bb08779" title="Add a udev device. Returns 0 if device was recognized/added. " alt="" coords="929,427,1045,453"/><area shape="rect" id="node8" href="usb__linux_8c.html#ad56c1e4ec53bbd6b947cb535590328ea" title="udev_enum use the udev_enumerate_add_match_subsystem() to get all you need but only that..." alt="" coords="1094,427,1183,453"/><area shape="rect" id="node9" href="usb__linux_8c.html#a0859efad3739abe2ec61af4f3bb983ff" title="usbmain" alt="" coords="1293,401,1363,428"/><area shape="rect" id="node10" href="ckb-daemon_2main_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="1548,275,1599,301"/><area shape="rect" id="node11" href="notify_8c.html#ae246359e104d63520158c26329caac80" title="restart" alt="" coords="1795,275,1853,301"/><area shape="rect" id="node12" href="notify_8h.html#a700b520b9eb9a3698af8f8ebf547a9ab" title="cmd_restart" alt="" coords="2032,275,2123,301"/><area shape="rect" id="node15" href="ckb-daemon_2main_8c.html#acd1527386a48875050e637e4bb872f11" title="quit Stop working the daemon. function is called if the daemon received a sigterm In this case..." alt="" coords="1117,195,1160,221"/><area shape="rect" id="node16" href="classKbFirmware.html#ae5f3c91fcf3fe8fe55e2c1e3cea877eb" title="KbFirmware::_fileForBoard" alt="" coords="1239,43,1417,69"/><area shape="rect" id="node22" href="classKbFirmware.html#aa68b2e0aed9074c60eba72e9fa60a6b5" title="KbFirmware::_latestForBoard" alt="" coords="1232,107,1424,133"/><area shape="rect" id="node29" href="classFwUpgradeDialog.html#a72dac03aca9395d1d440f0edcd1bb1da" title="FwUpgradeDialog::fwUpdate\lFinished" alt="" coords="1233,158,1423,199"/><area shape="rect" id="node32" href="ckb-daemon_2main_8c.html#a05f9b9989842b986a26caf9e4c66a4c7" title="sighandler" alt="" coords="1287,224,1369,251"/><area shape="rect" id="node17" href="classKbFirmware.html#a1cc600d07217f327a1541a44d353004c" title="KbFirmware::dataForBoard" alt="" coords="1484,31,1663,57"/><area shape="rect" id="node18" href="classFwUpgradeDialog.html#a1fd1f6f1285ab4998a7c81e2ee118d54" title="FwUpgradeDialog::exec" alt="" coords="1743,5,1905,32"/><area shape="rect" id="node19" href="classKbWidget.html#a38c9f29a5d8f1edfcb5f8040de3dadb9" title="KbWidget::on_fwUpdButton\l_clicked" alt="" coords="1985,30,2169,71"/><area shape="rect" id="node20" href="classKbWidget.html#a428930086336c668e8a1055c21c938d9" title="KbWidget::showFwUpdate" alt="" coords="2229,37,2408,64"/><area shape="rect" id="node21" href="classMainWindow.html#ae50767c4ed6029f63ebacfffde4bc802" title="MainWindow::showFwUpdate\lNotification" alt="" coords="2457,30,2653,71"/><area shape="rect" id="node23" href="classKbFirmware.html#adf60ed5d7553a8c3f362ce5ae29ce965" title="KbFirmware::versionForBoard" alt="" coords="1476,107,1671,133"/><area shape="rect" id="node24" href="classKbWidget.html#adabed0db911bef8b3c0157372fb4e21a" title="KbWidget::updateFwButton" alt="" coords="1733,107,1915,133"/><area shape="rect" id="node26" href="classMainWindow.html#a7bd3f729676a76651d4852d03d1cfb8e" title="MainWindow::checkFwUpdates" alt="" coords="1974,161,2181,188"/><area shape="rect" id="node25" href="classKbWidget.html#a16381b1ae59f8e1649d7d06232dadc1d" title="KbWidget::on_tabWidget\l_currentChanged" alt="" coords="1994,95,2161,137"/><area shape="rect" id="node27" href="classMainWindow.html#a888ae1a192a5ca93d0d8bddd104ae953" title="MainWindow::timerTick" alt="" coords="2239,161,2398,188"/><area shape="rect" id="node28" href="classMainWindow.html#a8b244be8b7b7db1b08de2a2acb9409db" title="MainWindow::MainWindow" alt="" coords="2465,161,2645,188"/><area shape="rect" id="node30" href="classFwUpgradeDialog.html#ae785587a6678240a0a6f47ef79808ad7" title="FwUpgradeDialog::FwUpgrade\lDialog" alt="" coords="1723,209,1925,250"/><area shape="rect" id="node31" href="classFwUpgradeDialog.html#a8f4e424ecf62240c666836a8d5425f50" title="FwUpgradeDialog::removeDev" alt="" coords="1473,165,1674,192"/><area shape="rect" id="node35" href="usb_8h.html#a9ea008b77417f82b177117dce9a50b48" title="_resetusb Reset a USB device. " alt="" coords="286,452,365,479"/></map>
</div>
</p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="a1b952c601049b156fe39d96473aaca3a"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">char kbsyspath[9][FILENAME_MAX]</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00013">13</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

<p>Referenced by <a class="el" href="usb__linux_8c_source.html#l00433">os_closeusb()</a>, <a class="el" href="usb__linux_8c_source.html#l00719">usb_rm_device()</a>, and <a class="el" href="usb__linux_8c_source.html#l00592">usbadd()</a>.</p>

</div>
</div>
<a class="anchor" id="ac1888fdd0cb519fd7ff5768437629b8b"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="usb__linux_8c.html#struct__model">_model</a> models[]</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<b>Initial value:</b><div class="fragment"><div class="line">= {</div>
<div class="line">    </div>
<div class="line">    {  <span class="stringliteral">&quot;1b17&quot;</span> ,  0x1b17  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b07&quot;</span> ,  0x1b07  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b37&quot;</span> ,  0x1b37  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b39&quot;</span> ,  0x1b39  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b13&quot;</span> ,  0x1b13  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b09&quot;</span> ,  0x1b09  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b33&quot;</span> ,  0x1b33  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b36&quot;</span> ,  0x1b36  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b38&quot;</span> ,  0x1b38  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b3a&quot;</span> ,  0x1b3a  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b11&quot;</span> ,  0x1b11  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b08&quot;</span> ,  0x1b08  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b2d&quot;</span> ,  0x1b2d  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b20&quot;</span> ,  0x1b20  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b15&quot;</span> ,  0x1b15  },</div>
<div class="line">    </div>
<div class="line">    {  <span class="stringliteral">&quot;1b12&quot;</span> ,  0x1b12  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b2e&quot;</span> ,  0x1b2e  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b14&quot;</span> ,  0x1b14   },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b19&quot;</span> ,  0x1b19   },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b2f&quot;</span> ,  0x1b2f   },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b1e&quot;</span> ,  0x1b1e  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b3e&quot;</span> ,  0x1b3e  },</div>
<div class="line">    {  <span class="stringliteral">&quot;1b32&quot;</span> ,  0x1b32   }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section attention"><dt>Attention</dt><dd>when adding new hardware this file hat to be changed too.</dd></dl>
<p>In this structure array <em>models</em>[] for each device the name (the device id as string in hex without leading 0x) and its usb device id as short must be entered in this array. </p>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00654">654</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

</div>
</div>
<a class="anchor" id="ad21f1896afa016837ab9b476f9e62450"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">struct udev* udev</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00638">638</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

</div>
</div>
<a class="anchor" id="ac29239c44378f37b6130288cb67e5699"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">pthread_t udevthread</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00641">641</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

</div>
</div>
<a class="anchor" id="aa9fb3f307bd79608dfa48c4efee007b9"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">pthread_t usbthread</td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000020">Todo:</a></b></dt><dd>These two thread vasriables seem to be unused: usbtread, udevthread </dd></dl>

<p>Definition at line <a class="el" href="usb__linux_8c_source.html#l00641">641</a> of file <a class="el" href="usb__linux_8c_source.html">usb_linux.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_c663af95b3406af676444e819a47854e.html">ckb-daemon</a></li><li class="navelem"><a class="el" href="usb__linux_8c.html">usb_linux.c</a></li>
    <li class="footer">Generated on Thu May 25 2017 22:06:26 for ckb-next by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
