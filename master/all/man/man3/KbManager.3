.TH "KbManager" 3 "Thu Nov 2 2017" "Version v0.2.8 at branch master" "ckb-next" \" -*- nroff -*-
.ad l
.nh
.SH NAME
KbManager \- 
.SH SYNOPSIS
.br
.PP
.PP
\fC#include <src/ckb/kbmanager\&.h>\fP
.PP
Inherits \fBQObject\fP\&.
.SS "Signals"

.in +1c
.ti -1c
.RI "void \fBkbConnected\fP (\fBKb\fP *device)"
.br
.ti -1c
.RI "void \fBkbDisconnected\fP (\fBKb\fP *device)"
.br
.ti -1c
.RI "void \fBversionUpdated\fP ()"
.br
.in -1c
.SS "Static Public Member Functions"

.in +1c
.ti -1c
.RI "static void \fBinit\fP (QString guiVersion)"
.br
.ti -1c
.RI "static void \fBstop\fP ()"
.br
.ti -1c
.RI "static \fBKbManager\fP * \fBkbManager\fP ()"
.br
.ti -1c
.RI "static QString \fBckbGuiVersion\fP ()"
.br
.ti -1c
.RI "static QString \fBckbDaemonVersion\fP ()"
.br
.ti -1c
.RI "static float \fBparseVersionString\fP (QString version)"
.br
.ti -1c
.RI "static float \fBckbGuiVersionF\fP ()"
.br
.ti -1c
.RI "static float \fBckbDaemonVersionF\fP ()"
.br
.ti -1c
.RI "static const QSet< \fBKb\fP * > \fBdevices\fP ()"
.br
.ti -1c
.RI "static QTimer * \fBeventTimer\fP ()"
.br
.ti -1c
.RI "static void \fBfps\fP (int framerate)"
.br
.ti -1c
.RI "static QTimer * \fBscanTimer\fP ()"
.br
.in -1c
.SS "Private Slots"

.in +1c
.ti -1c
.RI "void \fBscanKeyboards\fP ()"
.br
.in -1c
.SS "Private Member Functions"

.in +1c
.ti -1c
.RI "\fBKbManager\fP (\fBQObject\fP *parent=0)"
.br
.in -1c
.SS "Private Attributes"

.in +1c
.ti -1c
.RI "QSet< \fBKb\fP * > \fB_devices\fP"
.br
.ti -1c
.RI "QTimer * \fB_eventTimer\fP"
.br
.ti -1c
.RI "QTimer * \fB_scanTimer\fP"
.br
.in -1c
.SS "Static Private Attributes"

.in +1c
.ti -1c
.RI "static \fBKbManager\fP * \fB_kbManager\fP = 0"
.br
.ti -1c
.RI "static QString \fB_guiVersion\fP"
.br
.ti -1c
.RI "static QString \fB_daemonVersion\fP = '<unavailable>'"
.br
.in -1c
.SH "Detailed Description"
.PP 
Definition at line 14 of file kbmanager\&.h\&.
.SH "Constructor & Destructor Documentation"
.PP 
.SS "KbManager::KbManager (\fBQObject\fP *parent = \fC0\fP)\fC [explicit]\fP, \fC [private]\fP"

.PP
Definition at line 26 of file kbmanager\&.cpp\&.
.PP
References _eventTimer, _scanTimer, and scanKeyboards()\&.
.PP
Referenced by init()\&.
.PP
.nf
26                                     : QObject(parent){
27     // Set up the timers
28     _eventTimer = new QTimer(this);
29     _eventTimer->setTimerType(Qt::PreciseTimer);
30     _scanTimer = new QTimer(this);
31     _scanTimer->start(1000);
32     connect(_scanTimer, SIGNAL(timeout()), this, SLOT(scanKeyboards()));
33 
34     // Scan for keyboards immediately so they show up as soon as the GUI appears\&.
35     QTimer::singleShot(0,this,SLOT(scanKeyboards()));
36 }
.fi
.SH "Member Function Documentation"
.PP 
.SS "static QString KbManager::ckbDaemonVersion ()\fC [inline]\fP, \fC [static]\fP"

.PP
Definition at line 27 of file kbmanager\&.h\&.
.PP
References _daemonVersion\&.
.PP
Referenced by MainWindow::updateVersion()\&.
.PP
.nf
27 { return _daemonVersion; }
.fi
.SS "static float KbManager::ckbDaemonVersionF ()\fC [inline]\fP, \fC [static]\fP"

.PP
Definition at line 31 of file kbmanager\&.h\&.
.PP
References _daemonVersion, DAEMON_UNAVAILABLE_STR, and parseVersionString()\&.
.PP
Referenced by KbFirmware::_latestForBoard(), and MainWindow::updateVersion()\&.
.PP
.nf
31 { return _daemonVersion == DAEMON_UNAVAILABLE_STR ? INFINITY : parseVersionString(_daemonVersion); }
.fi
.SS "static QString KbManager::ckbGuiVersion ()\fC [inline]\fP, \fC [static]\fP"

.PP
Definition at line 26 of file kbmanager\&.h\&.
.PP
References _guiVersion\&.
.PP
.nf
26 { return _guiVersion; }
.fi
.SS "static float KbManager::ckbGuiVersionF ()\fC [inline]\fP, \fC [static]\fP"

.PP
Definition at line 30 of file kbmanager\&.h\&.
.PP
References _guiVersion, and parseVersionString()\&.
.PP
Referenced by KbFirmware::_latestForBoard(), and MainWindow::updateVersion()\&.
.PP
.nf
30 { return parseVersionString(_guiVersion); }
.fi
.SS "static const QSet<\fBKb\fP*> KbManager::devices ()\fC [inline]\fP, \fC [static]\fP"

.PP
Definition at line 34 of file kbmanager\&.h\&.
.PP
References _devices, and _kbManager\&.
.PP
.nf
34 { return _kbManager ? _kbManager->_devices : QSet<Kb*>(); }
.fi
.SS "static QTimer* KbManager::eventTimer ()\fC [inline]\fP, \fC [static]\fP"

.PP
Definition at line 38 of file kbmanager\&.h\&.
.PP
References _eventTimer, and _kbManager\&.
.PP
Referenced by fps()\&.
.PP
.nf
38 { return _kbManager ? _kbManager->_eventTimer : 0; }
.fi
.SS "void KbManager::fps (intframerate)\fC [static]\fP"

.PP
Definition at line 38 of file kbmanager\&.cpp\&.
.PP
References eventTimer()\&.
.PP
Referenced by Kb::frameRate()\&.
.PP
.nf
38                                 {
39     QTimer* timer = eventTimer();
40     if(!timer)
41         return;
42     if(timer->isActive())
43         timer->setInterval(1000 / framerate);
44     else
45         timer->start(1000 / framerate);
46 }
.fi
.SS "void KbManager::init (QStringguiVersion)\fC [static]\fP"

.PP
Definition at line 12 of file kbmanager\&.cpp\&.
.PP
References _guiVersion, _kbManager, and KbManager()\&.
.PP
Referenced by MainWindow::MainWindow()\&.
.PP
.nf
12                                       {
13     _guiVersion = guiVersion;
14     if(_kbManager)
15         return;
16     _kbManager = new KbManager();
17 }
.fi
.SS "void KbManager::kbConnected (\fBKb\fP *device)\fC [signal]\fP"

.PP
Definition at line 174 of file moc_kbmanager\&.cpp\&.
.PP
Referenced by scanKeyboards()\&.
.PP
.nf
175 {
176     void *_a[] = { Q_NULLPTR, const_cast<void*>(reinterpret_cast<const void*>(&_t1)) };
177     QMetaObject::activate(this, &staticMetaObject, 0, _a);
178 }
.fi
.SS "void KbManager::kbDisconnected (\fBKb\fP *device)\fC [signal]\fP"

.PP
Definition at line 181 of file moc_kbmanager\&.cpp\&.
.PP
Referenced by scanKeyboards()\&.
.PP
.nf
182 {
183     void *_a[] = { Q_NULLPTR, const_cast<void*>(reinterpret_cast<const void*>(&_t1)) };
184     QMetaObject::activate(this, &staticMetaObject, 1, _a);
185 }
.fi
.SS "static \fBKbManager\fP* KbManager::kbManager ()\fC [inline]\fP, \fC [static]\fP"

.PP
Definition at line 23 of file kbmanager\&.h\&.
.PP
References _kbManager\&.
.PP
Referenced by MainWindow::MainWindow()\&.
.PP
.nf
23 { return _kbManager; }
.fi
.SS "float KbManager::parseVersionString (QStringversion)\fC [static]\fP"

.PP
Definition at line 48 of file kbmanager\&.cpp\&.
.PP
Referenced by ckbDaemonVersionF(), ckbGuiVersionF(), and KbFirmware::processDownload()\&.
.PP
.nf
48                                                   {
49     // Remove extraneous info (anything after a +, anything non-numeric)
50     QStringList dots = version\&.replace(QRegExp("\\+\&.+"), "")\&.replace(QRegExp("[^\\d\\\&.]"), "")\&.split("\&.");
51     float base = 1\&.f;
52     float res = 0\&.f;
53     // A number like "1\&.2\&.3" will result in 1\&.0203
54     // NB: will fail if a point version goes over 99 or if using more than two dots\&. floats can only reliably encode 7 decimal digits\&.
55     foreach(const QString& dot, dots){
56         res += dot\&.toFloat() * base;
57         base /= 100\&.f;
58     }
59     return res;
60 }
.fi
.SS "void KbManager::scanKeyboards ()\fC [private]\fP, \fC [slot]\fP"

.PP
Definition at line 62 of file kbmanager\&.cpp\&.
.PP
References _daemonVersion, _devices, _eventTimer, _scanTimer, DAEMON_UNAVAILABLE_STR, devpath, Kb::isOpen(), kbConnected(), kbDisconnected(), Kb::load(), Kb::matches(), Kb::save(), and versionUpdated()\&.
.PP
Referenced by KbManager()\&.
.PP
.nf
62                              {
63     QString rootdev = devpath\&.arg(0);
64     QFile connected(rootdev + "/connected");
65     if(!connected\&.open(QIODevice::ReadOnly)){
66         // No root controller - remove all keyboards
67         foreach(Kb* kb, _devices){
68             emit kbDisconnected(kb);
69             kb->save();
70             delete kb;
71         }
72         _devices\&.clear();
73         if(_daemonVersion != DAEMON_UNAVAILABLE_STR){
74             _daemonVersion = DAEMON_UNAVAILABLE_STR;
75             emit versionUpdated();
76         }
77         return;
78     }
79     // Check daemon version
80     QFile version(rootdev + "/version");
81     QString vString;
82     if(version\&.open(QIODevice::ReadOnly)){
83         vString = QString::fromUtf8(version\&.readLine())\&.trimmed();
84         version\&.close();
85     } else
86         vString = DAEMON_UNAVAILABLE_STR;
87     if(_daemonVersion != vString){
88         _daemonVersion = vString;
89         emit versionUpdated();
90     }
91 
92     // Scan connected devices
93     QList<QStringList> lines;
94     while(1){
95         QString line = connected\&.readLine()\&.trimmed();
96         if(line\&.isEmpty())
97             break;
98         QStringList components = line\&.split(" ");
99         if(components\&.length() < 2)             // "<path> <serial> <name>" (we're only interested in the first two)
100             continue;
101         lines\&.append(components);
102     }
103     connected\&.close();
104 
105     // Remove any active devices not in the list
106     QMutableSetIterator<Kb*> i(_devices);
107     while(i\&.hasNext()){
108         Kb* kb = i\&.next();
109         bool matched = false;
110         foreach(const QStringList& line, lines){
111             if(kb->matches(line[0], line[1])){
112                 matched = true;
113                 break;
114             }
115         }
116         if(matched)
117             continue;
118         // Device not found, remove
119         i\&.remove();
120         emit kbDisconnected(kb);
121         kb->save();
122         delete kb;
123     }
124 
125     // Add any new devices found in the list
126     foreach(const QStringList& line, lines){
127         bool matched = false;
128         foreach(Kb* kb, _devices){
129             if(kb->matches(line[0], line[1])){
130                 matched = true;
131                 break;
132             }
133         }
134         if(matched)
135             continue;
136         // Device not found, create new
137         Kb* kb = new Kb(this, line[0]);
138         if(!kb->isOpen()){
139             delete kb;
140             continue;
141         }
142         _devices\&.insert(kb);
143         // Load preferences and send signal
144         emit kbConnected(kb);
145         kb->load();
146         connect(_eventTimer, SIGNAL(timeout()), kb, SLOT(frameUpdate()));
147         connect(_scanTimer, SIGNAL(timeout()), kb, SLOT(autoSave()));
148     }
149 }
.fi
.SS "static QTimer* KbManager::scanTimer ()\fC [inline]\fP, \fC [static]\fP"

.PP
Definition at line 43 of file kbmanager\&.h\&.
.PP
References _kbManager, and _scanTimer\&.
.PP
Referenced by MainWindow::MainWindow()\&.
.PP
.nf
43 { return _kbManager ? _kbManager->_scanTimer : 0; }
.fi
.SS "void KbManager::stop ()\fC [static]\fP"

.PP
Definition at line 19 of file kbmanager\&.cpp\&.
.PP
References _kbManager\&.
.PP
Referenced by MainWindow::cleanup()\&.
.PP
.nf
19                     {
20     if(!_kbManager)
21         return;
22     delete _kbManager;
23     _kbManager = 0;
24 }
.fi
.SS "void KbManager::versionUpdated ()\fC [signal]\fP"

.PP
Definition at line 188 of file moc_kbmanager\&.cpp\&.
.PP
Referenced by scanKeyboards()\&.
.PP
.nf
189 {
190     QMetaObject::activate(this, &staticMetaObject, 2, Q_NULLPTR);
191 }
.fi
.SH "Field Documentation"
.PP 
.SS "QString KbManager::_daemonVersion = '<unavailable>'\fC [static]\fP, \fC [private]\fP"

.PP
Definition at line 59 of file kbmanager\&.h\&.
.PP
Referenced by ckbDaemonVersion(), ckbDaemonVersionF(), and scanKeyboards()\&.
.SS "QSet<\fBKb\fP*> KbManager::_devices\fC [private]\fP"

.PP
Definition at line 63 of file kbmanager\&.h\&.
.PP
Referenced by devices(), and scanKeyboards()\&.
.SS "QTimer* KbManager::_eventTimer\fC [private]\fP"

.PP
Definition at line 64 of file kbmanager\&.h\&.
.PP
Referenced by eventTimer(), KbManager(), and scanKeyboards()\&.
.SS "QString KbManager::_guiVersion\fC [static]\fP, \fC [private]\fP"

.PP
Definition at line 59 of file kbmanager\&.h\&.
.PP
Referenced by ckbGuiVersion(), ckbGuiVersionF(), and init()\&.
.SS "\fBKbManager\fP * KbManager::_kbManager = 0\fC [static]\fP, \fC [private]\fP"

.PP
Definition at line 58 of file kbmanager\&.h\&.
.PP
Referenced by devices(), eventTimer(), init(), kbManager(), scanTimer(), and stop()\&.
.SS "QTimer * KbManager::_scanTimer\fC [private]\fP"

.PP
Definition at line 64 of file kbmanager\&.h\&.
.PP
Referenced by KbManager(), scanKeyboards(), and scanTimer()\&.

.SH "Author"
.PP 
Generated automatically by Doxygen for ckb-next from the source code\&.
